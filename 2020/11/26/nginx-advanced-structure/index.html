<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon/favicon-16x16.png">
  <meta name="google-site-verification" content="xitt2fbphh1nTeWLiTWc0lCggHuxJ5heMcAzkHW2vno">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"cyun.tech","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.11.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"utterances","storage":true,"lazyload":false,"nav":null,"activeClass":"utterances"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":10,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Overviewnginx provides advanced data structure like array, list, queue, rb tree which are specific to nginx, like array, it can grow dynamically, but not support free element back to array, list actua">
<meta property="og:type" content="article">
<meta property="og:title" content="nginx_advanced_structure">
<meta property="og:url" content="http://cyun.tech/2020/11/26/nginx-advanced-structure/index.html">
<meta property="og:site_name" content="CYun">
<meta property="og:description" content="Overviewnginx provides advanced data structure like array, list, queue, rb tree which are specific to nginx, like array, it can grow dynamically, but not support free element back to array, list actua">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://cyun.tech/images/nginx/nginx_rb_tree.png">
<meta property="og:image" content="https://cyun.tech/images/nginx/ngx_hash_layout.png">
<meta property="article:published_time" content="2020-11-26T09:06:22.000Z">
<meta property="article:modified_time" content="2023-08-16T15:02:01.164Z">
<meta property="article:author" content="Jason">
<meta property="article:tag" content="nginx">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cyun.tech/images/nginx/nginx_rb_tree.png">


<link rel="canonical" href="http://cyun.tech/2020/11/26/nginx-advanced-structure/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://cyun.tech/2020/11/26/nginx-advanced-structure/","path":"2020/11/26/nginx-advanced-structure/","title":"nginx_advanced_structure"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>nginx_advanced_structure | CYun</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-148730544-1"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-148730544-1","only_pageview":false}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?a510d1f580c8231f8f867d14f42bb8ea"></script>




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">CYun</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Overview"><span class="nav-number">1.</span> <span class="nav-text">Overview</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#array"><span class="nav-number">1.1.</span> <span class="nav-text">array</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#list"><span class="nav-number">1.2.</span> <span class="nav-text">list</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#queue"><span class="nav-number">1.3.</span> <span class="nav-text">queue</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#rb-tree"><span class="nav-number">1.4.</span> <span class="nav-text">rb tree</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#hash"><span class="nav-number">1.5.</span> <span class="nav-text">hash</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Jason"
      src="/uploads/avatar.gif">
  <p class="site-author-name" itemprop="name">Jason</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">146</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">139</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">150</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/jason-cyun" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;jason-cyun" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:jason_lkm@163.com" title="E-Mail → mailto:jason_lkm@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://cyun.tech/2020/11/26/nginx-advanced-structure/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.gif">
      <meta itemprop="name" content="Jason">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CYun">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="nginx_advanced_structure | CYun">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          nginx_advanced_structure
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-11-26 17:06:22" itemprop="dateCreated datePublished" datetime="2020-11-26T17:06:22+08:00">2020-11-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-08-16 23:02:01" itemprop="dateModified" datetime="2023-08-16T23:02:01+08:00">2023-08-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/nginx/" itemprop="url" rel="index"><span itemprop="name">nginx</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/nginx/data-structure/" itemprop="url" rel="index"><span itemprop="name">data structure</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h1><p>nginx provides advanced data structure like array, list, queue, rb tree which are specific to nginx, like array, it can grow dynamically, but not support free element back to array, list actually is list of several arrays.</p>
<span id="more"></span>
<h2 id="array"><a href="#array" class="headerlink" title="array"></a>array</h2><p>array will increase dynamically if no more space for use. but it’s better to allocate enough element at initialization.<br>as when increase array size, move original data from old array to new array, so that new array has whole data, can iterate it to get all elements. but the new address may be not equal old(a-&gt;elts), <strong>the original array is not freed at all, because user still points to old part and access the element that get from old array as user has that pointer, new element is created from the new array</strong>.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">+-----+     +------+               +--------+    +---------+</span><br><span class="line">|     |     |      |               |        |    |         |</span><br><span class="line">|  e1 |     | e2   |               |  e3    |    |  e4     |</span><br><span class="line">+--+--+     +--+---+               +--------++   +------+--+</span><br><span class="line">   |           |                             |          |</span><br><span class="line">   |           |   +------+        +-------+ |          |</span><br><span class="line">   |           |   |      |        |       | |          |</span><br><span class="line">   |           +--&gt;+  12  |        |  12   | |          |</span><br><span class="line">   |               |      |        |       | |          |</span><br><span class="line">   |               +------+        +-------+ |          |</span><br><span class="line">   |               |      |        |       | |          |</span><br><span class="line">   +-------------&gt; |  13  |        |  13   | |          |</span><br><span class="line">                   +------+        |       | |          |</span><br><span class="line">                                   +-------+ |          |</span><br><span class="line">                                   |       | |          |</span><br><span class="line">                                   |  14   +&lt;+          |</span><br><span class="line">                                   |       |            |</span><br><span class="line">                                   +-------+            |</span><br><span class="line">                                   |       |            |</span><br><span class="line">                                   |  15   +&lt;-----------+</span><br><span class="line">                                   |       |</span><br><span class="line">                                   +-------+</span><br><span class="line"></span><br><span class="line">e1 and e2 still point to old array after double array</span><br><span class="line">e3 and e4 point to new array, but the first two elements still have the same info with old array</span><br></pre></td></tr></table></figure>

<p><strong>limitation</strong></p>
<ul>
<li>NOT support decrease array size</li>
<li><strong>NOT support free element back to array</strong></li>
<li><strong>Only support free the whole array</strong></li>
</ul>
<p><strong>data structure</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">void</span>        *elts;      <span class="comment">/* address of nalloc * size */</span></span><br><span class="line">    <span class="type">ngx_uint_t</span>   nelts;     <span class="comment">/* in use counter */</span></span><br><span class="line">    <span class="type">size_t</span>       size;      <span class="comment">/* size of the element */</span></span><br><span class="line">    <span class="type">ngx_uint_t</span>   nalloc;    <span class="comment">/* total elements can be used */</span></span><br><span class="line">    <span class="type">ngx_pool_t</span>  *pool;</span><br><span class="line">&#125; <span class="type">ngx_array_t</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>API</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* example to use: */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">ngx_int_t</span> id;</span><br><span class="line">&#125; <span class="type">my_element_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* initialization size: 4 my_element_t */</span></span><br><span class="line"><span class="type">ngx_array_t</span> *my_array = ngx_array_create(pool, <span class="number">4</span>, <span class="keyword">sizeof</span>(<span class="type">my_element_t</span>));</span><br><span class="line">my_node = ngx_array_push(my_array);</span><br><span class="line">my_node-&gt;id = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<h2 id="list"><a href="#list" class="headerlink" title="list"></a>list</h2><p>nginx list is a list of array(fixed size, nalloc * size) each list part is an array(fixed size), list stores the header part and last part.</p>
<p>when request an element from the list, it checks if the last array is used up or not, if not, gets it, otherwise creates a new array, get one element from it.</p>
<p><strong>Note</strong></p>
<ul>
<li>list is good for dynamic element size, but not good for free ops</li>
<li>The array in the list is used once only when it’s last<br>  later on even you free elements back to the array, if it’s not last anymore, never use it anymore.</li>
<li><strong>Never delete element of list as it’s dangerous as it related data movement</strong></li>
</ul>
<p><strong>data structure</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ngx_list_part_s</span> &#123;</span></span><br><span class="line">    <span class="type">void</span>             *elts;     <span class="comment">/* header of the continuos memory */</span></span><br><span class="line">    <span class="type">ngx_uint_t</span>        nelts;    <span class="comment">/* used counter of this part */</span></span><br><span class="line">    <span class="type">ngx_list_part_t</span>  *next;     <span class="comment">/* next part of the list */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">ngx_list_part_t</span>  *last;     <span class="comment">/* the last part */</span></span><br><span class="line">    <span class="type">ngx_list_part_t</span>   part;     <span class="comment">/* the first part */</span></span><br><span class="line">    <span class="type">size_t</span>            size;     <span class="comment">/* size of each element */</span></span><br><span class="line">    <span class="type">ngx_uint_t</span>        nalloc;   <span class="comment">/* a list can have several parts, each part can take nalloc continuous memory */</span></span><br><span class="line">    <span class="type">ngx_pool_t</span>       *pool;</span><br><span class="line">&#125; <span class="type">ngx_list_t</span>;</span><br></pre></td></tr></table></figure>

<p><strong>API</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">ngx_int_t</span> id;</span><br><span class="line">&#125; <span class="type">my_element_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 4 elements for each array in the list */</span></span><br><span class="line"><span class="type">ngx_list_t</span> *mylist = ngx_list_create(pool, <span class="number">4</span>, <span class="keyword">sizeof</span>(<span class="type">my_element_t</span>));</span><br><span class="line"><span class="type">my_element_t</span> *node = ngx_list_push(mylist);</span><br><span class="line">node-&gt;id = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* the iteration through the list: */</span></span><br><span class="line">part = &amp;mylist.part;</span><br><span class="line">data = part-&gt;elts;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span> ;; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (i &gt;= part-&gt;nelts) &#123;</span><br><span class="line">        <span class="keyword">if</span> (part-&gt;next == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        part = part-&gt;next;</span><br><span class="line">        data = part-&gt;elts;</span><br><span class="line">        i = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ...data[i] ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="queue"><a href="#queue" class="headerlink" title="queue"></a>queue</h2><p>ngx_queue_t is just for linking, data area must be allocated &#x2F;freed by user, ngx_queue is <strong>bidirectional list</strong>.</p>
<p><strong>it supports:</strong></p>
<ul>
<li>insert node at head&#x2F;tail</li>
<li>get head&#x2F;tail node</li>
<li>empty check</li>
<li>remove a node</li>
<li>get prev&#x2F;next node of the given one</li>
<li>sort</li>
<li>join&#x2F;split list</li>
</ul>
<p><strong>data structure</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ngx_queue_s</span> &#123;</span></span><br><span class="line">    <span class="type">ngx_queue_t</span>  *prev;</span><br><span class="line">    <span class="type">ngx_queue_t</span>  *next;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>API</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* example to use: */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">my_node</span> &#123;</span></span><br><span class="line">    <span class="type">ngx_queue_t</span> q_node;</span><br><span class="line">    xxx;</span><br><span class="line">    yyy;</span><br><span class="line">&#125; <span class="type">my_node_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">ngx_queue_t</span> head;</span><br><span class="line"><span class="type">my_node_t</span> node;</span><br><span class="line"></span><br><span class="line">ngx_queue_init(&amp;head)</span><br><span class="line">ngx_queue_insert_head(&amp;head, &amp;node.q_node)</span><br><span class="line"></span><br><span class="line">ngx_queue_empty(&amp;head);</span><br><span class="line">ngx_queue_head(&amp;head);</span><br><span class="line">ngx_queue_last(&amp;head);</span><br><span class="line">ngx_queue_remove(&amp;node);</span><br></pre></td></tr></table></figure>

<h2 id="rb-tree"><a href="#rb-tree" class="headerlink" title="rb tree"></a>rb tree</h2><p>red&#x2F;back tree is <strong>balanced binary search tree</strong>.</p>
<p><img src="https://cyun.tech/images/nginx/nginx_rb_tree.png" alt="nginx rb tree"></p>
<p><strong>balance:</strong></p>
<ul>
<li>when delete&#x2F;insert a node, the tree may be rotated to make the depth small,hence quick search</li>
</ul>
<p><strong>binary:</strong></p>
<ul>
<li>each node have at most two child left&#x2F;right</li>
</ul>
<p><strong>search:</strong></p>
<ul>
<li>the left node is smaller than its parent</li>
<li>the right node is large than it’s parent</li>
<li>as it’s sorted, so each node must have a key(integer)</li>
</ul>
<p><strong>Note</strong><br>By default, key must be unique, if insert a node with same key the previous one will be replaced, BUT you can define custom ‘insert’ method to overwrite the default, hence allow two nodes can have the same key in the tree.</p>
<p><strong>data structure</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ngx_rbtree_s</span> &#123;</span></span><br><span class="line">    <span class="comment">/* root can be change after insert or delete as it may rotate</span></span><br><span class="line"><span class="comment">    ngx_rbtree_node_t     *root;</span></span><br><span class="line"><span class="comment">    /* sentinel is a node with black color, if node has no left/right child, set</span></span><br><span class="line"><span class="comment">     * its left/right child with sentinel to meet rb tree required</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">ngx_rbtree_node_t</span>     *sentinel;</span><br><span class="line">    <span class="comment">/* &#x27;insert&#x27; method, how to insert a node in the tree</span></span><br><span class="line"><span class="comment">     * you can define your own to allow same key</span></span><br><span class="line"><span class="comment">     * actually nginx provides such way to us</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ngx_rbtree_insert_pt   insert;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="type">ngx_uint_t</span>  <span class="type">ngx_rbtree_key_t</span>;</span><br><span class="line"><span class="keyword">typedef</span> <span class="type">ngx_int_t</span>   <span class="type">ngx_rbtree_key_int_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ngx_rbtree_node_s</span> &#123;</span></span><br><span class="line">    <span class="type">ngx_rbtree_key_t</span>       key;</span><br><span class="line">    <span class="type">ngx_rbtree_node_t</span>     *left;</span><br><span class="line">    <span class="type">ngx_rbtree_node_t</span>     *right;</span><br><span class="line">    <span class="type">ngx_rbtree_node_t</span>     *parent;</span><br><span class="line">    u_char                 color;</span><br><span class="line">    u_char                 data;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>API</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* example to use */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">my_node</span> &#123;</span></span><br><span class="line">  xxx</span><br><span class="line">  <span class="type">ngx_rbtree_node_t</span> rb_node;</span><br><span class="line">&#125; <span class="type">my_node_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">my_node_t</span> node;</span><br><span class="line"><span class="type">ngx_rbtree_t</span> rbtree;</span><br><span class="line"><span class="type">ngx_rbtree_node_t</span> sentinel;</span><br><span class="line"></span><br><span class="line">ngx_rbtree_init(&amp;rbtree, &amp;sentinel, ngx_rbtree_insert_value);</span><br><span class="line"></span><br><span class="line">node.rb_node.key = <span class="number">1</span>;</span><br><span class="line">ngx_rbtree_insert(&amp;rbtree, &amp;node.rb_node);</span><br></pre></td></tr></table></figure>
<h2 id="hash"><a href="#hash" class="headerlink" title="hash"></a>hash</h2><p>Hash is for quick searching, elements are distributed at different buckets based on <code>hash_value % bucket_count</code>, inside each bucket, it’s an array, compared one by one, so for hash, the important are hash function and bucket counter to distribute element evenly to reduce conflict. nginx has built-in hash function and bucket count calculated by nginx itself.</p>
<p><img src="https://cyun.tech/images/nginx/ngx_hash_layout.png" alt="hash layout"></p>
<p><strong>data structure</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="comment">/* each element is &lt;key, value&gt; pair</span></span><br><span class="line"><span class="comment">     * key: name</span></span><br><span class="line"><span class="comment">     * value: any value</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">void</span>             *value;</span><br><span class="line">    <span class="comment">/* as you can see each element is not fixed!!</span></span><br><span class="line"><span class="comment">     * each element size = sizeof(void*) + sizeof(u_short) + 1 + len</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    u_short           len;</span><br><span class="line">    u_char            name[<span class="number">1</span>];</span><br><span class="line">&#125; <span class="type">ngx_hash_elt_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="comment">/* bucket address */</span></span><br><span class="line">    <span class="type">ngx_hash_elt_t</span>  **buckets;</span><br><span class="line">    <span class="comment">/* the bucket counts */</span></span><br><span class="line">    <span class="type">ngx_uint_t</span>        size;</span><br><span class="line">&#125; <span class="type">ngx_hash_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="comment">/* passed in parameter --&gt;converted to ngx_hash_elt_t */</span></span><br><span class="line">    <span class="type">ngx_str_t</span>         key;</span><br><span class="line">    <span class="type">ngx_uint_t</span>        key_hash;</span><br><span class="line">    <span class="type">void</span>             *value;</span><br><span class="line">&#125; <span class="type">ngx_hash_key_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Above are three must structures for hash */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">ngx_hash_t</span>        hash;</span><br><span class="line">    <span class="type">void</span>             *value;</span><br><span class="line">&#125; <span class="type">ngx_hash_wildcard_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ngx_hash_combined_t is not a must for hash, but a helper for nginx to use for some case</span></span><br><span class="line"><span class="comment"> * to create different hashes for different types, like this</span></span><br><span class="line"><span class="comment"> * server_name abc.com *.example.com test.com.*;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">ngx_hash_t</span>            hash;    <span class="comment">/* abc.com */</span></span><br><span class="line">    <span class="type">ngx_hash_wildcard_t</span>  *wc_head; <span class="comment">/* *.example.com */</span></span><br><span class="line">    <span class="type">ngx_hash_wildcard_t</span>  *wc_tail; <span class="comment">/* test.com.* */</span></span><br><span class="line">&#125; <span class="type">ngx_hash_combined_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">ngx_hash_t</span>       *hash;     <span class="comment">/* passed in if NULL, created inside init function */</span></span><br><span class="line">    ngx_hash_key_pt   key;</span><br><span class="line">    <span class="type">ngx_uint_t</span>        max_size; <span class="comment">/* max bucket count, how many buckets */</span></span><br><span class="line">                                <span class="comment">/* the real bucket count is calculated based on hash keys */</span></span><br><span class="line">    <span class="type">ngx_uint_t</span>        bucket_size; <span class="comment">/* how many bytes used by each bucket */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">char</span>             *name;</span><br><span class="line">    <span class="type">ngx_pool_t</span>       *pool;</span><br><span class="line">    <span class="type">ngx_pool_t</span>       *temp_pool; <span class="comment">/* used for wildcard hash_init to allocate memory for checking conflict */</span></span><br><span class="line">&#125; <span class="type">ngx_hash_init_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* helper structure to add keys to the keys_arrays</span></span><br><span class="line"><span class="comment"> * it supports key conflict checking</span></span><br><span class="line"><span class="comment"> * then pass each key array to hash_init</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">ngx_uint_t</span>        hsize; <span class="comment">/* bucket number */</span></span><br><span class="line">    <span class="type">ngx_pool_t</span>       *pool;</span><br><span class="line">    <span class="type">ngx_pool_t</span>       *temp_pool;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* key array of exact match like abc.com*/</span></span><br><span class="line">    <span class="type">ngx_array_t</span>       keys; <span class="comment">/* key array, each of ngx_hash_key_t */</span></span><br><span class="line">    <span class="type">ngx_array_t</span>      *keys_hash; <span class="comment">/* bucket array, each bucket is array of ngx_str_t temporary used for checking conflict when creating ngx_hash_key_t */</span></span><br><span class="line">   </span><br><span class="line">    <span class="comment">/* key array of wc_head like *.test.com */</span></span><br><span class="line">    <span class="type">ngx_array_t</span>       dns_wc_head;</span><br><span class="line">    <span class="type">ngx_array_t</span>      *dns_wc_head_hash;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* key array of wc_tail like abc.test.* */</span></span><br><span class="line">    <span class="type">ngx_array_t</span>       dns_wc_tail;</span><br><span class="line">    <span class="type">ngx_array_t</span>      *dns_wc_tail_hash;</span><br><span class="line">&#125; <span class="type">ngx_hash_keys_arrays_t</span>;</span><br></pre></td></tr></table></figure>

<p><strong>API</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* without helper function for hash keys */</span></span><br><span class="line"><span class="type">ngx_hash_init_t</span>  hash;</span><br><span class="line"><span class="type">ngx_array_t</span>      keys_array;</span><br><span class="line"><span class="type">ngx_hash_key_t</span>  *hk;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* add temporary hash key, no key conflicting check */</span></span><br><span class="line">ngx_array_init(&amp;keys_array, cf-&gt;temp_pool, <span class="number">32</span>, <span class="keyword">sizeof</span>(<span class="type">ngx_hash_key_t</span>));</span><br><span class="line">hk = ngx_array_push(&amp;keys_array);</span><br><span class="line">hk-&gt;key = <span class="string">&quot;test&quot;</span>;</span><br><span class="line">hk-&gt;key_hash = ngx_hash_key_lc(<span class="string">&quot;test&quot;</span>, <span class="number">4</span>);</span><br><span class="line">hk-&gt;value = XX; <span class="comment">//anything you want</span></span><br><span class="line"></span><br><span class="line">hash.hash = <span class="literal">NULL</span>;</span><br><span class="line">hash.key = ngx_hash_key_lc;</span><br><span class="line">hash.max_size = <span class="number">2048</span>;</span><br><span class="line">hash.bucket_size = <span class="number">64</span>;</span><br><span class="line">hash.name = <span class="string">&quot;test_hash&quot;</span>;</span><br><span class="line">hash.pool = cf-&gt;pool;</span><br><span class="line">hash.temp_pool = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* add hash keys to hash buckets */</span></span><br><span class="line">ngx_hash_init(&amp;hash, keys_array.elts, keys_array.nelts);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* finding */</span></span><br><span class="line"><span class="type">ngx_uint_t</span> hash_value;</span><br><span class="line">hash_value = ngx_hash_key_lc(<span class="string">&quot;test&quot;</span>, <span class="number">4</span>);</span><br><span class="line">ngx_hash_find(hash.hash, hash_value, <span class="string">&quot;test&quot;</span>, <span class="number">4</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// with helper function</span></span><br><span class="line"><span class="type">ngx_hash_init_t</span>  hash;</span><br><span class="line"><span class="type">ngx_hash_keys_arrays_t</span> keys_array;</span><br><span class="line"><span class="comment">// few keys</span></span><br><span class="line">ngx_hash_keys_array_init(&amp;keys_array, NGX_HASH_SMALL);</span><br><span class="line"></span><br><span class="line"><span class="comment">//add keys to helper array(wildard support and conflict checking!!!)</span></span><br><span class="line">ngx_hash_add_key(&amp;keys_array, <span class="string">&quot;test&quot;</span>, XXX, NGX_HASH_WILDCARD_KEY);</span><br><span class="line">ngx_hash_add_key(&amp;keys_array, <span class="string">&quot;*.test&quot;</span>, YYY, NGX_HASH_WILDCARD_KEY);</span><br><span class="line">ngx_hash_add_key(&amp;keys_array, <span class="string">&quot;test.*&quot;</span>, ZZZ, NGX_HASH_WILDCARD_KEY);</span><br><span class="line"></span><br><span class="line">hash.hash = <span class="literal">NULL</span>;</span><br><span class="line">hash.key = ngx_hash_key_lc;</span><br><span class="line">hash.max_size = <span class="number">2048</span>;</span><br><span class="line">hash.bucket_size = <span class="number">64</span>;</span><br><span class="line">hash.name = <span class="string">&quot;test_hash_helper&quot;</span>;</span><br><span class="line">hash.pool = cf-&gt;pool;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (keys_array.keys.nelts) &#123;</span><br><span class="line">    ngx_hash_init(&amp;hash, keys_array.keys.elts, keys_array.keys.nelts);</span><br><span class="line">    hash.temp_pool = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">ngx_hash_t</span> *hash_normal = hash.hash; <span class="comment">// save hash</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (keys_array.dns_wc_head.nelts) &#123;</span><br><span class="line">    ngx_qsort(keys_array.dns_wc_head.elts,</span><br><span class="line">              (<span class="type">size_t</span>) keys_array.dns_wc_head.nelts,</span><br><span class="line">              <span class="keyword">sizeof</span>(<span class="type">ngx_hash_key_t</span>), xx_compare_helper);</span><br><span class="line"></span><br><span class="line">    hash.temp_pool = XXX; <span class="comment">//must set</span></span><br><span class="line">    ngx_hash_wildcard_init(&amp;hash, keys_array.dns_wc_head.elts, keys_array.dns_wc_head.nelts);</span><br><span class="line">    <span class="type">ngx_hash_t</span> *hash_head = hash.hash; <span class="comment">//save</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (keys_array.dns_wc_tail.nelts) &#123;</span><br><span class="line">    ngx_qsort(keys_array.dns_wc_tail.elts,</span><br><span class="line">              (<span class="type">size_t</span>) keys_array.dns_wc_tail.nelts,</span><br><span class="line">              <span class="keyword">sizeof</span>(<span class="type">ngx_hash_key_t</span>), xx_compare_helper);</span><br><span class="line"></span><br><span class="line">    hash.temp_pool = XXX; <span class="comment">// must set</span></span><br><span class="line">    ngx_hash_wildcard_init(&amp;hash, keys_array.dns_wc_tail.elts, keys_array.dns_wc_tail.nelts);</span><br><span class="line">    <span class="type">ngx_hash_t</span> *hash_tail = hash.hash; <span class="comment">//save</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
    </div>

    
    
    
      


    <footer class="post-footer">
          <div class="reward-container">
  <div></div>
  <button>
    Donate
  </button>
  <div class="post-reward">
      <div>
        <img src="/images/wechatpay.jpeg" alt="Jason WeChat Pay">
        <span>WeChat Pay</span>
      </div>

  </div>
</div>

          <div class="post-tags">
              <a href="/tags/nginx/" rel="tag"># nginx</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2020/11/24/nginx-shared-memory-slab/" rel="prev" title="nginx_shared_memory_slab">
                  <i class="fa fa-chevron-left"></i> nginx_shared_memory_slab
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2020/12/01/nginx-virtual-server/" rel="next" title="nginx-virtual-server">
                  nginx-virtual-server <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments utterances-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2018 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Cyun All rights reserved</span>
</div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.0/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>



  <script src="/js/third-party/fancybox.js"></script>

  <script src="/js/third-party/pace.js"></script>

  




<script class="next-config" data-name="utterances" type="application/json">{"enable":true,"repo":"jason-bj/blog","issue_term":"pathname","theme":"github-light"}</script>
<script src="/js/third-party/comments/utterances.js"></script>

</body>
</html>
