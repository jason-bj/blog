<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon/favicon-16x16.png">
  <meta name="google-site-verification" content="xitt2fbphh1nTeWLiTWc0lCggHuxJ5heMcAzkHW2vno">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Microsoft+YaHei+UI:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"cyun.tech","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.11.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"utterances","storage":true,"lazyload":false,"nav":null,"activeClass":"utterances"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":10,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="IntroductionNamespaces provide processes with their own view of the system, limit what you can see(and therefore use)">
<meta property="og:type" content="article">
<meta property="og:title" content="docker-core-tech-ns">
<meta property="og:url" content="http://cyun.tech/2019/10/14/docker-core-tech-ns/index.html">
<meta property="og:site_name" content="CYun">
<meta property="og:description" content="IntroductionNamespaces provide processes with their own view of the system, limit what you can see(and therefore use)">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://8gwifi.org/docs/img/linux-namespace1.png">
<meta property="og:image" content="http://cyun.tech/images/docker/namespace-kview.jpg">
<meta property="article:published_time" content="2019-10-14T09:01:11.000Z">
<meta property="article:modified_time" content="2023-10-20T15:03:30.378Z">
<meta property="article:author" content="Jason">
<meta property="article:tag" content="namespace">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://8gwifi.org/docs/img/linux-namespace1.png">


<link rel="canonical" href="http://cyun.tech/2019/10/14/docker-core-tech-ns/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://cyun.tech/2019/10/14/docker-core-tech-ns/","path":"2019/10/14/docker-core-tech-ns/","title":"docker-core-tech-ns"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>docker-core-tech-ns | CYun</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-148730544-1"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-148730544-1","only_pageview":false}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?a510d1f580c8231f8f867d14f42bb8ea"></script>




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">CYun</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Introduction"><span class="nav-number">1.</span> <span class="nav-text">Introduction</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Overview"><span class="nav-number">1.1.</span> <span class="nav-text">Overview</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#mount-namespace"><span class="nav-number">1.2.</span> <span class="nav-text">mount namespace</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#kernel-view"><span class="nav-number">1.3.</span> <span class="nav-text">kernel view</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#FAQ"><span class="nav-number">1.4.</span> <span class="nav-text">FAQ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#how-to-create-different-namespaces"><span class="nav-number">1.4.1.</span> <span class="nav-text">how to create different namespaces</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#how-to-check-namespaces-of-given-process"><span class="nav-number">1.4.2.</span> <span class="nav-text">how to check namespaces of given process</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#how-to-communicate-between-network-namespaces"><span class="nav-number">1.4.3.</span> <span class="nav-text">how to communicate between network namespaces</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#how-to-check-if-device-is-netns-local-or-not"><span class="nav-number">1.4.4.</span> <span class="nav-text">how to check if device is netns local or not</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#how-to-check-mounted-point-of-the-system"><span class="nav-number">1.4.5.</span> <span class="nav-text">how to check mounted point of the system</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#how-to-run-a-program-in-another-namespace-from-shell"><span class="nav-number">1.4.6.</span> <span class="nav-text">how to run a program in another namespace from shell</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#network-namespace-command-list"><span class="nav-number">1.4.7.</span> <span class="nav-text">network namespace command list</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Jason"
      src="/uploads/avatar.gif">
  <p class="site-author-name" itemprop="name">Jason</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">150</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">143</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">149</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/jason-cyun" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;jason-cyun" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:jason_lkm@163.com" title="E-Mail → mailto:jason_lkm@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://cyun.tech/2019/10/14/docker-core-tech-ns/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.gif">
      <meta itemprop="name" content="Jason">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CYun">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="docker-core-tech-ns | CYun">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          docker-core-tech-ns
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2019-10-14 17:01:11" itemprop="dateCreated datePublished" datetime="2019-10-14T17:01:11+08:00">2019-10-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-10-20 23:03:30" itemprop="dateModified" datetime="2023-10-20T23:03:30+08:00">2023-10-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/docker/" itemprop="url" rel="index"><span itemprop="name">docker</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/docker/ns/" itemprop="url" rel="index"><span itemprop="name">ns</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>Namespaces provide processes with their own view of the system, limit what you can see(and therefore use)</p>
<span id="more"></span>

<h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><p><img src="https://8gwifi.org/docs/img/linux-namespace1.png" alt="Namespaces"></p>
<p>There are multiple namespaces(no cgroup namespace actually):</p>
<ul>
<li>pid<br>each PID namespace has it own numbering(start at 1), when PID 1 goes away, the whole namespace is killed. Even you run process in a PID namespace, root pid namespace still sees it, but the pid number is different in both namespaces, but others non-root pid namespace does NOT see it.</li>
<li>net<br>processes within a given network namespace get their own private network stack, including:<ul>
<li>network interfaces</li>
<li>routing tables</li>
<li>iptables rules</li>
<li>sockets(inet socket, <strong>NOT unix socket</strong>)<br><mark>network interface belongs to exactly one net namespace, same for (inet)socket, the newly create net namespace only contains a loopback, no others, when a network space is deleted, all its movable network devices are moved back to the default network namespace, while unmovable devices(device who have NETIF_F_NETNS_LOCAL in their features) and virtual devices are not moved to the default network namespace</mark></li>
</ul>
</li>
<li>mnt(mount)<br>processes can have ‘private’ mounts, mounts&#x2F;unmounts in that mount namespace are invisible to the rest of the system</li>
<li>uts<br>gethostname&#x2F;sethostname can be different at uts namespace, you can change hostname in this namespace, but not affect others(namespace)</li>
<li>ipc(rarely used)<br>Allow a process to have its own<ul>
<li>IPC semaphores</li>
<li>IPC message queues</li>
<li>IPC shared memory</li>
</ul>
</li>
<li>user<br>Allows to map UID&#x2F;GID(that means you can see mapped uid&#x2F;gid in user namespace, you can’t know the real pid&#x2F;gid in container with this mapping)<ul>
<li>UID 0-1999 in container C1 is mapped to UID 10000-11999 on host(security improvement)</li>
</ul>
</li>
</ul>
<h2 id="mount-namespace"><a href="#mount-namespace" class="headerlink" title="mount namespace"></a>mount namespace</h2><p>Mount namespace provides isolation of the list of mounts seen by the processes in each namespace instance.  Thus, the processes in each of the mount namespace instances will see distinct single-directory hierarchies.</p>
<p>A new mount namespace is created using either clone(2) or unshare(2) with the CLONE_NEWNS flag.  When a new mount namespace is created, its mount list is <code>initialized as follows:</code></p>
<ul>
<li>If the namespace is created using clone(2), the mount list of the child’s namespace is a copy of the mount list in the parent process’s mount namespace.</li>
<li>If the namespace is created using unshare(2), the mount list of the new namespace is a copy of the mount list in the caller’s previous mount namespace.</li>
</ul>
<p>Subsequent modifications to the mount list (mount(2) and umount(2)) in either mount namespace will not (if MS_PRIVATE is used[default]) affect the mount list seen in the other namespace, this is controlled by propagation types.</p>
<p><strong>propagation types</strong></p>
<ul>
<li><p>MS_SHARED<br>This mount shares events with members of a peer group(parent process). Mount and unmount events immediately under this mount will propagate to the other mounts that are members of the peer group.  Propagation here means that the same mount or unmount will automatically occur under all of the other mounts in the peer group.  Conversely, mount and unmount events that take place under peer mounts will propagate to this mount.</p>
</li>
<li><p>MS_PRIVATE(default)<br>This mount is private; it does not have a peer group. Mount and unmount events do not propagate into or out of this mount.</p>
</li>
<li><p>MS_SLAVE<br>Mount and unmount events propagate into this mount from a (master) shared peer group.  Mount and unmount events under this mount do not propagate to any peer.</p>
</li>
</ul>
<p>Note that a mount can be the slave of another peer group while at the same time sharing mount and unmount events with a peer group of which it is a member.  (More precisely, <code>one peer group can be the slave of another peergroup</code>.)</p>
<ul>
<li>MS_UNBINDABLE<br>This is like a private mount, and in addition this mount can’t be bind mounted.  Attempts to bind mount this mount (mount(2) with the MS_BIND flag) will fail.</li>
</ul>
<p>When a recursive bind mount (mount(2) with the MS_BIND and MS_REC flags) is performed on a directory subtree, any bind mounts within the subtree are automatically pruned<br>(i.e., not replicated) when replicating that subtree to produce the target subtree.</p>
<h2 id="kernel-view"><a href="#kernel-view" class="headerlink" title="kernel view"></a>kernel view</h2><p>each namespace is identified by an inode(unique), if two processes are in the same namespace if they see the same inode for equivalent namespace types.</p>
<p><img src="/images/docker/namespace-kview.jpg" alt="namespace in kernel"></p>
<h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h2><h3 id="how-to-create-different-namespaces"><a href="#how-to-create-different-namespaces" class="headerlink" title="how to create different namespaces"></a>how to create different namespaces</h3><ul>
<li>namespaces are created with the <strong>clone()</strong> system call(with extra flags when creating a new process), <strong>when the last process of a namespace exits, it’s destroyed automatically by kernel(but can be preserved)</strong></li>
<li>process can ‘join’ a namespace by <strong>setns()</strong></li>
</ul>
<p><strong>clone flags for namespace</strong></p>
<ul>
<li>CLONE_NEWNS</li>
<li>CLONE_NEWNET</li>
<li>CLONE_NEWPID</li>
<li>CLONE_NEWIPC</li>
<li>CLONE_NEWUTS</li>
<li>CLONE_NEWUSER</li>
</ul>
<p><mark>All needs CAP_SYS_ADMIN except CLONE_NEWUSER</mark></p>
<h3 id="how-to-check-namespaces-of-given-process"><a href="#how-to-check-namespaces-of-given-process" class="headerlink" title="how to check namespaces of given process"></a>how to check namespaces of given process</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">ls</span> -al /proc/<span class="variable">$pid</span>/ns</span><br><span class="line">dr-x--x--x 2 root root 0 Oct 25 16:24 .</span><br><span class="line">dr-xr-xr-x 9 root root 0 Oct 11 22:15 ..</span><br><span class="line">lrwxrwxrwx 1 root root 0 Oct 25 16:24 ipc -&gt; ipc:[4026531839]</span><br><span class="line">lrwxrwxrwx 1 root root 0 Oct 25 16:24 mnt -&gt; mnt:[4026531840]</span><br><span class="line">lrwxrwxrwx 1 root root 0 Oct 25 16:24 net -&gt; net:[4026531956]</span><br><span class="line">lrwxrwxrwx 1 root root 0 Oct 25 16:24 pid -&gt; pid:[4026531836]</span><br><span class="line">lrwxrwxrwx 1 root root 0 Oct 25 16:24 user -&gt; user:[4026531837]</span><br><span class="line">lrwxrwxrwx 1 root root 0 Oct 25 16:24 uts -&gt; uts:[4026531838]</span><br></pre></td></tr></table></figure>

<h3 id="how-to-communicate-between-network-namespaces"><a href="#how-to-communicate-between-network-namespaces" class="headerlink" title="how to communicate between network namespaces"></a>how to communicate between network namespaces</h3><p><strong>use veth pair or unix socket</strong></p>
<h3 id="how-to-check-if-device-is-netns-local-or-not"><a href="#how-to-check-if-device-is-netns-local-or-not" class="headerlink" title="how to check if device is netns local or not"></a>how to check if device is netns local or not</h3><p>if device with NETIF_F_NETNS_LOCAL, it’s not allowed to move between network namespace; example of this device</p>
<ul>
<li>loopback, vxlan, pp, bridge</li>
<li>use <strong>ethtool</strong> to check if device is set or not.</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ ethtool -k eth0 | grep <span class="built_in">local</span></span><br><span class="line">netns-local: off [fixed]</span><br><span class="line"></span><br><span class="line">$ ethtool -k lo | grep <span class="built_in">local</span></span><br><span class="line">netns-local: on [fixed]</span><br></pre></td></tr></table></figure>
<h3 id="how-to-check-mounted-point-of-the-system"><a href="#how-to-check-mounted-point-of-the-system" class="headerlink" title="how to check mounted point of the system"></a>how to check mounted point of the system</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># this is the real mounts from kernel</span></span><br><span class="line">$ <span class="built_in">cat</span> /proc/mounts</span><br><span class="line"></span><br><span class="line"><span class="comment"># it just read file from /etc/mtab</span></span><br><span class="line">$ mount</span><br></pre></td></tr></table></figure>
<h3 id="how-to-run-a-program-in-another-namespace-from-shell"><a href="#how-to-run-a-program-in-another-namespace-from-shell" class="headerlink" title="how to run a program in another namespace from shell"></a>how to run a program in another namespace from shell</h3><p>There are two commands for this.</p>
<ul>
<li><code>unshare</code> to run command in <code>new namespace or existing namespace</code></li>
<li><code>nsenter</code> to run command in <code>another process&#39;s namespace[existing namespace]</code></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">unshare [options] &lt;program&gt; [&lt;argument&gt;...]</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line"> -m, --mount[=&lt;file&gt;]      unshare mounts namespace</span><br><span class="line"> -u, --uts[=&lt;file&gt;]        unshare UTS namespace (hostname etc)</span><br><span class="line"> -i, --ipc[=&lt;file&gt;]        unshare System V IPC namespace</span><br><span class="line"> -n, --net[=&lt;file&gt;]        unshare network namespace</span><br><span class="line"> -p, --pid[=&lt;file&gt;]        unshare pid namespace</span><br><span class="line"> -U, --user[=&lt;file&gt;]       unshare user namespace</span><br><span class="line"> -f, --fork                fork before launching &lt;program&gt;</span><br><span class="line">     --mount-proc[=&lt;<span class="built_in">dir</span>&gt;]  mount proc filesystem first (implies --mount)</span><br><span class="line"> -r, --map-root-user       map current user to root (implies --user)</span><br><span class="line">     --propagation slave|shared|private|unchanged</span><br><span class="line">                           modify mount propagation <span class="keyword">in</span> mount namespace</span><br><span class="line"> -s, --setgroups allow|deny  control the setgroups syscall <span class="keyword">in</span> user namespaces</span><br><span class="line"></span><br><span class="line"><span class="comment"># without namespace option provided, it uses the same as its parent!!!</span></span><br><span class="line"><span class="comment"># PRIVATE mount namespace</span></span><br><span class="line"><span class="comment"># after copied mount list from parent, they will never affect each other</span></span><br><span class="line">$ unshare -m /bin/bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># shared mount namespace</span></span><br><span class="line"><span class="comment"># after copied mount list from parent, they will always affect each other</span></span><br><span class="line"><span class="comment"># mount on one, will also mount automatically on peer!!!</span></span><br><span class="line">$ unshare --propagation shared -m /bin/bash</span><br></pre></td></tr></table></figure>
<h3 id="network-namespace-command-list"><a href="#network-namespace-command-list" class="headerlink" title="network namespace command list"></a>network namespace command list</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># show all net ns</span></span><br><span class="line">$ ip netns list</span><br><span class="line"></span><br><span class="line"><span class="comment"># create netns</span></span><br><span class="line">$ ip netns add ns1</span><br><span class="line">$ <span class="built_in">ls</span> /var/run/netns</span><br><span class="line"></span><br><span class="line"><span class="comment"># move eth0 to ns1 if it&#x27;s movable</span></span><br><span class="line">$ ip <span class="built_in">link</span> <span class="built_in">set</span> dev eth0 netns ns1</span><br><span class="line"></span><br><span class="line"><span class="comment"># run command in netns</span></span><br><span class="line">$ ip netns <span class="built_in">exec</span> ns1 bash</span><br><span class="line"><span class="comment"># then</span></span><br><span class="line">$ ifconfig -a</span><br><span class="line"></span><br><span class="line"><span class="comment"># show all processes joined a netns</span></span><br><span class="line">$ ip netns pids ns1</span><br><span class="line"></span><br><span class="line"><span class="comment"># check which netns a process belongs to</span></span><br><span class="line">$ ip netns identify <span class="variable">$pid</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># delete a namespace</span></span><br><span class="line">$ ip netns delete ns1</span><br><span class="line"></span><br><span class="line"><span class="comment"># how two netns communicate(ping with each other or send() packet through socket)</span></span><br><span class="line"><span class="comment"># use veth pair, two virtual net devices(like a pipe), put them at different netns.</span></span><br><span class="line">$ ip <span class="built_in">link</span> add name v1 <span class="built_in">type</span> veth peer name v1_peer</span><br><span class="line"></span><br><span class="line"><span class="comment"># check veth pair</span></span><br><span class="line">$ ip -d <span class="built_in">link</span> show v1</span><br><span class="line">443: v1@v1_peer: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 76:01:28:8f:09:4f brd ff:ff:ff:ff:ff:ff promiscuity 0 </span><br><span class="line">--&gt;  veth addrgenmode eui64 numtxqueues 1 numrxqueues 1 gso_max_size 65536 gso_max_segs 65535 </span><br><span class="line"></span><br><span class="line">$ ip -d <span class="built_in">link</span> show v1_peer</span><br><span class="line">442: v1_peer@v1: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether aa:12:<span class="built_in">df</span>:8a:ce:4c brd ff:ff:ff:ff:ff:ff promiscuity 0 </span><br><span class="line">--&gt;  veth addrgenmode eui64 numtxqueues 1 numrxqueues 1 gso_max_size 65536 gso_max_segs 65535 </span><br><span class="line"></span><br><span class="line"><span class="comment"># @v1 means its peer name, veth means veth pair</span></span><br><span class="line"></span><br><span class="line">$ ip <span class="built_in">link</span> <span class="built_in">set</span> dev v1 netns ns1</span><br><span class="line">$ ip <span class="built_in">link</span> <span class="built_in">set</span> dev v1_peer netns ns2</span><br><span class="line">$ ip netns <span class="built_in">exec</span> ns1 ifconfig v1 192.168.1.1/24 up</span><br><span class="line">$ ip netns <span class="built_in">exec</span> ns2 ifconfig v1_peer 192.168.1.2/24 up</span><br><span class="line"></span><br><span class="line"><span class="comment"># now the two netns can ping each other</span></span><br><span class="line">$ ip netns <span class="built_in">exec</span> ns1 bash</span><br><span class="line">$ ping 192.168.1.2</span><br><span class="line"></span><br><span class="line"><span class="comment"># how process runs in a netns communicates with internet.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># One way:</span></span><br><span class="line"><span class="comment"># 1. move a physical ethx into that namespace</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># The other(mostly used)</span></span><br><span class="line"><span class="comment"># create a tunnel(veth pairs)between the netns and default ns, then create a bridge that contains a physical interface and one end of the tunnel that in root netns, the other side is in netns.</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># create bridge and add a physical device to it</span></span><br><span class="line"></span><br><span class="line">$ sudo brctl addbr br0</span><br><span class="line">$ ifconfig eth0 0.0.0.0</span><br><span class="line">$ sudo brctl addif br0 eth0</span><br><span class="line">$ ifconfig br0 up</span><br><span class="line">$ dhclient br0</span><br><span class="line"></span><br><span class="line"><span class="comment"># add veth paris and add one end to the bridge</span></span><br><span class="line">$ sudo ip <span class="built_in">link</span> add name veth1 <span class="built_in">type</span> veth peer name veth1_peer</span><br><span class="line">$ sudo ifconfig veth1 up</span><br><span class="line">$ sudo brctl addif br0 veth1</span><br><span class="line"></span><br><span class="line"><span class="comment"># add peer to netns and get ip from bridge</span></span><br><span class="line">$ sudo ip <span class="built_in">link</span> <span class="built_in">set</span> dev veth1_peer netns ns1</span><br><span class="line">$ sudo ip netns <span class="built_in">exec</span> ns1 bash</span><br><span class="line">$ dhclient veth1_peer (inside netns)</span><br></pre></td></tr></table></figure>
    </div>

    
    
    
      


    <footer class="post-footer">
          <div class="reward-container">
  <div></div>
  <button>
    Donate
  </button>
  <div class="post-reward">
      <div>
        <img src="/images/wechatpay.jpeg" alt="Jason WeChat Pay">
        <span>WeChat Pay</span>
      </div>

  </div>
</div>

          <div class="post-tags">
              <a href="/tags/namespace/" rel="tag"># namespace</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2019/10/14/docker-core-tech-cgroups/" rel="prev" title="docker-core-tech-cgroups">
                  <i class="fa fa-chevron-left"></i> docker-core-tech-cgroups
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2019/10/14/docker-network/" rel="next" title="docker-network">
                  docker-network <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments utterances-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2018 – 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Cyun All rights reserved</span>
</div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.0/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>



  <script src="/js/third-party/fancybox.js"></script>

  <script src="/js/third-party/pace.js"></script>

  




<script class="next-config" data-name="utterances" type="application/json">{"enable":true,"repo":"jason-bj/blog","issue_term":"pathname","theme":"github-light"}</script>
<script src="/js/third-party/comments/utterances.js"></script>

</body>
</html>
