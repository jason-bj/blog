<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon/favicon-16x16.png">
  <meta name="google-site-verification" content="xitt2fbphh1nTeWLiTWc0lCggHuxJ5heMcAzkHW2vno">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Microsoft+YaHei+UI:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"cyun.tech","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.11.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"utterances","storage":true,"lazyload":false,"nav":null,"activeClass":"utterances"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.json","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":-1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Overviewwhy need intial ram diskMany Linux distributions ship a single, generic Linux kernel image – one that the distribution’s developers create specifically to boot on a wide variety of hardware. T">
<meta property="og:type" content="article">
<meta property="og:title" content="linux-kernel-boot">
<meta property="og:url" content="http://cyun.tech/2021/11/10/linux-kernel-boot/index.html">
<meta property="og:site_name" content="CYun">
<meta property="og:description" content="Overviewwhy need intial ram diskMany Linux distributions ship a single, generic Linux kernel image – one that the distribution’s developers create specifically to boot on a wide variety of hardware. T">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2021-11-10T00:55:27.000Z">
<meta property="article:modified_time" content="2023-08-16T15:02:01.159Z">
<meta property="article:author" content="Jason">
<meta property="article:tag" content="linux">
<meta property="article:tag" content="initramfs">
<meta property="article:tag" content="tmpfs">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://cyun.tech/2021/11/10/linux-kernel-boot/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://cyun.tech/2021/11/10/linux-kernel-boot/","path":"2021/11/10/linux-kernel-boot/","title":"linux-kernel-boot"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>linux-kernel-boot | CYun</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-148730544-1"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-148730544-1","only_pageview":false}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?a510d1f580c8231f8f867d14f42bb8ea"></script>




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">CYun</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Overview"><span class="nav-number">1.</span> <span class="nav-text">Overview</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#initrd-and-initramfs"><span class="nav-number">1.1.</span> <span class="nav-text">initrd and initramfs</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#create-initramfs"><span class="nav-number">1.2.</span> <span class="nav-text">create initramfs</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#boot-with-disk-x2F-diskless"><span class="nav-number">1.3.</span> <span class="nav-text">boot with disk&#x2F;diskless</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ramfs-vs-tmpfs"><span class="nav-number">2.</span> <span class="nav-text">ramfs vs tmpfs</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ram-disk-ramfs"><span class="nav-number">2.1.</span> <span class="nav-text">ram disk(ramfs)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ram-disk-tmpfs"><span class="nav-number">2.2.</span> <span class="nav-text">ram disk(tmpfs)</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#REF"><span class="nav-number">3.</span> <span class="nav-text">REF</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Jason"
      src="/uploads/avatar.gif">
  <p class="site-author-name" itemprop="name">Jason</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">150</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">143</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">149</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/jason-cyun" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;jason-cyun" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:jason_lkm@163.com" title="E-Mail → mailto:jason_lkm@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://cyun.tech/2021/11/10/linux-kernel-boot/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.gif">
      <meta itemprop="name" content="Jason">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CYun">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="linux-kernel-boot | CYun">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          linux-kernel-boot
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-11-10 08:55:27" itemprop="dateCreated datePublished" datetime="2021-11-10T08:55:27+08:00">2021-11-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-08-16 23:02:01" itemprop="dateModified" datetime="2023-08-16T23:02:01+08:00">2023-08-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/linux/" itemprop="url" rel="index"><span itemprop="name">linux</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/linux/initramfs/" itemprop="url" rel="index"><span itemprop="name">initramfs</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h1><p><strong>why need intial ram disk</strong><br>Many Linux distributions ship a single, generic Linux kernel image – one that the distribution’s developers create specifically to boot on a wide variety of hardware. The device drivers for this generic kernel image are included as loadable kernel modules because <code>statically compiling many drivers into one kernel causes the kernel image to be much larger</code>, in some cases to cause boot-time crashes or other problems due to probing for inexistent or conflicting hardware. This <code>static-compiled kernel approach also leaves modules in kernel memory which are no longer used or needed</code>, and raises the <code>problem of detecting and loading the modules necessary to mount the root file system at boot time, or for that matter, deducing where or what the root file system is</code>.</p>
<p>To avoid having to hardcode handling for so many special cases into the kernel, an initial boot stage with a temporary root file-system(ram disk with temporary root fs) is used. This temporary root file-system can contain user-space helpers which do the hardware detection, module loading and device discovery necessary to get the real root file-system mounted</p>
<p>initial ramdisk is for <code>loading a temporary root file system into memory</code>, to be used as part of the Linux startup process. <code>initrd</code> and <code>initramfs</code> refer to <code>two different methods of achieving this</code>. Both are commonly used to make preparations before the real root file system can be mounted, if no real root file system is proivdes, the initial ramdisk is used for root file system which is in memory.</p>
<p>The bootloader will load the kernel and initial root file system image into memory and then start the kernel, passing in the memory address of the image. At the end of its boot sequence, the kernel tries to determine <code>the format of the image from its first few blocks of data</code>, which can lead either to the <code>initrd or initramfs scheme</code>. <span id="more"></span></p>
<!--more-->
<p><strong>initial root file system image format schema</strong>  </p>
<ul>
<li><p><code>initrd scheme</code>: the image may be a file system image (optionally compressed), which is made available in a special block device (&#x2F;dev&#x2F;ram) that is then mounted as the initial root file system during boots, The driver for that file system must be compiled statically into the kernel. Many distributions originally used compressed ext2 file system images. Once the initial root file system is up, the <code>kernel executes /linuxrc as its first process</code>; when it exits, the kernel assumes that the real root file system has been mounted and executes &#x2F;sbin&#x2F;init to begin the normal user-space boot process.</p>
<ul>
<li><code>A ramdev block device is created</code>(default fixed size 16M). It is a ram-based block device, that is a simulated hard disk that uses memory instead of physical disks.</li>
<li>The <code>initrd file is read and unzipped into the device</code>, as if you did zcat initrd | dd of&#x3D;&#x2F;dev&#x2F;ram0 or something similar.</li>
<li>The initrd contains an image of a filesystem, so now you can mount the filesystem as usual: <code>mount /dev/ram0 /root</code>. Naturally, filesystems need a driver, so if you use ext2, the ext2 driver has to be compiled in-kernel.</li>
<li><code>exec /linuxrc</code> as first process which mount real root file system, then call &#x2F;sbin&#x2F;init to begin user-space boot process.</li>
</ul>
</li>
<li><p><code>initramfs scheme</code>: (available since the Linux kernel 2.6.13), the image may be a cpio archive (optionally compressed). The archive is unpacked by the kernel into a special instance of a tmpfs that becomes the initial root file system. This scheme has the advantage of not requiring an intermediate file system or block drivers to be compiled into the kernel. In the initramfs scheme, the <code>kernel executes /init as its first process</code> that is not expected to exit. </p>
<ul>
<li>A tmpfs is mounted: <code>mount -t tmpfs nodev /root</code>. The tmpfs doesn’t need a driver, it is always on-kernel. No device needed, no additional drivers.</li>
<li>The <code>initramfs is uncompressed directly into this new filesystem</code>: zcat initramfs | cpio -i, or similar.</li>
<li><code>exec /init</code> never exit</li>
</ul>
</li>
</ul>
<h2 id="initrd-and-initramfs"><a href="#initrd-and-initramfs" class="headerlink" title="initrd and initramfs"></a>initrd and initramfs</h2><p><strong>initrd schema</strong>  </p>
<ul>
<li>initrd is for Linux kernels 2.4 and lower.</li>
<li>Initrd requires at least one file system driver be compiled into the kernel</li>
<li>A disk created by Initrd has got to have a fixed size</li>
<li>All of the reads&#x2F;writes on Initrd are buffered redundantly (unnecessarily) into main memory</li>
</ul>
<p>So, initrd is deprecated and is replaced by initramfs.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># inspect initrd image(it&#x27;s disk)</span></span><br><span class="line">$ gunzip initrd.gz</span><br><span class="line">$ file -L initrd</span><br><span class="line">initrd: Linux rev 1.0 ext2 filesystem data (mounted or unclean), UUID=6d512aa6-269e-4932-ba2b-83d953559340</span><br><span class="line"></span><br><span class="line">$ mount ‑t ext2 ‑o loop initrd /mnt/initrd</span><br><span class="line">$ <span class="built_in">ls</span> /mnt/initrd</span><br><span class="line">bin  cleanup  dev  drivers.lzm  etc  lib  liblinuxlive  linuxrc  mnt  proc  sbin  sys  tmp  usr  usr.lzm  var</span><br></pre></td></tr></table></figure>

<p><strong>initramfs schema</strong>  </p>
<ul>
<li>initramfs is a Linux 2.6 and above.</li>
<li>This feature is made up from a cpio archive of files that enables an initial root filesystem and init program to reside in kernel memory cache, rather than on a ramdisk, as with initrd filesystems.</li>
<li>with initramfs, you create an archive with the files which the kernel extracts to a tmpfs.</li>
<li>intramfs can increase boot-time flexibility, memory efficiency, and simplicity</li>
<li>dracut is the tool used to create the initramfs image.</li>
<li>initramfs location of init : &#x2F;init</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># inspect initramfs(it&#x27;s just root file system)</span></span><br><span class="line">$ file -L initramfs-3.10.0-1160.el7.x86_64.img</span><br><span class="line">initramfs-3.10.0-1160.el7.x86_64.img: gzip compressed data, from Unix, last modified: Wed Sep 29 18:29:57 2021, max compression</span><br><span class="line"></span><br><span class="line">$ zcat initramfs-3.10.0-1160.el7.x86_64.img | cpio -idmv</span><br></pre></td></tr></table></figure>
<h2 id="create-initramfs"><a href="#create-initramfs" class="headerlink" title="create initramfs"></a>create initramfs</h2><p>Actually, initramfs is created when you build kernel, you can also create initramfs with other tools without build your kernel.<br>When we first boot, we need at least some tools to start working. This includes the init process and some tools like ls, mount, mv, etc. To get those user space tools you can use BusyBox. <code>BusyBox</code> has many useful commands available for just 1.1MB, it’s a binary that support many command</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># use busybox</span></span><br><span class="line">$ busybox <span class="built_in">ls</span></span><br><span class="line">$ busybox <span class="built_in">df</span></span><br></pre></td></tr></table></figure>

<p><strong>create_initramfs.sh</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">ARCH=<span class="string">&quot;x86_64&quot;</span></span><br><span class="line">BB_VER=<span class="string">&quot;1.31.0&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Dirs</span></span><br><span class="line"><span class="built_in">mkdir</span> -p root</span><br><span class="line"><span class="built_in">cd</span> root</span><br><span class="line"><span class="built_in">mkdir</span> -p bin dev etc lib mnt proc sbin sys tmp var</span><br><span class="line"><span class="built_in">cd</span> -</span><br><span class="line"></span><br><span class="line"><span class="comment"># Utils</span></span><br><span class="line"><span class="keyword">if</span> [ ! -f <span class="string">&quot;root/bin/busybox&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    curl -L <span class="string">&quot;https://www.busybox.net/downloads/binaries/<span class="variable">$&#123;BB_VER&#125;</span>-defconfig-multiarch-musl/busybox-<span class="variable">$&#123;ARCH&#125;</span>&quot;</span> &gt;root/bin/busybox</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">cd</span> root/bin</span><br><span class="line"><span class="built_in">chmod</span> +x busybox</span><br><span class="line"><span class="comment"># as this two may be called before init process, hence link it</span></span><br><span class="line"><span class="built_in">ln</span> -s busybox mount</span><br><span class="line"><span class="built_in">ln</span> -s busybox sh</span><br><span class="line"><span class="built_in">cd</span> -</span><br><span class="line"></span><br><span class="line"><span class="comment"># Init process</span></span><br><span class="line"><span class="comment"># init process create soft link at /bin for all commands that busybox support </span></span><br><span class="line"><span class="built_in">cat</span> &gt;&gt;root/init &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">#!/bin/busybox sh</span></span><br><span class="line"><span class="string">/bin/busybox --install -s /bin</span></span><br><span class="line"><span class="string">mount -t devtmpfs  devtmpfs  /dev</span></span><br><span class="line"><span class="string">mount -t proc      proc      /proc</span></span><br><span class="line"><span class="string">mount -t sysfs     sysfs     /sys</span></span><br><span class="line"><span class="string">mount -t tmpfs     tmpfs     /tmp</span></span><br><span class="line"><span class="string">setsid cttyhack sh</span></span><br><span class="line"><span class="string">exec /bin/sh</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="built_in">chmod</span> +x root/init</span><br><span class="line"></span><br><span class="line"><span class="comment"># initramfs creation</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> root</span><br><span class="line">find . | cpio -ov --format=newc | gzip -9 &gt;../initramfs</span><br><span class="line"><span class="built_in">cd</span> -</span><br></pre></td></tr></table></figure>

<h2 id="boot-with-disk-x2F-diskless"><a href="#boot-with-disk-x2F-diskless" class="headerlink" title="boot with disk&#x2F;diskless"></a>boot with disk&#x2F;diskless</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># root filesystem is in an ext2 &quot;hard disk&quot;</span></span><br><span class="line">$ qemu-system-x86_64 -kernel normal/bzImage -drive file=rootfs.ext2</span><br><span class="line"></span><br><span class="line"><span class="comment"># root filesystem is in initramfs</span></span><br><span class="line">$ qemu-system-x86_64 -kernel normal/bzImage -initrd initramfs.img</span><br><span class="line"><span class="comment"># full command to run</span></span><br><span class="line">$ qemu-system-x86_64  -kernel normal/bzImage -initrd initramfs.img -nographic -append <span class="string">&quot;console=ttyS0&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># root filesystem is built in kernel</span></span><br><span class="line">$ qemu-system-x86_64 -kernel with_initramfs/bzImage</span><br><span class="line"><span class="comment"># Neither -drive nor -initrd are given.</span></span><br><span class="line"><span class="comment"># with_initramfs/bzImage is a kernel compiled with options identical to normal/bzImage, except for one: CONFIG_INITRAMFS_SOURCE=initramfs.img pointing to the exact same CPIO as from the -initrd example.</span></span><br></pre></td></tr></table></figure>

<h1 id="ramfs-vs-tmpfs"><a href="#ramfs-vs-tmpfs" class="headerlink" title="ramfs vs tmpfs"></a>ramfs vs tmpfs</h1><p><code>A ramdisk</code> is a volatile storage space defined in the RAM memory. all information stored in it will<code> be lost if the device is umounted or  system reboots.</code></p>
<p>In Linux, ramdisks can be <code>created using the command mount and the filesystems tmpfs and ramfs</code></p>
<ul>
<li><p>Tmpfs: Tmpfs is a temporary file system stored <code>in the RAM memory (and/or swap memory)</code>. By specifying this file system with the argument -t of the command mount, you can assign <code>limited memory resources to a temporary file system</code>.</p>
<ul>
<li>stored in ram and swap memory</li>
<li>ensure a limit</li>
<li>adjusted on the fly via ‘mount -o remount …’</li>
<li>Normal users can be allowed write access to tmpfs mounts!</li>
</ul>
</li>
<li><p>Ramfs: Ramfs is similar to Tmpfs, it uses ram memory only and the user <code>can’t ensure a limit</code>, and the allocated resource grows dynamically. If the user doesn’t control the ramfs consumption, ramfs will keep using all the memory until hanging or crashing the system</p>
<ul>
<li>stored in ram only</li>
<li>can not ensure a limit, but traditonal ram disk (&#x2F;dev&#x2F;ramX) has fixed size, default is 16M</li>
<li>cant adjust size on the fly for &#x2F;dev&#x2F;ramX, you need to reboot system or reload kernel module brd.</li>
<li>only root use can access ramfs mounts!</li>
</ul>
</li>
</ul>
<h2 id="ram-disk-ramfs"><a href="#ram-disk-ramfs" class="headerlink" title="ram disk(ramfs)"></a>ram disk(ramfs)</h2><p>As mentioned above, they are two ways to create ram disk, one is using ramfs, the other is using tmpfs.  </p>
<ul>
<li>enable traditional ram disk<br>  <strong>old system</strong> ram disk is built into kernel with these kernel configs, that means after system boots, you will seee <code>/dev/ram0, /dev/ram1, /dev/ramX</code> which has default fixed size configured during kernel compiling. even you have 16 <code>/dev/ramX</code>, <strong>the memory for each block device is not prealloated, memory allocation happens when make fs on that device.</strong>  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_BLK_DEV_RAM=y</span><br><span class="line">CONFIG_BLK_DEV_RAM_COUNT=16</span><br><span class="line">CONFIG_BLK_DEV_RAM_SIZE=16384</span><br></pre></td></tr></table></figure>
  <strong>new system</strong> newer system by default compile it as kernel module <code>brd</code>, you need to load this module when using <code>/dev/ramX</code>  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_BLK_DEV_RAM=m</span><br><span class="line">CONFIG_BLK_DEV_RAM_COUNT=16</span><br><span class="line">CONFIG_BLK_DEV_RAM_SIZE=16384</span><br></pre></td></tr></table></figure></li>
<li>change traditonal ram disk size<br>  <strong>old system</strong> ram disk is built into kernel, there is only one way to change ram disk ize, that’s by appending parmaters to kernel boot line like this.  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kernel /vmlinuz-2.6.32.24 ro root=LABEL=/ rhgb quiet ramdisk_size=10485760</span><br></pre></td></tr></table></figure>
  <strong>new system</strong> ram disk szie can be changed only when <code>brd</code> is loaded  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1G, one ram disk /dev/ram0</span></span><br><span class="line">$ modprobe brd rd_nr=1 rd_size=1048576</span><br></pre></td></tr></table></figure></li>
<li>use traditional ram disk  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ mkfs /dev/ram0</span><br><span class="line">$ <span class="built_in">mkdir</span> /mnt/randisk</span><br><span class="line">$ mount /dev/ram0 /mnt/ramdisk</span><br><span class="line">$ <span class="built_in">df</span> -h</span><br><span class="line"><span class="built_in">df</span> -h</span><br><span class="line">Filesystem               Size  Used Avail Use% Mounted on</span><br><span class="line">...</span><br><span class="line">/dev/ram0                 16M  140K   15M   1% /mnt/ramdisk</span><br></pre></td></tr></table></figure></li>
<li>use ramfs not &#x2F;dev&#x2F;ramX(<code>brd</code> is not needed for this)  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mount -t ramfs ramfs /tmp/ramdisk</span><br></pre></td></tr></table></figure>
<h2 id="ram-disk-tmpfs"><a href="#ram-disk-tmpfs" class="headerlink" title="ram disk(tmpfs)"></a>ram disk(tmpfs)</h2>Use tmpfs to create ram disk is easy.<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># memory is allocated only when it&#x27;s used, it&#x27;s not prereserved.</span></span><br><span class="line">$ mount -t tmpfs -o size=10G none /tmp/ramdisk</span><br><span class="line">(base) [root@dev github]<span class="comment"># df -h</span></span><br><span class="line">...</span><br><span class="line">none                      10G     0   10G   0% /tmp/ramdisk</span><br><span class="line"></span><br><span class="line">(base) [root@dev github]<span class="comment"># mount</span></span><br><span class="line">none on /tmp/ramdisk <span class="built_in">type</span> tmpfs (rw,relatime,seclabel,size=10485760k)</span><br></pre></td></tr></table></figure></li>
</ul>
<p>As when umount data on ram disk is gone, hence in order to save data in ram disk when reboot, we need a service that will copy data from ram disk to hard disk also copy it back to ram disk.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ vi /lib/systemd/system/ramdisk-sync.service</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line"># runs before umount service, to make sure, we copy data before umounting</span><br><span class="line"># but if you run umount mannually, data is lost.</span><br><span class="line">Before=umount.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=oneshot</span><br><span class="line">User=root</span><br><span class="line"></span><br><span class="line"># root below can be change to any user.</span><br><span class="line">ExecStartPre=/bin/chown -Rf root /mnt/ramdisk</span><br><span class="line"># when service starts, copy back when system boots</span><br><span class="line">ExecStart=/usr/bin/rsync -ar /mnt/ramdisk_backup/ /mnt/ramdisk/</span><br><span class="line"># when serivce stops, copy data from ram disk to hard disk</span><br><span class="line">ExecStop=/usr/bin/rsync -ar /mnt/ramdisk/ /mnt/ramdisk_backup/</span><br><span class="line">ExecStopPost=/bin/chown -Rf root /mnt/ramdisk_backup</span><br><span class="line">RemainAfterExit=yes</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">$ vi /etc/fstab</span><br><span class="line"></span><br><span class="line">tmpfs  /mnt/ramdisk  tmpfs  rw,size=110M  0   0</span><br></pre></td></tr></table></figure>

<p>Acutally, there are some ram disk(tmpfs) created by systemd if you check with df, it’s <code>/run/</code> and <code>/dev/shm</code>, <code>sys/fs/cgroup</code> with default size(<font color='red' size=4><strong>half of total physical memory</strong></font>)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">(base) [root@dev etc]<span class="comment"># df</span></span><br><span class="line">Filesystem              1K-blocks     Used Available Use% Mounted on</span><br><span class="line">devtmpfs                  4074576        0   4074576   0% /dev</span><br><span class="line">tmpfs                     4086484        0   4086484   0% /dev/shm</span><br><span class="line">tmpfs                     4086484     9168   4077316   1% /run</span><br><span class="line">tmpfs                     4086484        0   4086484   0% /sys/fs/cgroup</span><br><span class="line"></span><br><span class="line">(base) [root@dev etc]<span class="comment"># free</span></span><br><span class="line">              total        used        free      shared  buff/cache   available</span><br><span class="line">Mem:        8172968      979092     4939616        9308     2254260     6880632</span><br><span class="line">Swap:       8257532           0     8257532</span><br><span class="line"></span><br><span class="line">(base) [root@dev etc]<span class="comment"># mount | grep tmpfs</span></span><br><span class="line">devtmpfs on /dev <span class="built_in">type</span> devtmpfs (rw,nosuid,seclabel,size=4074576k,nr_inodes=1018644,mode=755) <span class="comment"># with size</span></span><br><span class="line">tmpfs on /dev/shm <span class="built_in">type</span> tmpfs (rw,nosuid,nodev,seclabel) <span class="comment"># without size half of total memory</span></span><br><span class="line">tmpfs on /run <span class="built_in">type</span> tmpfs (rw,nosuid,nodev,seclabel,mode=755)</span><br><span class="line">tmpfs on /sys/fs/cgroup <span class="built_in">type</span> tmpfs (ro,nosuid,nodev,noexec,seclabel,mode=755)</span><br></pre></td></tr></table></figure>
<p><strong>resize &#x2F;dev&#x2F;shm</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Edit file /etc/fstab (with sudo if needed).</span><br><span class="line">In this file, try to locate a line like this one : none /dev/shm tmpfs defaults,size=4G 0 0.</span><br><span class="line"></span><br><span class="line">Case 1 - This line exists in your /etc/fstab file:</span><br><span class="line"></span><br><span class="line">    Modify the text after size=. For example if you want an 8G size, replace size=4G by size=8G.</span><br><span class="line">    Exit your text editor, then run (with sudo if needed) $ mount -o remount /dev/shm.</span><br><span class="line"></span><br><span class="line">Case 2 - This line does NOT exists in your /etc/fstab file:</span><br><span class="line"></span><br><span class="line">    Append at the end of the file the line none /dev/shm tmpfs defaults,size=4G 0 0, and modify the text after size=. For example if you want an 8G size, replace size=4G by size=8G.</span><br><span class="line">    Exit your text editor, then run (with sudo if needed) $ mount /dev/shm.</span><br></pre></td></tr></table></figure>
<h1 id="REF"><a href="#REF" class="headerlink" title="REF"></a>REF</h1><ul>
<li><a target="_blank" rel="noopener" href="https://developer.ibm.com/articles/l-linuxboot/">linux boot process</a></li>
<li><a target="_blank" rel="noopener" href="https://www.linux.org/threads/specfs-devfs-tmpfs-and-others.9382/">rootfs, initramfs, devfs, tmpfs etc</a></li>
</ul>

    </div>

    
    
    
      


    <footer class="post-footer">
          <div class="reward-container">
  <div></div>
  <button>
    Donate
  </button>
  <div class="post-reward">
      <div>
        <img src="/images/wechatpay.jpeg" alt="Jason WeChat Pay">
        <span>WeChat Pay</span>
      </div>

  </div>
</div>

          <div class="post-tags">
              <a href="/tags/linux/" rel="tag"># linux</a>
              <a href="/tags/initramfs/" rel="tag"># initramfs</a>
              <a href="/tags/tmpfs/" rel="tag"># tmpfs</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/11/02/qemu-kvm/" rel="prev" title="qemu-kvm">
                  <i class="fa fa-chevron-left"></i> qemu-kvm
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2021/12/15/k8s-service-mesh/" rel="next" title="k8s_service_mesh">
                  k8s_service_mesh <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments utterances-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2018 – 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Cyun All rights reserved</span>
</div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.0/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>



  <script src="/js/third-party/fancybox.js"></script>

  <script src="/js/third-party/pace.js"></script>

  




<script class="next-config" data-name="utterances" type="application/json">{"enable":true,"repo":"jason-bj/blog","issue_term":"pathname","theme":"github-light"}</script>
<script src="/js/third-party/comments/utterances.js"></script>

</body>
</html>
