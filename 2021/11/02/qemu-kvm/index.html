<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon/favicon-16x16.png">
  <meta name="google-site-verification" content="xitt2fbphh1nTeWLiTWc0lCggHuxJ5heMcAzkHW2vno">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Microsoft+YaHei+UI:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"cyun.tech","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.11.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"utterances","storage":true,"lazyload":false,"nav":null,"activeClass":"utterances"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":10,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="OverviewIn this article, we only give you the knowledge of qemu-kvm without libvirt, say how to start vm by running qemu-kvm itself and others.">
<meta property="og:type" content="article">
<meta property="og:title" content="qemu-kvm">
<meta property="og:url" content="http://cyun.tech/2021/11/02/qemu-kvm/index.html">
<meta property="og:site_name" content="CYun">
<meta property="og:description" content="OverviewIn this article, we only give you the knowledge of qemu-kvm without libvirt, say how to start vm by running qemu-kvm itself and others.">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://www.qemu.org/screenshots/2018-05-31-qemu-cli-net.svg">
<meta property="og:image" content="https://www.qemu.org/screenshots/2018-05-31-qemu-cli-netdev.svg">
<meta property="article:published_time" content="2021-11-02T11:15:19.000Z">
<meta property="article:modified_time" content="2023-10-20T15:03:30.378Z">
<meta property="article:author" content="Jason">
<meta property="article:tag" content="qemu">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://www.qemu.org/screenshots/2018-05-31-qemu-cli-net.svg">


<link rel="canonical" href="http://cyun.tech/2021/11/02/qemu-kvm/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://cyun.tech/2021/11/02/qemu-kvm/","path":"2021/11/02/qemu-kvm/","title":"qemu-kvm"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>qemu-kvm | CYun</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-148730544-1"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-148730544-1","only_pageview":false}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?a510d1f580c8231f8f867d14f42bb8ea"></script>




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">CYun</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Overview"><span class="nav-number">1.</span> <span class="nav-text">Overview</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Simulated-device"><span class="nav-number">2.</span> <span class="nav-text">Simulated device</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#serial-device-backend-chardev"><span class="nav-number">2.1.</span> <span class="nav-text">serial device backend(chardev)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Socket-option"><span class="nav-number">2.1.1.</span> <span class="nav-text">Socket option</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Pty"><span class="nav-number">2.1.2.</span> <span class="nav-text">Pty</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Block-device-backend"><span class="nav-number">2.2.</span> <span class="nav-text">Block device(backend)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#USB"><span class="nav-number">2.3.</span> <span class="nav-text">USB</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#network-dev"><span class="nav-number">2.4.</span> <span class="nav-text">network dev</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#linux-bridge"><span class="nav-number">2.4.1.</span> <span class="nav-text">linux bridge</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ovs-bridge"><span class="nav-number">2.4.2.</span> <span class="nav-text">ovs bridge</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Kernel-and-rootfs"><span class="nav-number">3.</span> <span class="nav-text">Kernel and rootfs</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Change-vm-setting-runtime"><span class="nav-number">4.</span> <span class="nav-text">Change vm setting runtime</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#command-output"><span class="nav-number">4.1.</span> <span class="nav-text">command output</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#disk-image"><span class="nav-number">5.</span> <span class="nav-text">disk image</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Operation"><span class="nav-number">5.1.</span> <span class="nav-text">Operation</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#backing-file-qcow2"><span class="nav-number">5.2.</span> <span class="nav-text">backing file(qcow2)</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#FAQ"><span class="nav-number">6.</span> <span class="nav-text">FAQ</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Boot-with-disk-x2F-diskless"><span class="nav-number">6.1.</span> <span class="nav-text">Boot with disk&#x2F;diskless</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#how-to-terminate-qemu-process-from-console"><span class="nav-number">6.2.</span> <span class="nav-text">how to terminate qemu process from console</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#how-to-start-qemu-with-vnc"><span class="nav-number">6.3.</span> <span class="nav-text">how to start qemu with vnc</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#how-to-mount-raw-disk"><span class="nav-number">6.4.</span> <span class="nav-text">how to mount raw disk</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#after-enter-qmp-command-no-output"><span class="nav-number">6.5.</span> <span class="nav-text">after enter qmp command, no output</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#difference-between-net-netdev-and-nic"><span class="nav-number">6.6.</span> <span class="nav-text">difference between -net, -netdev and -nic</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#net-legacy-option"><span class="nav-number">6.6.1.</span> <span class="nav-text">-net(legacy option)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#netdev"><span class="nav-number">6.6.2.</span> <span class="nav-text">-netdev</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#nic"><span class="nav-number">6.6.3.</span> <span class="nav-text">-nic</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#qemu-kvm-and-qemu-kvm-ev"><span class="nav-number">6.7.</span> <span class="nav-text">qemu-kvm and qemu-kvm-ev</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#why-qemu-needs-nvdimm"><span class="nav-number">6.8.</span> <span class="nav-text">why qemu needs nvdimm??</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#why-PCI-address-in-guest-is-not-the-same-as-we-set"><span class="nav-number">6.9.</span> <span class="nav-text">why PCI address(in guest) is not the same as we set?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#reduce-qcow-file-size-on-host"><span class="nav-number">6.10.</span> <span class="nav-text">reduce qcow file size on host</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#how-to-enable-IOMMU-for-VM"><span class="nav-number">6.11.</span> <span class="nav-text">how to enable IOMMU for VM</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#REF"><span class="nav-number">7.</span> <span class="nav-text">REF</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Jason"
      src="/uploads/avatar.gif">
  <p class="site-author-name" itemprop="name">Jason</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">149</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">141</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">148</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/jason-cyun" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;jason-cyun" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:jason_lkm@163.com" title="E-Mail → mailto:jason_lkm@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://cyun.tech/2021/11/02/qemu-kvm/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.gif">
      <meta itemprop="name" content="Jason">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CYun">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="qemu-kvm | CYun">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          qemu-kvm
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-11-02 19:15:19" itemprop="dateCreated datePublished" datetime="2021-11-02T19:15:19+08:00">2021-11-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-10-20 23:03:30" itemprop="dateModified" datetime="2023-10-20T23:03:30+08:00">2023-10-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/kvm/" itemprop="url" rel="index"><span itemprop="name">kvm</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/kvm/qemu/" itemprop="url" rel="index"><span itemprop="name">qemu</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h1><p>In this article, we only give you the knowledge of qemu-kvm without libvirt, say how to start vm by running qemu-kvm itself and others.</p>
<span id="more"></span>

<h1 id="Simulated-device"><a href="#Simulated-device" class="headerlink" title="Simulated device"></a>Simulated device</h1><p>qemu-kvm can simulate serial, block, serial, net device inside vm based on virtio driver, the simulated virtio devices is located at <code>/sys/class/virtio-ports/</code>, for simulated device, there are two sides need to be set from command line, backend in host, virtio in vm.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ qemu-kvm -chardev socket,<span class="built_in">id</span>=charch0,path=/var/run/xagent/vm-HZVsuboAJh-<span class="built_in">test</span>/xagent.sock -device virtserialport,bus=virtio-serial0.0,nr=1,chardev=charch0,<span class="built_in">id</span>=channel0,name=agent.channel.0 -serial unix:/var/run/agent/vm-HZVsuboAJh-<span class="built_in">test</span>/console.sock,server,nowait -device virtio-serial-pci,<span class="built_in">id</span>=virtio-serial0,bus=pci.0,addr=0x2</span><br><span class="line"></span><br><span class="line"><span class="comment"># check device name inside guest</span></span><br><span class="line">$ <span class="built_in">cat</span> /sys/class/virtio-ports/vport0p1/name</span><br><span class="line">agent.channel.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># check device id(major:minor) inside guest</span></span><br><span class="line">$ <span class="built_in">cat</span> /sys/class/virtio-ports/vport0p1/dev</span><br><span class="line">252:1</span><br><span class="line"></span><br><span class="line"><span class="comment"># echo hello&gt; /dev/vport0p1</span></span><br></pre></td></tr></table></figure>
<p><strong>Device Front End</strong><br>A device front end is how a device is presented to the guest. The type of device presented should match the hardware that the guest operating system is expecting to see. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># check support front end device and specific options for each type</span></span><br><span class="line">$ /usr/libexec/qemu-kvm --device virtio-serial-pci,<span class="built_in">help</span></span><br><span class="line">virtio-serial-pci.event_idx=bool (on/off)</span><br><span class="line">virtio-serial-pci.ioeventfd=bool (on/off)</span><br><span class="line">virtio-serial-pci.multifunction=bool (on/off)</span><br><span class="line">virtio-serial-pci.rombar=uint32</span><br><span class="line">virtio-serial-pci.x-disable-pcie=bool (on/off)</span><br><span class="line">virtio-serial-pci.indirect_desc=bool (on/off)</span><br><span class="line">virtio-serial-pci.__com.redhat_rhel6_ctrl_guest_workaround=bool</span><br><span class="line">virtio-serial-pci.disable-modern=bool</span><br><span class="line">virtio-serial-pci.disable-legacy=OnOffAuto (on/off/auto)</span><br><span class="line">virtio-serial-pci.emergency-write=bool (on/off)</span><br><span class="line">virtio-serial-pci.command_serr_enable=bool (on/off)</span><br><span class="line">virtio-serial-pci.x-pcie-lnkctl-init=bool (on/off)</span><br><span class="line">virtio-serial-pci.max_ports=uint32</span><br><span class="line">virtio-serial-pci.page-per-vq=bool (on/off)</span><br><span class="line">virtio-serial-pci.x-pcie-deverr-init=bool (on/off)</span><br><span class="line">virtio-serial-pci.x-pcie-pm-init=bool (on/off)</span><br><span class="line">virtio-serial-pci.x-pcie-lnksta-dllla=bool (on/off)</span><br><span class="line">virtio-serial-pci.any_layout=bool (on/off)</span><br><span class="line">virtio-serial-pci.class=uint32</span><br><span class="line">virtio-serial-pci.addr=int32 (Slot and optional <span class="keyword">function</span> number, example: 06.0 or 06)</span><br><span class="line">virtio-serial-pci.migrate-extra=bool (on/off)</span><br><span class="line">virtio-serial-pci.modern-pio-notify=bool (on/off)</span><br><span class="line">virtio-serial-pci.vectors=uint32</span><br><span class="line">virtio-serial-pci.x-pcie-extcap-init=bool (on/off)</span><br><span class="line">virtio-serial-pci.virtio-backend=child&lt;virtio-serial-device&gt;</span><br><span class="line">virtio-serial-pci.x-ignore-backend-features=bool</span><br><span class="line">virtio-serial-pci.notify_on_empty=bool (on/off)</span><br><span class="line">virtio-serial-pci.iommu_platform=bool (on/off)</span><br><span class="line">virtio-serial-pci.ats=bool (on/off)</span><br><span class="line">virtio-serial-pci.virtio-pci-bus-master-bug-migration=bool (on/off)</span><br><span class="line">virtio-serial-pci.romfile=str</span><br><span class="line"></span><br><span class="line"><span class="comment"># check common options, refer to https://qemu-project.gitlab.io/qemu/system/invocation.html#hxtool-1</span></span><br><span class="line">/usr/libexec/qemu-kvm -d int -D /tmp/qemu_vm.log -trace <span class="built_in">enable</span>=* -kernel /home/data/github/cyun/utils/tips_useful_script/qemu/kernel-5.10.7 -initrd /home/data/github/cyun/utils/tips_useful_script/qemu/initramfs.img -nographic -append console=ttyS0 -qmp unix:/var/run/qmp.sock,server,nowait -serial mon:stdio -vnc 0.0.0.0:106 -chardev file,<span class="built_in">id</span>=mydev0,path=/tmp/test.s -device isa-serial,chardev=mydev0</span><br></pre></td></tr></table></figure>

<p><strong>A front end is often paired with a back end, which describes how the host’s resources are used in the emulation.</strong></p>
<p><strong>Device Back End</strong><br>The back end describes <code>how the data from the emulated device will be processed by QEMU</code>. The <strong>configuration of the back end is usually specific to the class of device being emulated</strong>. For example <code>serial devices will be backed by a --chardev</code> which can redirect the data to a file or socket or some other system. <code>Storage devices are handled by --blockdev</code> which will specify how blocks are handled, for example being stored in a qcow2 file or accessing a raw host disk partition. Back ends can sometimes be stacked to implement features like snapshots.</p>
<p><code>While the choice of back end is generally transparent to the guest</code>, there are cases where features will not be reported to the guest if the back end is unable to support it.</p>
<p><strong>Device Buses</strong><br>Most devices will exist on a BUS of some sort. Depending on the machine model you choose (-M foo) a number of buses will have been automatically created. In most cases the BUS a device is attached to can be inferred, for example <code>PCI devices are generally automatically allocated to the next free address of first PCI bus found</code>. However <strong>in complicated configurations you can explicitly specify what bus (bus&#x3D;ID) a device is attached to along with its address (addr&#x3D;N).</strong></p>
<p>Some devices, for example a PCI SCSI host controller, will add an additional buses to the system that other devices can be attached to. A hypothetical chain of devices might look like:</p>
<p><code>–device foo,bus=pci.0,addr=0,id=foo –device bar,bus=foo.0,addr=1,id=baz</code></p>
<p>which would be a bar device (with the ID of baz) which is attached to the first foo bus (foo.0) at address 1. The foo device which provides that bus is itself is attached to the first PCI bus (pci.0).</p>
<h2 id="serial-device-backend-chardev"><a href="#serial-device-backend-chardev" class="headerlink" title="serial device backend(chardev)"></a>serial device backend(chardev)</h2><p>Qemu char device uses below format for <strong>backend</strong>, more options refer to <a target="_blank" rel="noopener" href="https://qemu-project.gitlab.io/qemu/system/invocation.html#hxtool-6">qemu chardev options</a></p>
<p><code>-chardev backend,id=id[,mux=on|off][,options]</code></p>
<p>Backend is one of: null, <code>socket, udp, file, pipe, console, serial, pty, stdio, tty, parallel and more...</code> . The specific backend will determine the applicable options. different types have different options for that specific type.</p>
<p><font color='red' size=4>All devices must have an id, which can be any string up to 127 characters long</font>. It is used to uniquely identify this device in other command line directives.</p>
<p><code>A character device may be used in multiplexing mode by multiple front-ends</code>. Specify mux&#x3D;on to enable this mode. A multiplexer is a “1:N” device, and here the “1” end is your specified chardev backend, and the “N” end is the various parts of QEMU that can talk to a chardev. by default it’s disabled</p>
<p><strong>Example</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-chardev file,<span class="built_in">id</span>=mydev0,path=/tmp/test.s \</span><br><span class="line">-device isa-serial,chardev=mydev0 \</span><br><span class="line"></span><br><span class="line">$ /usr/libexec/qemu-kvm -d int -D /tmp/qemu_vm.log -trace <span class="built_in">enable</span>=* -kernel /home/data/github/cyun/utils/tips_useful_script/qemu/kernel-5.10.7 -initrd /home/data/github/cyun/utils/tips_useful_script/qemu/initramfs.img -nographic -append console=ttyS0 -qmp unix:/var/run/qmp.sock,server,nowait -serial mon:stdio -vnc 0.0.0.0:106 -chardev file,<span class="built_in">id</span>=mydev0,path=/tmp/test.s -device isa-serial,chardev=mydev0</span><br><span class="line"><span class="comment"># in guest /dev/ttyS1 is front end as the ttyS0 is used for console!!!</span></span><br></pre></td></tr></table></figure>

<p>use virtio serial in the guest, in order to do this, you have to add a <code>virtio pci serial device(hub)</code> into the PCI bus, then under this virtio serial device, you can create serial and console port.</p>
<p>virtio-serial-pci &#x3D;&#x3D; virtio-serial</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-device virtio-serial-pci,<span class="built_in">id</span>=virtio_serial_pci0 \</span><br><span class="line">-chardev file,<span class="built_in">id</span>=mydev0,path=/tmp/test.s \</span><br><span class="line">-device virtserialport,chardev=mydev0,name=serial0,<span class="built_in">id</span>=vc1,bus=virtio_serial_pci0.0 \</span><br><span class="line">-chardev file,<span class="built_in">id</span>=mydev1,path=/tmp/test.c \</span><br><span class="line">-device virtconsole,chardev=mydev1,name=serial1,<span class="built_in">id</span>=vc2,bus=virtio_serial_pci0.0</span><br></pre></td></tr></table></figure>
<h3 id="Socket-option"><a href="#Socket-option" class="headerlink" title="Socket option"></a>Socket option</h3><p><code>-chardev socket,id=id[,TCP options or unix options][,server=on|off][,wait=on|off][,telnet=on|off][,websocket=on|off][,reconnect=seconds][,tls-creds=id][,tls-authz=id]</code></p>
<ul>
<li>Create a <code>two-way stream socket</code>, which can be either a TCP or a unix socket. A unix socket will be created if path is specified. Behaviour is undefined if TCP options are specified for a unix socket.</li>
<li>server&#x3D;on|off specifies that the socket shall be a listening socket.</li>
<li>wait&#x3D;on|off specifies that QEMU should not block waiting for a client to connect to a listening socket.</li>
<li>telnet&#x3D;on|off specifies that traffic on the socket should interpret telnet escape sequences.</li>
<li>websocket&#x3D;on|off specifies that the socket uses WebSocket protocol for communication.</li>
<li>reconnect sets the timeout for reconnecting on non-server sockets when the remote end goes away. qemu will delay this many seconds and then attempt to reconnect. Zero disables reconnecting, and is the default.</li>
<li>tls-creds requests enablement of the TLS protocol for encryption, and specifies the id of the TLS credentials to use for the handshake. The credentials must be previously created with the -object tls-creds argument.</li>
<li>tls-auth provides the ID of the QAuthZ authorization object against which the client’s x509 distinguished name will be validated. This object is only resolved at time of use, so can be deleted and recreated on the fly while the chardev server is active. If missing, it will default to denying access.</li>
</ul>
<p><em>TCP and unix socket options are given below:</em></p>
<p><code>TCP options: port=port[,host=host][,to=to][,ipv4=on|off][,ipv6=on|off][,nodelay=on|off]</code></p>
<ul>
<li><p>host for a listening socket specifies the local address to be bound. For a connecting socket species the remote host to connect to. host is optional for listening sockets. If not specified it defaults to 0.0.0.0.</p>
</li>
<li><p>port for a listening socket specifies the local port to be bound. For a connecting socket specifies the port on the remote host to connect to. port can be given as either a port number or a service name. port is required.</p>
</li>
<li><p>to is only relevant to listening sockets. If it is specified, and port cannot be bound, QEMU will attempt to bind to subsequent ports up to and including to until it succeeds. to must be specified as a port number.</p>
</li>
<li><p>ipv4&#x3D;on|off and ipv6&#x3D;on|off specify that either IPv4 or IPv6 must be used. If neither is specified the socket may use either protocol.</p>
</li>
<li><p>nodelay&#x3D;on|off disables the Nagle algorithm.</p>
</li>
</ul>
<p><code>unix options: path=path[,abstract=on|off][,tight=on|off]</code></p>
<ul>
<li>path specifies the local path of the unix socket. path is required. abstract&#x3D;on|off specifies the use of the abstract socket namespace, rather than the filesystem. Optional, defaults to false. tight&#x3D;on|off sets the socket length of abstract sockets to their minimum, rather than the full sun_path length. Optional, defaults to true.</li>
</ul>
<h3 id="Pty"><a href="#Pty" class="headerlink" title="Pty"></a>Pty</h3><p><code>-chardev pty,id=id</code>  </p>
<ul>
<li>Create a new pseudo-terminal on the host and connect to it. pty does not take any options.</li>
</ul>
<h2 id="Block-device-backend"><a href="#Block-device-backend" class="headerlink" title="Block device(backend)"></a>Block device(backend)</h2><h2 id="USB"><a href="#USB" class="headerlink" title="USB"></a>USB</h2><p><a target="_blank" rel="noopener" href="https://qemu-project.gitlab.io/qemu/system/devices/usb.html">QEMU</a> can emulate a PCI UHCI, OHCI, EHCI or XHCI USB controller. You can plug virtual USB devices, QEMU will <code>automatically create and connect virtual USB hubs as necessary to connect multiple USB devices</code></p>
<p><strong>XHCI controller</strong><br>QEMU has XHCI host adapter support. The XHCI hardware design is much more virtualization-friendly when compared to EHCI and UHCI, thus XHCI emulation uses less resources (especially CPU). So if your guest supports XHCI (which should be the case for any operating system released around 2010 or later) we recommend using it:<br><code>qemu -device qemu-xhci</code>  or <code>qemu -device nec-usb-xhci</code></p>
<p><strong>XHCI supports USB 1.1, USB 2.0 and USB 3.0 devices</strong>, so this is the only controller you need. <strong>With only a single USB controller (and therefore only a single USB bus) present in the system there is no need to use the bus&#x3D; parameter when adding USB devices, as there is only one controller!!!</strong></p>
<p><strong>EHCI controller</strong><br>The QEMU EHCI Adapter supports USB 2.0 devices. It can be used either <code>standalone or with companion controllers (UHCI, OHCI) for USB 1.1 devices</code>. The <code>companion controller setup is more convenient to use because it provides a single USB bus supporting both USB 2.0 and USB 1.1 devices</code></p>
<p><strong>EHCI standalone</strong><br>When running <code>EHCI in standalone mode you can add UHCI or OHCI controllers for USB 1.1 devices too</code>. Each controller creates its own bus though, <code>so there are two completely separate USB buses:</code> One USB 1.1 bus driven by the UHCI controller and one USB 2.0 bus driven by the EHCI controller. <strong>Devices must be attached to the correct controller manually</strong></p>
<p><strong>EHCI compansion</strong><br><code>The UHCI and OHCI controllers can attach to a USB bus created by EHCI as companion controllers</code>. This is done by specifying the <code>masterbus</code> and <code>firstport</code> properties. masterbus specifies the bus name the controller should attach to. firstport specifies the first port the controller should attach to, which is needed as <code>usually one EHCI controller with six ports has three UHCI companion controllers with two ports each</code>.</p>
<p>Companion controller is defined as <code>multiple USB host controllers (EHCI/OHCI/UHCI) that are wired to the same physical connector</code> such that a device, depending on some characteristic like speed, will <code>be connected to a different controller even when plugged into the same connector</code>, so that for a port on EHCI bus, it can handle usb2.0 and usb1.1 devices, but from system views, you still see several controllers, each takes one PCI addresse!!!</p>
<p><font color='red'><strong>Bus selection for USB devices</strong></font></p>
<ul>
<li><p>XHCI only(support usb1.1, usb2.0, usb3.0), only one usb bus(<strong>Recommanded</strong>)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  no need to set bus=xx as there is only one usb controller</span></span><br><span class="line">-device qemu-xhci \</span><br><span class="line">-device usb-tablet</span><br></pre></td></tr></table></figure></li>
<li><p>EHCI bus(usb2.0) + UCHI(OHCI)(usb1.1), two separate buses, usb devices must set <code>bus=x</code> manually.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># USB 1.1(uhci,ohci controller) bus will carry the name usb-bus.0</span></span><br><span class="line"><span class="comment"># usb2.0(ehci controller) will carry the name ehci.0</span></span><br><span class="line"><span class="comment"># usb3.0(xhci controller) will carry the name usb1.0</span></span><br><span class="line"><span class="comment"># must set bus for each usb device as there are two separate buses.</span></span><br><span class="line"><span class="comment"># The &#x27;-usb&#x27; switch will make qemu create the UHCI controller as part of the PIIX3 chipset.  The USB 1.1 bus will carry the name &quot;usb-bus.0&quot;.</span></span><br><span class="line">-usb                                                        \</span><br><span class="line">-device usb-ehci,<span class="built_in">id</span>=ehci                                    \</span><br><span class="line">-device usb-tablet,bus=usb-bus.0                            \</span><br><span class="line">-device usb-storage,bus=ehci.0,drive=usbstick</span><br></pre></td></tr></table></figure></li>
<li><p>Companion controller, only one usb bus.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># usb2.0 controller ehci six ports</span></span><br><span class="line"><span class="comment"># usb1.1 controller uchi(two ports) attached to ehci</span></span><br><span class="line">-device ich9-usb-ehci1,<span class="built_in">id</span>=usb,bus=pci.0,addr=0x3.0x7 \</span><br><span class="line">-device ich9-usb-uhci1,masterbus=usb.0,firstport=0,bus=pci.0,multifunction=on,addr=0x3 \</span><br><span class="line">-device ich9-usb-uhci2,masterbus=usb.0,firstport=2,bus=pci.0,addr=0x3.0x1 \</span><br><span class="line">-device ich9-usb-uhci3,masterbus=usb.0,firstport=4,bus=pci.0,addr=0x3.0x2 \</span><br><span class="line">-device usb-tablet</span><br><span class="line"></span><br><span class="line"><span class="comment"># inside guest</span></span><br><span class="line">$ lspci </span><br><span class="line">00:03.0 USB controller: Intel Corporation 82801I (ICH9 Family) USB UHCI Controller <span class="comment">#1 (rev 03)</span></span><br><span class="line">00:03.1 USB controller: Intel Corporation 82801I (ICH9 Family) USB UHCI Controller <span class="comment">#2 (rev 03)</span></span><br><span class="line">00:03.2 USB controller: Intel Corporation 82801I (ICH9 Family) USB UHCI Controller <span class="comment">#3 (rev 03)</span></span><br><span class="line">00:03.7 USB controller: Intel Corporation 82801I (ICH9 Family) USB2 EHCI Controller <span class="comment">#1 (rev 03)</span></span><br></pre></td></tr></table></figure>
<p>USB devices can be connected with the -device <code>usb-... </code>command line option or the device_add monitor command. Available devices are:</p>
</li>
<li><p>usb-mouse</p>
</li>
<li><p>usb-tablet</p>
</li>
<li><p>usb-kbd (Standard USB keyboard)</p>
</li>
<li><p>usb-audio</p>
</li>
<li><p>…</p>
</li>
</ul>
<p><strong>USB Hub</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Plugging a hub into UHCI port 2 works like this:</span></span><br><span class="line">-device usb-hub,bus=usb-bus.0,port=2</span><br><span class="line"><span class="comment"># Plugging a virtual USB stick into port 4 of the hub just plugged works this way:</span></span><br><span class="line">-device usb-storage,bus=usb-bus.0,port=2.4,drive=...</span><br></pre></td></tr></table></figure>

<h2 id="network-dev"><a href="#network-dev" class="headerlink" title="network dev"></a>network dev</h2><p>In order to use network device, you need to setup two sides front end and back end, but different types use different ways to setup backend, let’s say vhost-user and tap uses different way to setup back end, Here show tap interface as example, you have to do</p>
<ul>
<li>A bridge(ovs bridge or linux bridge) created by user.</li>
<li><code>A tap interface created by user or let qemu to create it automatically.</code></li>
<li>Up tap interface and add it to the bridge, either by user manually from command line or provide <code>/etc/qemu-ifup which is called by qemu automatically</code></li>
<li>Down tap interface and remove it from the bridge, either by user mannulay from command linie or provide <code>/etc/qemu-ifdown whih is called by qemu automatically</code></li>
</ul>
<p>There are severals way to setup network devices. In short, the <strong>-net is the legacy option</strong>, while -netdev comes in to solve issue present for -net, the <code>newest way -nic from 2.12 is easiest way to set up an interface.</code></p>
<ul>
<li>The -net option can create either a front-end or a back-end (but has disadvanges than -nic)</li>
<li><strong>-netdev can only create a back-end, use -device for front end</strong></li>
<li><strong>Asingle occurrence of -nic will create both a front-end and a back-end</strong>.</li>
</ul>
<p><strong>NOTE</strong><br>if you use libvirt, all these operations will be done by libvirt itself!!</p>
<h3 id="linux-bridge"><a href="#linux-bridge" class="headerlink" title="linux bridge"></a>linux bridge</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># create a linux bridge or ovs bridge if ovs installed, or use docker bridge(docker0) which is linux bridge</span></span><br><span class="line">$ brctl show</span><br><span class="line">bridge name     bridge <span class="built_in">id</span>               STP enabled     interfaces</span><br><span class="line">docker0         8000.525400d85e6d       <span class="built_in">yes</span>             docker0-nic</span><br><span class="line">                                                        veth6e0057e</span><br><span class="line">                                                        vethdb3e964</span><br><span class="line">                                                        vnet0</span><br><span class="line"><span class="comment"># cat /etc/qemu-ifup</span></span><br><span class="line"><span class="comment">#! /bin/sh</span></span><br><span class="line">ifconfig <span class="string">&quot;<span class="variable">$1</span>&quot;</span> 0.0.0.0 up</span><br><span class="line">br=<span class="string">&#x27;docker0&#x27;</span></span><br><span class="line">brctl addif <span class="variable">$br</span> <span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># chmod +x /etc/qemu-ifup</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cat /etc/qemu-ifdown</span></span><br><span class="line"><span class="comment">#! /bin/sh</span></span><br><span class="line">ifconfig <span class="string">&quot;<span class="variable">$1</span>&quot;</span> 0.0.0.0 down</span><br><span class="line">br=<span class="string">&#x27;docker0&#x27;</span></span><br><span class="line">brctl delif <span class="variable">$br</span> <span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># chmod +x /etc/qemu-ifdown</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># run vm with network</span></span><br><span class="line">$ /usr/libexec/qemu-kvm -kernel kernel-4.14.121 -initrd initramfs.img -nographic -append <span class="string">&quot;console=ttyS0&quot;</span> -qmp unix:/var/run/qmp.sock,server,nowait -serial mon:stdio -netdev tap,<span class="built_in">id</span>=n1,ifname=tap0,script=/etc/qemu-ifup,downscript=/etc/qemu-ifdown -device virtio-net,netdev=n1</span><br><span class="line"><span class="comment"># with vhost-net on, then check vhost worker thread by  ps -ef | grep vhost-$qemu_pid</span></span><br><span class="line">$ /usr/libexec/qemu-kvm -kernel kernel-4.14.121 -initrd initramfs.img -nographic -append <span class="string">&quot;console=ttyS0&quot;</span> -qmp unix:/var/run/qmp.sock,server,nowait -serial mon:stdio -netdev tap,<span class="built_in">id</span>=n1,ifname=tap0,vhost=on,script=/etc/qemu-ifup,downscript=/etc/qemu-ifdown -device virtio-net,netdev=n1</span><br><span class="line"></span><br><span class="line"><span class="comment">#======== tap0 on the host is created by qemu automatically ========</span></span><br><span class="line">$ brctl show</span><br><span class="line">bridge name     bridge <span class="built_in">id</span>               STP enabled     interfaces</span><br><span class="line">docker0         8000.525400d85e6d       <span class="built_in">yes</span>             docker0-nic</span><br><span class="line">                                                        tap0</span><br><span class="line">                                                        veth6e0057e</span><br><span class="line">                                                        vethdb3e964</span><br><span class="line">                                                        vnet0</span><br><span class="line"><span class="comment"># then inside vm, if you have dhcp client, it will try get ip or dns from docker0 whih must have dnsmsq runs on it, or other dhcp server</span></span><br><span class="line"><span class="comment"># if no dhcp client or server, you need to config an ip and setup dns server, route, then VM can access outside network!!!</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># =====================================Expose vm port for outside like:ssh ==============================================</span></span><br><span class="line"><span class="comment"># As the it uses docker0 network like 172.17.0.x which is private address</span></span><br><span class="line"><span class="comment"># Inside VM it can access external network as docker already setup iptables for us automatically.</span></span><br><span class="line"><span class="comment"># but outside can NOT access VM as it&#x27;s private network, in order to let outisde acesss VM like port 22 or 80</span></span><br><span class="line"><span class="comment"># you have to expose VM port to Host Port by iptables like this.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># expose VM port 22 to host port 6622!!! VM IP: 172.17.0.2</span></span><br><span class="line">$ <span class="built_in">cat</span> exponse.sh</span><br><span class="line">iptables -t nat -C DOCKER ! -i docker0 -p tcp -m tcp --dport 6622 -j DNAT --to-destination 172.17.0.2:22 &gt;/dev/null 2&gt;&amp;1</span><br><span class="line"><span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span></span><br><span class="line">  iptables -t nat -A DOCKER ! -i docker0 -p tcp -m tcp --dport 6622 -j DNAT --to-destination 172.17.0.2:22</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">iptables -t filter -C DOCKER -d 172.17.0.2/32 ! -i docker0 -o docker0 -p tcp -m tcp --dport 6622 -j ACCEPT &gt;/dev/null 2&gt;&amp;1</span><br><span class="line"><span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span></span><br><span class="line">  iptables -A DOCKER -d 172.17.0.2/32 ! -i docker0 -o docker0 -p tcp -m tcp --dport 6622 -j ACCEPT</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://docs.windriver.com/bundle/Wind_River_Linux_Platform_Virtualization_Features_Guide_9_1/page/tfx1501099048400.html">Tap port with linux bridge example</a></p>
<h3 id="ovs-bridge"><a href="#ovs-bridge" class="headerlink" title="ovs bridge"></a>ovs bridge</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># show ovs bridge</span></span><br><span class="line">$ ovs-vsctl show</span><br><span class="line">23b480b4-4a65-4163-8840-439ef102449e</span><br><span class="line">    Bridge ovs-br0</span><br><span class="line">        Port enp0s3</span><br><span class="line">            Interface enp0s3</span><br><span class="line">        Port ovs-br0</span><br><span class="line">            Interface ovs-br0</span><br><span class="line">                <span class="built_in">type</span>: internal</span><br><span class="line">    ovs_version: <span class="string">&quot;2.16.0&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># touch /etc/ovs-ifup</span></span><br><span class="line"><span class="comment">#! /bin/sh</span></span><br><span class="line">ifconfig <span class="string">&quot;<span class="variable">$1</span>&quot;</span> 0.0.0.0 up</span><br><span class="line">br=<span class="string">&#x27;ovs-br0&#x27;</span></span><br><span class="line">ovs-vsctl add-port <span class="variable">$&#123;br&#125;</span> <span class="variable">$1</span></span><br><span class="line"><span class="comment"># chmod +x /etc/ovs-ifup</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># touch /etc/ovs-ifdown</span></span><br><span class="line"><span class="comment">#! /bin/sh</span></span><br><span class="line">ifconfig <span class="string">&quot;<span class="variable">$1</span>&quot;</span> 0.0.0.0 down</span><br><span class="line">br=<span class="string">&#x27;ovs-br0&#x27;</span></span><br><span class="line">ovs-vsctl del-port <span class="variable">$&#123;br&#125;</span> <span class="variable">$1</span></span><br><span class="line"><span class="comment"># chmod +x /etc/ovs-ifdown</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># run vm with network</span></span><br><span class="line">$ /usr/libexec/qemu-kvm -kernel kernel-4.14.121 -initrd initramfs.img -nographic -append <span class="string">&quot;console=ttyS0&quot;</span> -qmp unix:/var/run/qmp.sock,server,nowait -serial mon:stdio -netdev tap,<span class="built_in">id</span>=n1,ifname=vnet0,script=/etc/ovs-ifup,downscript=/etc/ovs-ifdown -device virtio-net,netdev=n1</span><br><span class="line"><span class="comment"># Or with vhost-net enabled, then check vhost worker thread by ps -ef | grep vhost-$qemu_pid</span></span><br><span class="line">$ /usr/libexec/qemu-kvm -kernel kernel-4.14.121 -initrd initramfs.img -nographic -append <span class="string">&quot;console=ttyS0&quot;</span> -qmp unix:/var/run/qmp.sock,server,nowait -serial mon:stdio -netdev tap,<span class="built_in">id</span>=n1,ifname=vnet0,vhost=on,script=/etc/ovs-ifup,downscript=/etc/ovs-ifdown -device virtio-net,netdev=n1</span><br><span class="line"></span><br><span class="line">$ ovs-vsctl show</span><br><span class="line">23b480b4-4a65-4163-8840-439ef102449e</span><br><span class="line">    Bridge ovs-br0</span><br><span class="line">        Port vnet0</span><br><span class="line">            Interface vnet0</span><br><span class="line">        Port enp0s3</span><br><span class="line">            Interface enp0s3</span><br><span class="line">        Port ovs-br0</span><br><span class="line">            Interface ovs-br0</span><br><span class="line">                <span class="built_in">type</span>: internal</span><br><span class="line">    ovs_version: <span class="string">&quot;2.16.0&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># vnet0 is created by qemu automatically</span></span><br><span class="line">$ ethtool  -i vnet0</span><br><span class="line">driver: tun</span><br><span class="line">version: 1.6</span><br><span class="line">firmware-version: </span><br><span class="line">expansion-rom-version: </span><br><span class="line">bus-info: tap         -----------------&gt;tap device</span><br><span class="line">supports-statistics: no</span><br><span class="line">supports-test: no</span><br><span class="line">supports-eeprom-access: no</span><br><span class="line">supports-register-dump: no</span><br><span class="line">supports-priv-flags: no</span><br><span class="line"></span><br><span class="line"><span class="comment"># then inside vm, if you have dhcp client, it will try get ip or dns from docker0 which has dnsmasq runs on it</span></span><br><span class="line"><span class="comment"># if no dhcp client or server, you need to config an ip and setup dns server, route, then VM can access outside network!!!</span></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://www.sbarjatiya.com/notes_wiki/index.php/Starting_qemu-kvm_VMs_with_openvswitch_networking">Tap device with OVS</a></p>
<h1 id="Kernel-and-rootfs"><a href="#Kernel-and-rootfs" class="headerlink" title="Kernel and rootfs"></a>Kernel and rootfs</h1><h1 id="Change-vm-setting-runtime"><a href="#Change-vm-setting-runtime" class="headerlink" title="Change vm setting runtime"></a>Change vm setting runtime</h1><p>The QEMU Monitor Protocol (QMP) is a JSON-based protocol which allows applications to communicate with a QEMU instance. there are several ways to talk with QEMU instance.</p>
<ul>
<li>virsh&#x2F;libvirt way using ‘qemu-monitor-command’ which provided by virsh command</li>
<li>if qemu-instance is not started by libvirt or no virsh installed, talk with <code>qmp socket</code> directly.<ul>
<li>use <code>telnet, nc</code> over <code>tcp qmp socket</code> with json format</li>
<li>use <code>nc</code>, <code>socat over</code> <code>unix qmp socket</code> with json format, while <code>qemu-shell</code> with human way as it’s python tool that does json encode for you.</li>
</ul>
</li>
</ul>
<p><code>Same thing happens for HMP(human machine protocol) as well who creates monitor socket for talking.</code></p>
<p><strong>Qemu parameters</strong>  </p>
<ul>
<li>-monitor dev    redirect the monitor to char device ‘dev’, will create monitor socket.</li>
<li>-qmp dev        like -monitor but opens in ‘control’ mode, will create qmp socket. same with &#x3D;&#x3D; <code>-monitor chardev=mon0,mode=control</code></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ==================================QMP socket===================================================================================</span></span><br><span class="line"><span class="comment"># -qmp tcp:localhost:1234,server,nowait</span></span><br><span class="line">Same as below (qmp uses tcp socket)</span><br><span class="line"><span class="comment"># -chardev socket,id=mon0,host=localhost,port=1234,server,nowait -mon chardev=mon0,mode=control</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># qemu instance sends output with pretty json</span></span><br><span class="line"><span class="comment"># -chardev socket,id=mon0,host=localhost,port=1234,server,nowait -mon chardev=mon0,mode=control,pretty=on</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># qmp uses unix socket</span></span><br><span class="line"><span class="comment"># -qmp unix:/var/run/qmp.sock,server,nowait</span></span><br><span class="line">$ nc -U /var/run/qmp.sock </span><br><span class="line">&#123;<span class="string">&quot;QMP&quot;</span>: &#123;<span class="string">&quot;version&quot;</span>: &#123;<span class="string">&quot;qemu&quot;</span>: &#123;<span class="string">&quot;nano&quot;</span>: 1, <span class="string">&quot;micro&quot;</span>: 0, <span class="string">&quot;minor&quot;</span>: 9, <span class="string">&quot;major&quot;</span>: 2&#125;, <span class="string">&quot;package&quot;</span>: <span class="string">&quot; (-dirty)&quot;</span>&#125;, <span class="string">&quot;capabilities&quot;</span>: []&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># -chardev socket,id=mon0,path=/var/run/qmp.sock,server,nowait -mon chardev=mon0,id=monitor,mode=control</span></span><br><span class="line">$ nc -U /var/run/qmp.sock </span><br><span class="line">&#123;<span class="string">&quot;QMP&quot;</span>: &#123;<span class="string">&quot;version&quot;</span>: &#123;<span class="string">&quot;qemu&quot;</span>: &#123;<span class="string">&quot;nano&quot;</span>: 1, <span class="string">&quot;micro&quot;</span>: 0, <span class="string">&quot;minor&quot;</span>: 9, <span class="string">&quot;major&quot;</span>: 2&#125;, <span class="string">&quot;package&quot;</span>: <span class="string">&quot; (-dirty)&quot;</span>&#125;, <span class="string">&quot;capabilities&quot;</span>: []&#125;&#125;$</span><br><span class="line"></span><br><span class="line"><span class="comment"># ==================================Monitor socket===================================================================================</span></span><br><span class="line"><span class="comment"># -chardev socket,id=mon0,path=/var/run/monitor.sock,server,nowait -mon chardev=mon0,id=monitor</span></span><br><span class="line"><span class="comment"># if monitor with readline mode(default), only support human like command and output is formated</span></span><br><span class="line">$ nc -U /var/run/monitor.sock </span><br><span class="line">QEMU 2.9.0.1 monitor - <span class="built_in">type</span> <span class="string">&#x27;help&#x27;</span> <span class="keyword">for</span> more information</span><br><span class="line">(qemu) </span><br><span class="line">(qemu) info block</span><br><span class="line">info block</span><br><span class="line">ide1-cd0: [not inserted]</span><br><span class="line">    Removable device: not locked, tray closed</span><br><span class="line"></span><br><span class="line">floppy0: [not inserted]</span><br><span class="line">    Removable device: not locked, tray closed</span><br><span class="line"></span><br><span class="line">sd0: [not inserted]</span><br><span class="line">    Removable device: not locked, tray closed</span><br></pre></td></tr></table></figure>

<p><strong>NOTE</strong></p>
<ul>
<li>both sockets(if monitor in control mode) support QMP(json based) and HMP(human machine protocol), they proivde different commands for similiar purpose, </li>
<li>The outputs are different, QMP has more details and with json output, HMP is different.</li>
<li>if monitor socket with readline mode, only support human commands and output is formated.</li>
</ul>
<p><font color='red'><strong>Suggestion</strong></font></p>
<ul>
<li><p>With virsh&#x2F;libvirt</p>
<ul>
<li>Use <code>virsh qemu-monitor-command</code></li>
</ul>
</li>
<li><p>Without virsh&#x2F;libvirt</p>
<ul>
<li>For CLI troubleshooting only, run monitor socket with readline mode, provides man subcommands</li>
<li>For programable, run monitor socket with control mode, or qmp socket, but you still has tool like <code>qemu-shell</code> which proivdes CLI for user to use with man subcommands. <strong>qemu-shell similiar to qemu-monitor-command</strong></li>
</ul>
</li>
<li>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># without qmp-shell, when -nographic option is in use, you can switch between the monitor console </span></span><br><span class="line"><span class="comment"># by pressing Ctrl–a, then press c, back to console ctrl-a, then press c again.</span></span><br><span class="line">$ ./qmp-shell  /var/run/qmp.sock</span><br><span class="line">Welcome to the QMP low-level shell!</span><br><span class="line">Connected to QEMU 2.12.0</span><br><span class="line"></span><br><span class="line">(QEMU) query-block</span><br><span class="line">&#123;<span class="string">&quot;return&quot;</span>: [&#123;<span class="string">&quot;locked&quot;</span>: <span class="literal">false</span>, <span class="string">&quot;tray_open&quot;</span>: <span class="literal">false</span>, <span class="string">&quot;io-status&quot;</span>: <span class="string">&quot;ok&quot;</span>, <span class="string">&quot;qdev&quot;</span>: <span class="string">&quot;/machine/unattached/device[22]&quot;</span>, <span class="string">&quot;removable&quot;</span>: <span class="literal">true</span>, <span class="string">&quot;device&quot;</span>: <span class="string">&quot;ide1-cd0&quot;</span>, <span class="string">&quot;type&quot;</span>: <span class="string">&quot;unknown&quot;</span>&#125;, &#123;<span class="string">&quot;device&quot;</span>: <span class="string">&quot;floppy0&quot;</span>, <span class="string">&quot;type&quot;</span>: <span class="string">&quot;unknown&quot;</span>, <span class="string">&quot;qdev&quot;</span>: <span class="string">&quot;/machine/unattached/device[15]&quot;</span>, <span class="string">&quot;locked&quot;</span>: <span class="literal">false</span>, <span class="string">&quot;removable&quot;</span>: <span class="literal">true</span>&#125;, &#123;<span class="string">&quot;device&quot;</span>: <span class="string">&quot;sd0&quot;</span>, <span class="string">&quot;type&quot;</span>: <span class="string">&quot;unknown&quot;</span>, <span class="string">&quot;locked&quot;</span>: <span class="literal">false</span>, <span class="string">&quot;removable&quot;</span>: <span class="literal">true</span>&#125;]&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># HMP format</span></span><br><span class="line">$ ./qmp-shell -H /var/run/qmp.sock</span><br><span class="line">Welcome to the HMP shell!</span><br><span class="line">Connected to QEMU 2.12.0</span><br><span class="line"></span><br><span class="line">(QEMU) info block</span><br><span class="line">ide1-cd0: [not inserted]</span><br><span class="line">    Attached to:      /machine/unattached/device[22]</span><br><span class="line">    Removable device: not locked, tray closed</span><br><span class="line"></span><br><span class="line">floppy0: [not inserted]</span><br><span class="line">    Attached to:      /machine/unattached/device[15]</span><br><span class="line">    Removable device: not locked, tray closed</span><br><span class="line"></span><br><span class="line">sd0: [not inserted]</span><br><span class="line">    Removable device: not locked, tray closed</span><br><span class="line">(QEMU) </span><br><span class="line"></span><br><span class="line">$ ./qmp-shell -p /var/run/qmp.sock</span><br><span class="line">Welcome to the QMP low-level shell!</span><br><span class="line">Connected to QEMU 2.12.0</span><br><span class="line"></span><br><span class="line">(QEMU) query-block</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;return&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;locked&quot;</span>: <span class="literal">false</span>, </span><br><span class="line">            <span class="string">&quot;tray_open&quot;</span>: <span class="literal">false</span>, </span><br><span class="line">            <span class="string">&quot;io-status&quot;</span>: <span class="string">&quot;ok&quot;</span>, </span><br><span class="line">            <span class="string">&quot;qdev&quot;</span>: <span class="string">&quot;/machine/unattached/device[22]&quot;</span>, </span><br><span class="line">            <span class="string">&quot;removable&quot;</span>: <span class="literal">true</span>, </span><br><span class="line">            <span class="string">&quot;device&quot;</span>: <span class="string">&quot;ide1-cd0&quot;</span>, </span><br><span class="line">            <span class="string">&quot;type&quot;</span>: <span class="string">&quot;unknown&quot;</span></span><br><span class="line">        &#125;, </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;device&quot;</span>: <span class="string">&quot;floppy0&quot;</span>, </span><br><span class="line">            <span class="string">&quot;type&quot;</span>: <span class="string">&quot;unknown&quot;</span>, </span><br><span class="line">            <span class="string">&quot;qdev&quot;</span>: <span class="string">&quot;/machine/unattached/device[15]&quot;</span>, </span><br><span class="line">            <span class="string">&quot;locked&quot;</span>: <span class="literal">false</span>, </span><br><span class="line">            <span class="string">&quot;removable&quot;</span>: <span class="literal">true</span></span><br><span class="line">        &#125;, </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;device&quot;</span>: <span class="string">&quot;sd0&quot;</span>, </span><br><span class="line">            <span class="string">&quot;type&quot;</span>: <span class="string">&quot;unknown&quot;</span>, </span><br><span class="line">            <span class="string">&quot;locked&quot;</span>: <span class="literal">false</span>, </span><br><span class="line">            <span class="string">&quot;removable&quot;</span>: <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">(QEMU) </span><br></pre></td></tr></table></figure>
<h2 id="command-output"><a href="#command-output" class="headerlink" title="command output"></a>command output</h2><p>Most QMP commands</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">&quot;blockdev-add&quot;</span><br><span class="line">&quot;chardev-remove&quot;</span><br><span class="line">&quot;chardev-add&quot;</span><br><span class="line">&quot;query-cpu-definitions&quot;</span><br><span class="line">&quot;query-machines&quot;</span><br><span class="line">&quot;device-list-properties&quot;</span><br><span class="line">&quot;change-vnc-password&quot;</span><br><span class="line">&quot;nbd-server-stop&quot;</span><br><span class="line">&quot;nbd-server-add&quot;</span><br><span class="line">&quot;nbd-server-start&quot;</span><br><span class="line">&quot;query-block-jobs&quot;</span><br><span class="line">&quot;query-balloon&quot;</span><br><span class="line">&quot;query-migrate-capabilities&quot;</span><br><span class="line">&quot;migrate-set-capabilities&quot;</span><br><span class="line">&quot;query-migrate&quot;</span><br><span class="line">&quot;query-command-line-options&quot;</span><br><span class="line">&quot;query-uuid&quot;</span><br><span class="line">&quot;query-name&quot;</span><br><span class="line">&quot;query-spice&quot;</span><br><span class="line">&quot;query-vnc&quot;</span><br><span class="line">&quot;query-mice&quot;</span><br><span class="line">&quot;query-status&quot;</span><br><span class="line">&quot;query-kvm&quot;</span><br><span class="line">&quot;query-pci&quot;</span><br><span class="line">&quot;query-cpus&quot;</span><br><span class="line">&quot;query-blockstats&quot;</span><br><span class="line">&quot;query-block&quot;</span><br><span class="line">&quot;query-chardev&quot;</span><br><span class="line">&quot;query-events&quot;</span><br><span class="line">&quot;query-commands&quot;</span><br><span class="line">&quot;query-version&quot;</span><br><span class="line">&quot;human-monitor-command&quot;</span><br><span class="line">&quot;qmp_capabilities&quot;</span><br><span class="line">&quot;expire_password&quot;</span><br><span class="line">&quot;set_password&quot;</span><br><span class="line">&quot;block_set_io_throttle&quot;</span><br><span class="line">&quot;block_passwd&quot;</span><br><span class="line">&quot;query-fdsets&quot;</span><br><span class="line">&quot;remove-fd&quot;</span><br><span class="line">&quot;add-fd&quot;</span><br><span class="line">&quot;closefd&quot;</span><br><span class="line">&quot;getfd&quot;</span><br><span class="line">&quot;set_link&quot;</span><br><span class="line">&quot;balloon&quot;</span><br><span class="line">&quot;block_resize&quot;</span><br><span class="line">&quot;netdev_del&quot;</span><br><span class="line">&quot;netdev_add&quot;</span><br><span class="line">&quot;client_migrate_info&quot;</span><br><span class="line">&quot;migrate_set_downtime&quot;</span><br><span class="line">&quot;migrate_set_speed&quot;</span><br><span class="line">&quot;query-migrate-cache-size&quot;</span><br><span class="line">&quot;migrate-set-cache-size&quot;</span><br><span class="line">&quot;migrate_cancel&quot;</span><br><span class="line">&quot;migrate&quot;</span><br><span class="line">&quot;cpu-add&quot;</span><br><span class="line">&quot;cpu&quot;</span><br><span class="line">&quot;device_del&quot;</span><br><span class="line">&quot;device_add&quot;</span><br><span class="line">&quot;system_powerdown&quot;</span><br><span class="line">&quot;system_reset&quot;</span><br><span class="line">&quot;system_wakeup&quot;</span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>QMP by virsh qemu-monitor-command</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 6095 is domain id</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># HMP protocol</span></span><br><span class="line">$ virsh qemu-monitor-command –hmp 6095 info block</span><br><span class="line">drive-virtio-disk0: removable=0 file=/export/jvirt/jcs-agent/instances/i-sm6pxr4068/vda backing_file=/export/jvirt/jcs-agent/instances/_base/img-8sdjnj4qbq backing_file_depth=1 ro=0 drv=qcow2 encrypted=0 bps=0 bps_rd=0 bps_wr=0 iops=0 iops_rd=0 iops_wr=0</span><br><span class="line"></span><br><span class="line"><span class="comment"># QMP protocol --pretty means format json output</span></span><br><span class="line">$ virsh qemu-monitor-command  6095 --pretty <span class="string">&#x27;&#123; &quot;execute&quot;: &quot;query-block&quot;&#125;&#x27;</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;return&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;device&quot;</span>: <span class="string">&quot;drive-virtio-disk0&quot;</span>,</span><br><span class="line">      <span class="string">&quot;locked&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="string">&quot;removable&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="string">&quot;inserted&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;iops_rd&quot;</span>: 0,</span><br><span class="line">        <span class="string">&quot;image&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;backing-image&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;virtual-size&quot;</span>: 42949672960,</span><br><span class="line">            <span class="string">&quot;filename&quot;</span>: <span class="string">&quot;/export/jvirt/jcs-agent/instances/_base/img-8sdjnj4qbq&quot;</span>,</span><br><span class="line">            <span class="string">&quot;cluster-size&quot;</span>: 65536,</span><br><span class="line">            <span class="string">&quot;format&quot;</span>: <span class="string">&quot;qcow2&quot;</span>,</span><br><span class="line">            <span class="string">&quot;actual-size&quot;</span>: 24866193408,</span><br><span class="line">            <span class="string">&quot;format-specific&quot;</span>: &#123;</span><br><span class="line">              <span class="string">&quot;type&quot;</span>: <span class="string">&quot;qcow2&quot;</span>,</span><br><span class="line">              <span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;compat&quot;</span>: <span class="string">&quot;1.1&quot;</span>,</span><br><span class="line">                <span class="string">&quot;lazy-refcounts&quot;</span>: <span class="literal">false</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;dirty-flag&quot;</span>: <span class="literal">false</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">&quot;virtual-size&quot;</span>: 42949672960,</span><br><span class="line">          <span class="string">&quot;filename&quot;</span>: <span class="string">&quot;/export/jvirt/jcs-agent/instances/i-sm6pxr4068/vda&quot;</span>,</span><br><span class="line">          <span class="string">&quot;cluster-size&quot;</span>: 65536,</span><br><span class="line">          <span class="string">&quot;format&quot;</span>: <span class="string">&quot;qcow2&quot;</span>,</span><br><span class="line">          <span class="string">&quot;actual-size&quot;</span>: 21068431360,</span><br><span class="line">          <span class="string">&quot;format-specific&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;type&quot;</span>: <span class="string">&quot;qcow2&quot;</span>,</span><br><span class="line">            <span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">              <span class="string">&quot;compat&quot;</span>: <span class="string">&quot;1.1&quot;</span>,</span><br><span class="line">              <span class="string">&quot;lazy-refcounts&quot;</span>: <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">&quot;backing-filename&quot;</span>: <span class="string">&quot;/export/jvirt/jcs-agent/instances/_base/img-8sdjnj4qbq&quot;</span>,</span><br><span class="line">          <span class="string">&quot;dirty-flag&quot;</span>: <span class="literal">false</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;iops_wr&quot;</span>: 0,</span><br><span class="line">        <span class="string">&quot;ro&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;backing_file_depth&quot;</span>: 1,</span><br><span class="line">        <span class="string">&quot;drv&quot;</span>: <span class="string">&quot;qcow2&quot;</span>,</span><br><span class="line">        <span class="string">&quot;iops&quot;</span>: 0,</span><br><span class="line">        <span class="string">&quot;bps_wr&quot;</span>: 0,</span><br><span class="line">        <span class="string">&quot;backing_file&quot;</span>: <span class="string">&quot;/export/jvirt/jcs-agent/instances/_base/img-8sdjnj4qbq&quot;</span>,</span><br><span class="line">        <span class="string">&quot;encrypted&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;bps&quot;</span>: 0,</span><br><span class="line">        <span class="string">&quot;bps_rd&quot;</span>: 0,</span><br><span class="line">        <span class="string">&quot;file&quot;</span>: <span class="string">&quot;/export/jvirt/jcs-agent/instances/i-sm6pxr4068/vda&quot;</span>,</span><br><span class="line">        <span class="string">&quot;encryption_key_missing&quot;</span>: <span class="literal">false</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;type&quot;</span>: <span class="string">&quot;unknown&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;id&quot;</span>: <span class="string">&quot;libvirt-8302918&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>QMP over tcp socket</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># run your qemu instance:   -qmp tcp:127.0.0.1:12345,server,nowait</span></span><br><span class="line">$ /usr/libexec/qemu-kvm  -kernel ./kernel -initrd ./initramfs.img -nographic -append <span class="string">&quot;console=ttyS0&quot;</span> -qmp tcp:127.0.0.1:12345,server,nowait -serial mon:stdio</span><br><span class="line"></span><br><span class="line">[root@dev jason]<span class="comment"># nc localhost 12345</span></span><br><span class="line">&#123;<span class="string">&quot;QMP&quot;</span>: &#123;<span class="string">&quot;version&quot;</span>: &#123;<span class="string">&quot;qemu&quot;</span>: &#123;<span class="string">&quot;nano&quot;</span>: 1, <span class="string">&quot;micro&quot;</span>: 0, <span class="string">&quot;minor&quot;</span>: 9, <span class="string">&quot;major&quot;</span>: 2&#125;, <span class="string">&quot;package&quot;</span>: <span class="string">&quot; (-dirty)&quot;</span>&#125;, <span class="string">&quot;capabilities&quot;</span>: []&#125;&#125;</span><br><span class="line">&#123; <span class="string">&quot;execute&quot;</span>: <span class="string">&quot;qmp_capabilities&quot;</span> &#125; <span class="comment"># must run this firstly</span></span><br><span class="line">&#123;<span class="string">&quot;return&quot;</span>: &#123;&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># HMP</span></span><br><span class="line">&#123;<span class="string">&quot;execute&quot;</span>: <span class="string">&quot;human-monitor-command&quot;</span>, <span class="string">&quot;arguments&quot;</span>: &#123;<span class="string">&quot;command-line&quot;</span>: <span class="string">&quot;info block&quot;</span>&#125;&#125;</span><br><span class="line">&#123;<span class="string">&quot;return&quot;</span>: <span class="string">&quot;ide1-cd0: [not inserted]\r\n    Removable device: not locked, tray closed\r\n\r\nfloppy0: [not inserted]\r\n    Removable device: not locked, tray closed\r\n\r\nsd0: [not inserted]\r\n    Removable device: not locked, tray closed\r\n&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># QMP</span></span><br><span class="line">&#123;<span class="string">&quot;execute&quot;</span>: <span class="string">&quot;query-block&quot;</span>&#125;</span><br><span class="line">&#123;<span class="string">&quot;return&quot;</span>: [&#123;<span class="string">&quot;io-status&quot;</span>: <span class="string">&quot;ok&quot;</span>, <span class="string">&quot;device&quot;</span>: <span class="string">&quot;ide1-cd0&quot;</span>, <span class="string">&quot;locked&quot;</span>: <span class="literal">false</span>, <span class="string">&quot;removable&quot;</span>: <span class="literal">true</span>, <span class="string">&quot;tray_open&quot;</span>: <span class="literal">false</span>, <span class="string">&quot;type&quot;</span>: <span class="string">&quot;unknown&quot;</span>&#125;, &#123;<span class="string">&quot;device&quot;</span>: <span class="string">&quot;floppy0&quot;</span>, <span class="string">&quot;locked&quot;</span>: <span class="literal">false</span>, <span class="string">&quot;removable&quot;</span>: <span class="literal">true</span>, <span class="string">&quot;type&quot;</span>: <span class="string">&quot;unknown&quot;</span>&#125;, &#123;<span class="string">&quot;device&quot;</span>: <span class="string">&quot;sd0&quot;</span>, <span class="string">&quot;locked&quot;</span>: <span class="literal">false</span>, <span class="string">&quot;removable&quot;</span>: <span class="literal">true</span>, <span class="string">&quot;type&quot;</span>: <span class="string">&quot;unknown&quot;</span>&#125;]&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ctrl +C</span><br><span class="line"></span><br><span class="line">[root@dev jason]<span class="comment"># telnet 127.0.0.1 12345</span></span><br><span class="line">Trying 127.0.0.1...</span><br><span class="line">Connected to 127.0.0.1.</span><br><span class="line">Escape character is <span class="string">&#x27;^]&#x27;</span>.</span><br><span class="line">&#123;<span class="string">&quot;QMP&quot;</span>: &#123;<span class="string">&quot;version&quot;</span>: &#123;<span class="string">&quot;qemu&quot;</span>: &#123;<span class="string">&quot;nano&quot;</span>: 1, <span class="string">&quot;micro&quot;</span>: 0, <span class="string">&quot;minor&quot;</span>: 9, <span class="string">&quot;major&quot;</span>: 2&#125;, <span class="string">&quot;package&quot;</span>: <span class="string">&quot; (-dirty)&quot;</span>&#125;, <span class="string">&quot;capabilities&quot;</span>: []&#125;&#125;</span><br><span class="line">&#123; <span class="string">&quot;execute&quot;</span>: <span class="string">&quot;qmp_capabilities&quot;</span> &#125; <span class="comment"># must run this firstly</span></span><br><span class="line">&#123;<span class="string">&quot;return&quot;</span>: &#123;&#125;&#125;</span><br><span class="line">&#123; <span class="string">&quot;execute&quot;</span>: <span class="string">&quot;query-commands&quot;</span> &#125; <span class="comment"># check all QMP commands support</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># HMP</span></span><br><span class="line">&#123;<span class="string">&quot;execute&quot;</span>: <span class="string">&quot;human-monitor-command&quot;</span>, <span class="string">&quot;arguments&quot;</span>: &#123;<span class="string">&quot;command-line&quot;</span>: <span class="string">&quot;info block&quot;</span>&#125;&#125;</span><br><span class="line">&#123;<span class="string">&quot;return&quot;</span>: <span class="string">&quot;ide1-cd0: [not inserted]\r\n    Removable device: not locked, tray closed\r\n\r\nfloppy0: [not inserted]\r\n    Removable device: not locked, tray closed\r\n\r\nsd0: [not inserted]\r\n    Removable device: not locked, tray closed\r\n&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># QMP</span></span><br><span class="line">&#123;<span class="string">&quot;execute&quot;</span>: <span class="string">&quot;query-block&quot;</span>&#125;</span><br><span class="line">&#123;<span class="string">&quot;return&quot;</span>: [&#123;<span class="string">&quot;io-status&quot;</span>: <span class="string">&quot;ok&quot;</span>, <span class="string">&quot;device&quot;</span>: <span class="string">&quot;ide1-cd0&quot;</span>, <span class="string">&quot;locked&quot;</span>: <span class="literal">false</span>, <span class="string">&quot;removable&quot;</span>: <span class="literal">true</span>, <span class="string">&quot;tray_open&quot;</span>: <span class="literal">false</span>, <span class="string">&quot;type&quot;</span>: <span class="string">&quot;unknown&quot;</span>&#125;, &#123;<span class="string">&quot;device&quot;</span>: <span class="string">&quot;floppy0&quot;</span>, <span class="string">&quot;locked&quot;</span>: <span class="literal">false</span>, <span class="string">&quot;removable&quot;</span>: <span class="literal">true</span>, <span class="string">&quot;type&quot;</span>: <span class="string">&quot;unknown&quot;</span>&#125;, &#123;<span class="string">&quot;device&quot;</span>: <span class="string">&quot;sd0&quot;</span>, <span class="string">&quot;locked&quot;</span>: <span class="literal">false</span>, <span class="string">&quot;removable&quot;</span>: <span class="literal">true</span>, <span class="string">&quot;type&quot;</span>: <span class="string">&quot;unknown&quot;</span>&#125;]&#125;</span><br><span class="line"></span><br><span class="line">ctrl + &#125;</span><br><span class="line">telnet&gt;quit</span><br></pre></td></tr></table></figure>

<p><strong>QMP over unix socket</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ /usr/libexec/qemu-kvm  -kernel ./kernel -initrd ./initramfs.img -nographic -append <span class="string">&quot;console=ttyS0&quot;</span>  -qmp unix:/var/run/qmp.sock,server,nowait -serial mon:stdio</span><br><span class="line">$ nc -U /var/run/qmp.sock</span><br><span class="line">&#123;<span class="string">&quot;QMP&quot;</span>: &#123;<span class="string">&quot;version&quot;</span>: &#123;<span class="string">&quot;qemu&quot;</span>: &#123;<span class="string">&quot;nano&quot;</span>: 1, <span class="string">&quot;micro&quot;</span>: 0, <span class="string">&quot;minor&quot;</span>: 9, <span class="string">&quot;major&quot;</span>: 2&#125;, <span class="string">&quot;package&quot;</span>: <span class="string">&quot; (-dirty)&quot;</span>&#125;, <span class="string">&quot;capabilities&quot;</span>: []&#125;&#125;</span><br><span class="line">&#123; <span class="string">&quot;execute&quot;</span>: <span class="string">&quot;qmp_capabilities&quot;</span> &#125; <span class="comment"># must run this firstly</span></span><br><span class="line">&#123;<span class="string">&quot;return&quot;</span>: &#123;&#125;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># HMP</span></span><br><span class="line">&#123;<span class="string">&quot;execute&quot;</span>: <span class="string">&quot;human-monitor-command&quot;</span>, <span class="string">&quot;arguments&quot;</span>: &#123;<span class="string">&quot;command-line&quot;</span>: <span class="string">&quot;info block&quot;</span>&#125;&#125;</span><br><span class="line">&#123;<span class="string">&quot;return&quot;</span>: <span class="string">&quot;ide1-cd0: [not inserted]\r\n    Removable device: not locked, tray closed\r\n\r\nfloppy0: [not inserted]\r\n    Removable device: not locked, tray closed\r\n\r\nsd0: [not inserted]\r\n    Removable device: not locked, tray closed\r\n&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<h1 id="disk-image"><a href="#disk-image" class="headerlink" title="disk image"></a>disk image</h1><p>Different hypervisor softwares uses different image format, here is a list of them.</p>
<ul>
<li><p><code>VDI is the native format of VirtualBox</code>. Other virtualization software generally don’t support VDI</p>
</li>
<li><p><code>VMDK is developed by and for VMWare</code>, but <strong>VirtualBox also support it</strong>. <font color='red'>This format might be the the best choice for you because you want wide compatibility with other virtualization software. it has smaller disk size than qcow2</font></p>
</li>
<li><p><code>VHD is the native format of Microsoft Virtual PC</code>. Windows Server <code>2012 introduced VHDX as the successor to VHD</code>, but VirtualBox does not support VHDX.</p>
</li>
<li><p><code>QCOW is the old original version of the qcow format</code>. It has been <code>superseded by qcow2</code>, which VirtualBox does not support.</p>
</li>
<li><p><code>QED was an abandoned enhancement of qcow2</code>. QEMU advises against using QED(not use it).</p>
</li>
</ul>
<p><strong>qemu-img is a tool which supports converting from one image format to another. if you want to run VM between hypervisors</strong></p>
<h2 id="Operation"><a href="#Operation" class="headerlink" title="Operation"></a>Operation</h2><p>qemu-img allows you to <code>create, convert and modify images offline</code>. It can handle all image formats supported by QEMU</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">$ qemu-img create -f qcow2 /var/lib/libvirt/images/disk1.img 10G</span><br><span class="line"></span><br><span class="line"><span class="comment"># Raw type: Raw disk image format is default. This format has the advantage of being simple and easily exportable to all other emulators</span></span><br><span class="line">$ <span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=/var/lib/libvirt/images/disk1.img bs=2M count=5120 status=progress</span><br><span class="line">$ qemu-img create -f raw /var/lib/libvirt/images/disk1.img 10G</span><br><span class="line">$ qemu-img info /var/lib/libvirt/images/disk1.img</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># vhd to qcow2</span></span><br><span class="line">$ qemu-img convert -p -f vpc -O qcow2 centos6.9.vhd centos6.9.qcow2</span><br><span class="line"></span><br><span class="line"><span class="comment"># vmdk to qcow</span></span><br><span class="line">$ qemu-img convert -p -f vmdk -O qcow2 centos6.9.vmdk centos6.9.qcow2</span><br><span class="line"></span><br><span class="line"><span class="comment"># resize a disk, add 3G to guest disk</span></span><br><span class="line"><span class="comment"># Can&#x27;t resize an image which has snapshots</span></span><br><span class="line"><span class="comment"># Note the new 3G is not seen by guest right now you have to create partition on it using parted command</span></span><br><span class="line">$ qemu-img resize data.qcow2 +3G</span><br><span class="line"></span><br><span class="line"><span class="comment"># shrink the free space(not used, unallocated in guest)</span></span><br><span class="line">$ qemu-img resize --shrink data.qcow2 -3G</span><br><span class="line"></span><br><span class="line"><span class="comment"># to 100G</span></span><br><span class="line">$ qemu-img resize data.qcow2 100G</span><br><span class="line"></span><br><span class="line">$ qemu-img info data.qcow2</span><br><span class="line"></span><br><span class="line"><span class="comment"># create snapshots of image(snapshot stores in image itself)</span></span><br><span class="line">$ qemu-img snapshot -c org CentOS-7-x86_64-GenericCloud.qcow2</span><br><span class="line"></span><br><span class="line"><span class="comment"># show snapshots of image</span></span><br><span class="line">$ qemu-img snapshot -l CentOS-7-x86_64-GenericCloud.qcow2 </span><br><span class="line">Snapshot list:</span><br><span class="line">ID        TAG                 VM SIZE                DATE       VM CLOCK</span><br><span class="line">1         1646107061             268M 2022-03-01 11:57:41   00:15:03.857</span><br><span class="line">2         1646107194             268M 2022-03-01 11:59:54   00:17:14.997</span><br><span class="line"></span><br><span class="line"><span class="comment"># delete snapshots with given ID</span></span><br><span class="line">$ qemu-img snapshot -d  1  CentOS-7-x86_64-GenericCloud.qcow2</span><br></pre></td></tr></table></figure>

<p><strong>NOTE: make sure make a copy of disk before operation</strong></p>
<h2 id="backing-file-qcow2"><a href="#backing-file-qcow2" class="headerlink" title="backing file(qcow2)"></a>backing file(qcow2)</h2><p>In essence, QCOW2(Qemu <code>Copy-On-Write</code>) gives you an ability to create a base-image, and create several ‘disposable’ copy-on-write overlay disk images on top of <code>the base image(also called backing file)</code>. Backing files and overlays are extremely useful to rapidly instantiate thin-privisoned virtual machines(more on it below). Especially quite useful in development &amp; test environments, so that one could quickly <code>revert to a known state &amp; discard the overlay</code>. It can also be used to <code>start 100 virtual machines from a common backing image, thus saving space</code>.</p>
<p><strong>use case</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">.--------------.    .-------------.    .-------------.    .-------------.</span><br><span class="line">|              |    |             |    |             |    |             |</span><br><span class="line">| RootBase     |&lt;---| Overlay-1   |&lt;---| Overlay-1A  &lt;--- | Overlay-1B  |</span><br><span class="line">| (raw/qcow2)  |    | (qcow2)     |    | (qcow2)     |    | (qcow2)     |</span><br><span class="line">&#x27;--------------&#x27;    &#x27;-------------&#x27;    &#x27;-------------&#x27;    &#x27;-------------&#x27;</span><br><span class="line"></span><br><span class="line">The above figure illustrates - RootBase is the backing file for Overlay-1, which in turn is backing file for Overlay-2, which in turn is backing file for Overlay-3.</span><br><span class="line"></span><br><span class="line">.-----------.   .-----------.   .------------.  .------------.  .------------.</span><br><span class="line">|           |   |           |   |            |  |            |  |            |</span><br><span class="line">| RootBase  |&lt;--- Overlay-1 |&lt;--- Overlay-1A &lt;--- Overlay-1B &lt;--- Overlay-1C |</span><br><span class="line">|           |   |           |   |            |  |            |  | (Active)   |</span><br><span class="line">&#x27;-----------&#x27;   &#x27;-----------&#x27;   &#x27;------------&#x27;  &#x27;------------&#x27;  &#x27;------------&#x27;</span><br><span class="line">   ^    ^</span><br><span class="line">   |    |</span><br><span class="line">   |    |       .-----------.    .------------.</span><br><span class="line">   |    |       |           |    |            |</span><br><span class="line">   |    &#x27;-------| Overlay-2 |&lt;---| Overlay-2A |</span><br><span class="line">   |            |           |    | (Active)   |</span><br><span class="line">   |            &#x27;-----------&#x27;    &#x27;------------&#x27;</span><br><span class="line">   |</span><br><span class="line">   |</span><br><span class="line">   |            .-----------.    .------------.</span><br><span class="line">   |            |           |    |            |</span><br><span class="line">   &#x27;------------| Overlay-3 |&lt;---| Overlay-3A |</span><br><span class="line">                |           |    | (Active)   |</span><br><span class="line">                &#x27;-----------&#x27;    &#x27;------------&#x27;</span><br><span class="line"></span><br><span class="line">The above figure is just another representation which indicates, we can use a &#x27;single&#x27; backing file, and create several overlays -- which can be used further, to create overlays on top of them.</span><br><span class="line"></span><br><span class="line">NOTE: Backing files are always opened read-only. In other words, once an overlay is created, its backing file should not be modified(as the overlay depends on a particular state of the backing file)</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># base &lt;- sn1 &lt;- sn2 &lt;- sn3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># create sn1</span></span><br><span class="line">$ qemu-img create -b /home/data/tmp/base.img -f qcow2 /home/data/tmp/sn1.qcow2</span><br><span class="line">$ qemu-img info /home/data/tmp/sn1.qcow2</span><br><span class="line">qemu-img info /home/data/tmp/sn1.qcow2</span><br><span class="line">image: /home/data/tmp/sn1.qcow2</span><br><span class="line">file format: qcow2</span><br><span class="line">virtual size: 25G (26843545600 bytes)</span><br><span class="line">disk size: 196K</span><br><span class="line">cluster_size: 65536</span><br><span class="line">backing file: /home/data/tmp/base.img</span><br><span class="line">Format specific information:</span><br><span class="line">    compat: 1.1</span><br><span class="line">    lazy refcounts: <span class="literal">false</span></span><br><span class="line">    refcount bits: 16</span><br><span class="line">    corrupt: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># create sn2</span></span><br><span class="line">$ qemu-img create -b /home/data/tmp/sn1.qcow2 -f qcow2 /home/data/tmp/sn2.qcow2</span><br><span class="line">$ qemu-img info /home/data/tmp/sn2.qcow2</span><br><span class="line">image: /home/data/tmp/sn2.qcow2</span><br><span class="line">file format: qcow2</span><br><span class="line">virtual size: 25G (26843545600 bytes)</span><br><span class="line">disk size: 196K</span><br><span class="line">cluster_size: 65536</span><br><span class="line">backing file: /home/data/tmp/sn1.qcow2</span><br><span class="line">Format specific information:</span><br><span class="line">    compat: 1.1</span><br><span class="line">    lazy refcounts: <span class="literal">false</span></span><br><span class="line">    refcount bits: 16</span><br><span class="line">    corrupt: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># create sn3</span></span><br><span class="line">$ qemu-img create -b /home/data/tmp/sn2.qcow2 -f qcow2 /home/data/tmp/sn3.qcow2</span><br><span class="line">$ qemu-img info /home/data/tmp/sn3.qcow2</span><br><span class="line">image: /home/data/tmp/sn3.qcow2</span><br><span class="line">file format: qcow2</span><br><span class="line">virtual size: 25G (26843545600 bytes)</span><br><span class="line">disk size: 196K</span><br><span class="line">cluster_size: 65536</span><br><span class="line">backing file: /home/data/tmp/sn2.qcow2</span><br><span class="line">Format specific information:</span><br><span class="line">    compat: 1.1</span><br><span class="line">    lazy refcounts: <span class="literal">false</span></span><br><span class="line">    refcount bits: 16</span><br><span class="line">    corrupt: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># an entire backing chain can be recursively </span></span><br><span class="line">$ qemu-img info --backing-chain /home/data/tmp/sn3.qcow2</span><br><span class="line">image: /home/data/tmp/sn3.qcow2</span><br><span class="line">file format: qcow2</span><br><span class="line">virtual size: 25G (26843545600 bytes)</span><br><span class="line">disk size: 196K</span><br><span class="line">cluster_size: 65536</span><br><span class="line">backing file: /home/data/tmp/sn2.qcow2</span><br><span class="line">Format specific information:</span><br><span class="line">    compat: 1.1</span><br><span class="line">    lazy refcounts: <span class="literal">false</span></span><br><span class="line">    refcount bits: 16</span><br><span class="line">    corrupt: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">image: /home/data/tmp/sn2.qcow2</span><br><span class="line">file format: qcow2</span><br><span class="line">virtual size: 25G (26843545600 bytes)</span><br><span class="line">disk size: 196K</span><br><span class="line">cluster_size: 65536</span><br><span class="line">backing file: /home/data/tmp/sn1.qcow2</span><br><span class="line">Format specific information:</span><br><span class="line">    compat: 1.1</span><br><span class="line">    lazy refcounts: <span class="literal">false</span></span><br><span class="line">    refcount bits: 16</span><br><span class="line">    corrupt: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">image: /home/data/tmp/sn1.qcow2</span><br><span class="line">file format: qcow2</span><br><span class="line">virtual size: 25G (26843545600 bytes)</span><br><span class="line">disk size: 196K</span><br><span class="line">cluster_size: 65536</span><br><span class="line">backing file: /home/data/tmp/base.img</span><br><span class="line">Format specific information:</span><br><span class="line">    compat: 1.1</span><br><span class="line">    lazy refcounts: <span class="literal">false</span></span><br><span class="line">    refcount bits: 16</span><br><span class="line">    corrupt: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">image: /home/data/tmp/base.img</span><br><span class="line">file format: raw</span><br><span class="line">virtual size: 25G (26843545600 bytes)</span><br><span class="line">disk size: 16M</span><br><span class="line"></span><br><span class="line"><span class="comment"># size of overlays is smaller!!!</span></span><br><span class="line">$ <span class="built_in">ls</span>  -alh sn*.qcow2</span><br><span class="line">-rw-r--r-- 1 root root 193K Aug  2 16:38 sn1.qcow2</span><br><span class="line">-rw-r--r-- 1 root root 193K Aug  2 16:39 sn2.qcow2</span><br><span class="line">-rw-r--r-- 1 root root 193K Aug  2 16:39 sn3.qcow2</span><br><span class="line"></span><br><span class="line"><span class="comment"># merge sn2 with sn1(commit sn2 changes to sn1)</span></span><br><span class="line">$ qemu-img commit /home/data/tmp/sn2.qcow2</span><br><span class="line">$ qemu-img rebase -u -b /home/data/tmp/sn1.qcow2 /home/data/tmp/sn3.qcow2</span><br><span class="line"><span class="comment"># we need to rebase sn3 as before it points to sn2 as backing file!!!</span></span><br><span class="line"></span><br><span class="line">$ qemu-img info --backing-chain /home/data/tmp/sn3.qcow2</span><br><span class="line">image: /home/data/tmp/sn3.qcow2</span><br><span class="line">file format: qcow2</span><br><span class="line">virtual size: 25G (26843545600 bytes)</span><br><span class="line">disk size: 196K</span><br><span class="line">cluster_size: 65536</span><br><span class="line">backing file: /home/data/tmp/sn1.qcow2</span><br><span class="line">Format specific information:</span><br><span class="line">    compat: 1.1</span><br><span class="line">    lazy refcounts: <span class="literal">false</span></span><br><span class="line">    refcount bits: 16</span><br><span class="line">    corrupt: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">image: /home/data/tmp/sn1.qcow2</span><br><span class="line">file format: qcow2</span><br><span class="line">virtual size: 25G (26843545600 bytes)</span><br><span class="line">disk size: 196K</span><br><span class="line">cluster_size: 65536</span><br><span class="line">backing file: /home/data/tmp/base.img</span><br><span class="line">Format specific information:</span><br><span class="line">    compat: 1.1</span><br><span class="line">    lazy refcounts: <span class="literal">false</span></span><br><span class="line">    refcount bits: 16</span><br><span class="line">    corrupt: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">image: /home/data/tmp/base.img</span><br><span class="line">file format: raw</span><br><span class="line">virtual size: 25G (26843545600 bytes)</span><br><span class="line">disk size: 16M</span><br></pre></td></tr></table></figure>

<h1 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h1><h2 id="Boot-with-disk-x2F-diskless"><a href="#Boot-with-disk-x2F-diskless" class="headerlink" title="Boot with disk&#x2F;diskless"></a>Boot with disk&#x2F;diskless</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># root filesystem is in an ext2 &quot;hard disk&quot;</span></span><br><span class="line">$ /usr/libexec/qemu-kvm -kernel normal/bzImage -drive file=rootfs.ext2</span><br><span class="line"></span><br><span class="line"><span class="comment"># root filesystem is in initramfs</span></span><br><span class="line">$ /usr/libexec/qemu-kvm -kernel normal/bzImage -initrd initramfs.img</span><br><span class="line"><span class="comment"># full command to run</span></span><br><span class="line">$ /usr/libexec/qemu-kvm  -kernel normal/bzImage -initrd initramfs.img -nographic -append <span class="string">&quot;console=ttyS0&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># root filesystem is built in kernel</span></span><br><span class="line">$ /usr/libexec/qemu-kvm -kernel with_initramfs/bzImage</span><br><span class="line"><span class="comment"># Neither -drive nor -initrd are given.</span></span><br><span class="line"><span class="comment"># with_initramfs/bzImage is a kernel compiled with options identical to normal/bzImage, except for one: CONFIG_INITRAMFS_SOURCE=initramfs.img pointing to the exact same CPIO as from the -initrd example.</span></span><br></pre></td></tr></table></figure>

<h2 id="how-to-terminate-qemu-process-from-console"><a href="#how-to-terminate-qemu-process-from-console" class="headerlink" title="how to terminate qemu process from console"></a>how to terminate qemu process from console</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># must have  -serial mon:stdio, otherwise Ctrl+A, then `X` not working</span></span><br><span class="line">$ /usr/libexec/qemu-kvm  -kernel ./kernel -initrd ./initramfs.img -nographic -append <span class="string">&quot;console=ttyS0&quot;</span>  -qmp unix:/var/run/qmp.sock,server,nowait -serial mon:stdio</span><br></pre></td></tr></table></figure>
<ul>
<li><code>Ctrl + A</code>, then press <code>X</code></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ virt-install --boot kernel=./kernel,initrd=./initramfs.img,kernel_args=<span class="string">&quot;console=ttyS0,115200n8&quot;</span> --name <span class="variable">$VM_NAME</span> --memory 500 --vcpus 1 --disk none --os-type linux --graphics none --network default</span><br></pre></td></tr></table></figure>
<ul>
<li><code>Ctrl + ]</code> to quit virt-install</li>
</ul>
<h2 id="how-to-start-qemu-with-vnc"><a href="#how-to-start-qemu-with-vnc" class="headerlink" title="how to start qemu with vnc"></a>how to start qemu with vnc</h2><p>Add vnc parameter with specified ID, qemu-process will listen on particular port <code>as for vnc id 0==5900</code>, so id 88 means qemu-process will listen on 5988.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">id</span>=88</span><br><span class="line">$ /usr/libexec/qemu-kvm  -kernel ./kernel -initrd ./initramfs.img -nographic -append <span class="string">&quot;console=ttyS0&quot;</span>  -qmp unix:/var/run/qmp.sock,server,nowait -serial mon:stdio -vnc 0.0.0.0:<span class="variable">$id</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># OR let qemu select the vnc port automatically</span></span><br><span class="line">$ /usr/libexec/qemu-kvm  -kernel ./kernel -initrd ./initramfs.img -nographic -append <span class="string">&quot;console=ttyS0&quot;</span>  -qmp unix:/var/run/qmp.sock,server,nowait -serial mon:stdio -vnc 0.0.0.0</span><br><span class="line"></span><br><span class="line">$ netstat -nltp | grep kvm</span><br><span class="line">5:tcp        0      0 0.0.0.0:5988            0.0.0.0:*               LISTEN      8566/qemu-kvm  </span><br></pre></td></tr></table></figure>

<h2 id="how-to-mount-raw-disk"><a href="#how-to-mount-raw-disk" class="headerlink" title="how to mount raw disk"></a>how to mount raw disk</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># create raw disk by dd or qemu-img create</span></span><br><span class="line">$ <span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=disk.raw bs=1024k seek=25600 count=0</span><br><span class="line"></span><br><span class="line"><span class="comment"># check disk info (type) etc</span></span><br><span class="line">$ qemu-img info disk.raw</span><br><span class="line">image: disk.raw</span><br><span class="line">file format: raw</span><br><span class="line">virtual size: 25G (26843545600 bytes)</span><br><span class="line">disk size: 13M</span><br><span class="line"></span><br><span class="line"><span class="comment"># format with xfs</span></span><br><span class="line">$ mkfs.xfs disk.raw</span><br><span class="line"></span><br><span class="line">$ blkid disk.raw</span><br><span class="line">disk.raw: UUID=<span class="string">&quot;aa26d14d-267f-477b-b1a1-3848c448a0b3&quot;</span> TYPE=<span class="string">&quot;xfs&quot;</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">########################################### mount raw disk ######################</span></span><br><span class="line"><span class="comment"># make disk image as a block device!!!</span></span><br><span class="line"><span class="comment"># The -f option will search for the next free loop device to attach the image to. </span></span><br><span class="line"><span class="comment"># The -P option will trigger a scan for partitions on the attached image and create devices for each partition detected</span></span><br><span class="line"><span class="comment"># losetup only supports raw disk, not qcow2</span></span><br><span class="line"><span class="comment">#================ one way ====================================</span></span><br><span class="line">$ losetup -f -P disk.raw</span><br><span class="line">$ losetup -l</span><br><span class="line">NAME       SIZELIMIT OFFSET AUTOCLEAR RO BACK-FILE</span><br><span class="line">/dev/loop0         0      0         0  0 /root/jason/disk.raw</span><br><span class="line"></span><br><span class="line"><span class="comment"># mount block device to a dir, then we can access its files</span></span><br><span class="line">$ mount /dev/loop0  /tmp/raw</span><br><span class="line"></span><br><span class="line"><span class="comment">#================ another way ====================================</span></span><br><span class="line">$ mount -t xfs disk.raw /mnt/disk</span><br></pre></td></tr></table></figure>

<h2 id="after-enter-qmp-command-no-output"><a href="#after-enter-qmp-command-no-output" class="headerlink" title="after enter qmp command, no output"></a>after enter qmp command, no output</h2><p>This is probably, qmp.sock is connected with another client, as one qmp.sock can only talk with only on client!!!, if multiple clients want to connect with qemu instance, create multiple qmp socks when start qemu instance like this</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ /usr/libexec/qemu-kvm  -kernel ./kernel -initrd ./initramfs.img -nographic -append <span class="string">&quot;console=ttyS0&quot;</span>  -qmp unix:/var/run/qmp1.sock,server,nowait  -qmp unix:/var/run/qmp2.sock,server,nowait -serial mon:stdio</span><br></pre></td></tr></table></figure>

<h2 id="difference-between-net-netdev-and-nic"><a href="#difference-between-net-netdev-and-nic" class="headerlink" title="difference between -net, -netdev and -nic"></a>difference between -net, -netdev and -nic</h2><p>In short, the <strong>-net is the legacy option</strong>, while -netdev comes in to solve issue present for -net, the <code>newest way -nic from 2.12 is easiest way to set up an interface. </code></p>
<ul>
<li>The -net option can create either a front-end or a back-end (but has disadvanges than -nic)</li>
<li>-netdev can only create a back-end, use -device for front end</li>
<li>Asingle occurrence of -nic will create both a front-end and a back-end.</li>
</ul>
<p><font color='red' size=4><strong>Suggestion</strong></font></p>
<ul>
<li>The new -nic option gives you an <code>easy and quick way to configure the networking of your guest.</code></li>
<li>For more detailed configuration, e.g. when you need to <strong>tweak the details(like queue size, buffer etc) of the emulated NIC hardware, you can use -device together with -netdev.</strong></li>
<li>The <strong>-net option should be avoided</strong> these days unless you really want to configure a set-up with a hub between the front-ends and back-ends.</li>
</ul>
<p><font color='red'><strong>-nic like a wrapper of -netdev and -deivce pair, easy to use but less control.</strong></font></p>
<h3 id="net-legacy-option"><a href="#net-legacy-option" class="headerlink" title="-net(legacy option)"></a>-net(legacy option)</h3><p>QEMU’s initial way of configuring the network for the guest was the -net option, <strong>the emulated NIC and the host back-end are not directly connected</strong>. They are rather both connected to an emulated hub by default vlan0 (called “vlan” in older versions of QEMU). Therefore, if you start QEMU with <code>-net nic,model=e1000 -net user -net nic,model=virtio -net tap</code> for example, you get a setup where all the front-ends and back-ends are connected together via a hub(vlan)</p>
<p>front end <code>-net nic,model=xyz</code> or <code>-net nic,model=virtio</code> and  backend <code>-net user</code> or <code>-net tap</code> (e.g. -net user for the SLIRP back-end)</p>
<p><img src="https://www.qemu.org/screenshots/2018-05-31-qemu-cli-net.svg" alt="-net"></p>
<p>That means the e1000 NIC also gets the network traffic from the virtio-net NIC and both host back-ends, this can be solved by giving one hub for each nic, for example -net nic,model&#x3D;e1000,vlan&#x3D;0 -net user,vlan&#x3D;0 -net nic,model&#x3D;virtio,vlan&#x3D;1 -net tap,vlan&#x3D;1 moves the virtio-net NIC and the “tap” back-end to a second hub (with ID #1), Please note that the **“vlan” parameter will be dropped in QEMU v3.0 since the term was rather confusing (it’s not related to IEEE 802.1Q for example) *** and caused a lot of misconfigurations in the past.</p>
<h3 id="netdev"><a href="#netdev" class="headerlink" title="-netdev"></a>-netdev</h3><p>To configure a network connection where the <code>emulated NIC is directly connected to a host network back-end, without a hub in between</code>, the well-established solution is to use the -netdev option for the back-end, together with -device for the front-end. </p>
<p><code>-netdev user,id=n1 -device e1000,netdev=n1 -netdev tap,id=n2 -device virtio-net,netdev=n2</code></p>
<p><img src="https://www.qemu.org/screenshots/2018-05-31-qemu-cli-netdev.svg" alt="directly connected"></p>
<p>Now while -netdev together with -device provide a very flexible and extensive way to configure a network connection, there are still two drawbacks with this option pair which prevented us from deprecating the legacy -net option completely:</p>
<ul>
<li>The <strong>-device option can only be used for pluggable NICs</strong>. Boards (e.g. embedded boards) which feature an on-board NIC cannot be configured with -device yet, so -net nic,netdev&#x3D;<id> must be used here instead.</li>
<li>In some cases, the -net option is easier to use (less to type). For example, assuming you want to set up a “tap” network connection and your default scripts &#x2F;etc&#x2F;qemu-ifup and -down are already in place, it’s enough to type -net nic -net tap to start your guest. To do the same with -netdev, you always have to specify an ID here, too, for example like this: -netdev tap,id&#x3D;n1 -device e1000,netdev&#x3D;n1.</li>
</ul>
<h3 id="nic"><a href="#nic" class="headerlink" title="-nic"></a>-nic</h3><p>Looking at the disadvantages listed above, users could benefit from a convenience option that:</p>
<ul>
<li>is easier to use (and shorter to type) than -netdev <backend>,id&#x3D;<id> -device <dev>,netdev&#x3D;<id></li>
<li>can be used to configure on-board &#x2F; non-pluggable NICs, too</li>
<li>does not place a hub between the NIC and the host back-end.</li>
</ul>
<p>This is where the new -nic option kicks in!! this option can be used to configure both the guest’s NIC hardware and the host back-end in one go, instead of <code>-netdev tap,id=n1 -device e1000,netdev=n1</code> you can simply type <code>-nic tap,model=e1000</code>,  you can simply run QEMU with -nic model&#x3D;help. Beside being easier to use, the -nic option can be used to configure on-board NICs, For machines that have on-board NICs, the first -nic option configures the first on-board NIC, the second -nic option configures the second on-board NIC, and so forth.</p>
<h2 id="qemu-kvm-and-qemu-kvm-ev"><a href="#qemu-kvm-and-qemu-kvm-ev" class="headerlink" title="qemu-kvm and qemu-kvm-ev"></a>qemu-kvm and qemu-kvm-ev</h2><p>qemu-kvm and qemu-kvm-ev are usually built from the same src.rpm. Some newer or advanced virtualization features have been implemented in qemu-kvm-ev which are not able to be backported to qemu-kvm for compatibility reasons. Also, recently qemu-kvm-ev has a newer qemu-kvm version than the one provided by qemu-kvm being qemu-kvm-ev rebuilt from Red Hat Enterprise Virtualization.</p>
<h2 id="why-qemu-needs-nvdimm"><a href="#why-qemu-needs-nvdimm" class="headerlink" title="why qemu needs nvdimm??"></a>why qemu needs nvdimm??</h2><p>Really fast writes particularly interesting for:</p>
<ul>
<li>In-memory databases – get persistence for free*!</li>
<li>Databases – transaction logs</li>
<li>File &amp; storage systems – frequently updated metadata</li>
</ul>
<h2 id="why-PCI-address-in-guest-is-not-the-same-as-we-set"><a href="#why-PCI-address-in-guest-is-not-the-same-as-we-set" class="headerlink" title="why PCI address(in guest) is not the same as we set?"></a>why PCI address(in guest) is not the same as we set?</h2><p>Most of that each PCI device would show up in the guest OS with a PCI address that matches the one present in command line set by user, but <strong>that’s not guaranteed to happen and will in fact not be the case in all but the simplest scenarios.</strong> refer to <a target="_blank" rel="noopener" href="https://libvirt.org/pci-addresses.html">Qemu pci address</a></p>
<h2 id="reduce-qcow-file-size-on-host"><a href="#reduce-qcow-file-size-on-host" class="headerlink" title="reduce qcow file size on host"></a>reduce qcow file size on host</h2><p>The <code>virt-sparsify</code> utility, as we just saw, is what we want to use if we are dealing with a qcow2 image, which by default makes use of thin-provisioning, and we want to make the space previously allocated on the disk image and now not used anymore, available again on the host.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$virt</span>-sparsify --in-place disk.qcow2</span><br></pre></td></tr></table></figure>

<h2 id="how-to-enable-IOMMU-for-VM"><a href="#how-to-enable-IOMMU-for-VM" class="headerlink" title="how to enable IOMMU for VM"></a>how to enable IOMMU for VM</h2><p>Enable IOMMU for VM, so that we can start embeded VM with device passthrough.</p>
<p><code>$ qemu-kvm -machine q35,accel=kvm -cpu host -device intel-iommu ...</code> this like enable iommu from hardware and enable it in bios, later we need add parameter to boot command line with <code>intel_iommu=on iommu=pt</code>.</p>
<p>Inside this vm, we can start another vm with passthrough device from host(parent vm).</p>
<h1 id="REF"><a href="#REF" class="headerlink" title="REF"></a>REF</h1><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/qemu/qemu/tree/master/python">Install qemu-shell python tool</a></li>
<li><a target="_blank" rel="noopener" href="https://qemu-project.gitlab.io/qemu/interop/qemu-qmp-ref.html#">qmp commands to change qemu instance runtime</a></li>
<li><a target="_blank" rel="noopener" href="https://gitlab.com/qemu-project/qemu/-/blob/master/hmp-commands.hx">hmp commands of qemu in code</a></li>
<li><a target="_blank" rel="noopener" href="https://qemu-project.gitlab.io/qemu/system/index.html">qemu parameter</a></li>
<li><a target="_blank" rel="noopener" href="https://www.redhat.com/en/blog/hands-vhost-net-do-or-do-not-there-no-try">libvirt with vhost on&#x2F;off</a></li>
</ul>

    </div>

    
    
    
      


    <footer class="post-footer">
          <div class="reward-container">
  <div></div>
  <button>
    Donate
  </button>
  <div class="post-reward">
      <div>
        <img src="/images/wechatpay.jpeg" alt="Jason WeChat Pay">
        <span>WeChat Pay</span>
      </div>

  </div>
</div>

          <div class="post-tags">
              <a href="/tags/qemu/" rel="tag"># qemu</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/10/15/hardware-console-terminal-tty-pty/" rel="prev" title="hardware-console-terminal-tty-pty">
                  <i class="fa fa-chevron-left"></i> hardware-console-terminal-tty-pty
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2021/11/10/linux-kernel-boot/" rel="next" title="linux-kernel-boot">
                  linux-kernel-boot <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments utterances-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2018 – 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Cyun All rights reserved</span>
</div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.0/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>



  <script src="/js/third-party/fancybox.js"></script>

  <script src="/js/third-party/pace.js"></script>

  




<script class="next-config" data-name="utterances" type="application/json">{"enable":true,"repo":"jason-bj/blog","issue_term":"pathname","theme":"github-light"}</script>
<script src="/js/third-party/comments/utterances.js"></script>

</body>
</html>
