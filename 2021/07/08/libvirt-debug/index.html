<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon/favicon-16x16.png">
  <meta name="google-site-verification" content="xitt2fbphh1nTeWLiTWc0lCggHuxJ5heMcAzkHW2vno">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Microsoft+YaHei+UI:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"cyun.tech","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.11.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"utterances","storage":true,"lazyload":false,"nav":null,"activeClass":"utterances"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":10,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Overviewlibvirt provides lots of tools to manage VM or virtual disk, let’s take a quick look about them. VM management  virt-install: install VM etc virsh: start, stop, destroy VM, monitor and collect">
<meta property="og:type" content="article">
<meta property="og:title" content="libvirt-debug">
<meta property="og:url" content="http://cyun.tech/2021/07/08/libvirt-debug/index.html">
<meta property="og:site_name" content="CYun">
<meta property="og:description" content="Overviewlibvirt provides lots of tools to manage VM or virtual disk, let’s take a quick look about them. VM management  virt-install: install VM etc virsh: start, stop, destroy VM, monitor and collect">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://cyun.tech/images/libvirt/libguestfs.jpg">
<meta property="og:image" content="https://cyun.tech/images/libvirt/libvirtd_domain_log.svg">
<meta property="article:published_time" content="2021-07-08T03:18:08.000Z">
<meta property="article:modified_time" content="2023-11-16T15:21:43.145Z">
<meta property="article:author" content="Jason">
<meta property="article:tag" content="libvirt">
<meta property="article:tag" content="cloud">
<meta property="article:tag" content="vm">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cyun.tech/images/libvirt/libguestfs.jpg">


<link rel="canonical" href="http://cyun.tech/2021/07/08/libvirt-debug/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://cyun.tech/2021/07/08/libvirt-debug/","path":"2021/07/08/libvirt-debug/","title":"libvirt-debug"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>libvirt-debug | CYun</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-148730544-1"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-148730544-1","only_pageview":false}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?a510d1f580c8231f8f867d14f42bb8ea"></script>




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">CYun</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Overview"><span class="nav-number">1.</span> <span class="nav-text">Overview</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Tools-and-frequent-used-command"><span class="nav-number">2.</span> <span class="nav-text">Tools and frequent used command</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#QMP-from-virsh"><span class="nav-number">2.1.</span> <span class="nav-text">QMP from virsh</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#QGA"><span class="nav-number">2.2.</span> <span class="nav-text">QGA</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Manage-virtual-disk-with-tools"><span class="nav-number">3.</span> <span class="nav-text">Manage virtual disk with tools</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#virsh-command-groups"><span class="nav-number">4.</span> <span class="nav-text">virsh command groups</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#vm-xml"><span class="nav-number">4.1.</span> <span class="nav-text">vm xml</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Command-groups"><span class="nav-number">4.2.</span> <span class="nav-text">Command groups</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Domain-management"><span class="nav-number">4.2.1.</span> <span class="nav-text">Domain management</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Domain-monitor"><span class="nav-number">4.2.2.</span> <span class="nav-text">Domain monitor</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Domain-Snapshot"><span class="nav-number">4.2.3.</span> <span class="nav-text">Domain Snapshot</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Host-and-Hypervisor"><span class="nav-number">4.2.4.</span> <span class="nav-text">Host and Hypervisor</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Network-Interface"><span class="nav-number">4.2.5.</span> <span class="nav-text">Network Interface</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Network"><span class="nav-number">4.2.6.</span> <span class="nav-text">Network</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Node-device"><span class="nav-number">4.2.7.</span> <span class="nav-text">Node device</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Storage-pool"><span class="nav-number">4.2.8.</span> <span class="nav-text">Storage pool</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Storage-Volume"><span class="nav-number">4.2.9.</span> <span class="nav-text">Storage Volume</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#event"><span class="nav-number">4.2.10.</span> <span class="nav-text">event</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#blk"><span class="nav-number">4.2.11.</span> <span class="nav-text">blk</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#trobleshooting"><span class="nav-number">5.</span> <span class="nav-text">trobleshooting</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#conf-runtime-files"><span class="nav-number">5.1.</span> <span class="nav-text">conf runtime files</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#libvirt-log"><span class="nav-number">5.2.</span> <span class="nav-text">libvirt log</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#FAQ"><span class="nav-number">6.</span> <span class="nav-text">FAQ</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Difference-between-qemu-x2F-x2F-x2F-system-and-qemu-x2F-x2F-x2F-session-Which-one-should-I-use"><span class="nav-number">6.1.</span> <span class="nav-text">Difference between qemu:&#x2F;&#x2F;&#x2F;system and qemu:&#x2F;&#x2F;&#x2F;session, Which one should I use?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Migration"><span class="nav-number">6.2.</span> <span class="nav-text">Migration</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#How-to-import-a-vm-from-a-terminal-no-X-display"><span class="nav-number">6.3.</span> <span class="nav-text">How to import a vm from a terminal(no X display)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#How-to-install-a-VM-from-a-terminal"><span class="nav-number">6.4.</span> <span class="nav-text">How to install a VM from a terminal</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#how-to-change-something-of-disk-without-boot-it"><span class="nav-number">6.5.</span> <span class="nav-text">how to change something of disk without boot it</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#How-to-reset-a-user-password-of-domain"><span class="nav-number">6.6.</span> <span class="nav-text">How to reset a user password of domain</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#how-to-change-log-level-without-libvirt-restart"><span class="nav-number">6.7.</span> <span class="nav-text">how to change log level without libvirt restart</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#how-to-enable-client-library-log"><span class="nav-number">6.8.</span> <span class="nav-text">how to enable client library log</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#how-to-enable-libvirtd-on-tcp-without-tls"><span class="nav-number">6.9.</span> <span class="nav-text">how to enable libvirtd on tcp without tls</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Why-doesn%E2%80%99t-%E2%80%98shutdown%E2%80%99-seem-to-work"><span class="nav-number">6.10.</span> <span class="nav-text">Why doesn’t ‘shutdown’ seem to work?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#When-lt-input-gt-device-is-used"><span class="nav-number">6.11.</span> <span class="nav-text">When &lt;input&gt; device is used</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#reduce-disk-image-file-not-disk-size"><span class="nav-number">6.12.</span> <span class="nav-text">reduce disk image file not disk size</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#run-kvm-machine-from-another-vm"><span class="nav-number">6.13.</span> <span class="nav-text">run kvm machine from another vm</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#monitor-event-from-command-line"><span class="nav-number">6.14.</span> <span class="nav-text">monitor event from command line</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#monitor-performance-of-vm"><span class="nav-number">6.15.</span> <span class="nav-text">monitor performance of vm</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#add-hotplug-cpu-to-guest-add-cpu-to-guest-without-rebooting-it"><span class="nav-number">6.16.</span> <span class="nav-text">add hotplug cpu to guest(add cpu to guest without rebooting it)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#memory-deivce-and-share-memory"><span class="nav-number">6.17.</span> <span class="nav-text">memory deivce and share memory</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#without-hotplugable-memory-device"><span class="nav-number">6.17.1.</span> <span class="nav-text">without hotplugable memory device</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#with-hotplugable-memory-dimm-from-command-line"><span class="nav-number">6.17.2.</span> <span class="nav-text">with hotplugable memory(dimm) from command line</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#with-hotplugable-memory-nvdimm-from-command-line"><span class="nav-number">6.17.3.</span> <span class="nav-text">with hotplugable memory(nvdimm) from command line</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#with-hotpluggable-memory-device-from-QMP"><span class="nav-number">6.17.4.</span> <span class="nav-text">with hotpluggable memory device from QMP</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#move-qemu-process-launched-outside-to-libvirtd-control"><span class="nav-number">6.18.</span> <span class="nav-text">move qemu-process launched outside to libvirtd control</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#limit-IO"><span class="nav-number">6.19.</span> <span class="nav-text">limit IO</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#get-device-property-value"><span class="nav-number">6.20.</span> <span class="nav-text">get device property value</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#how-to-login-vm-by-serial-console-for"><span class="nav-number">6.21.</span> <span class="nav-text">how to login vm by serial console for</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#how-to-access-console-x2F-serial-without-virsh-command"><span class="nav-number">6.22.</span> <span class="nav-text">how to access console&#x2F;serial without virsh command</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#use-specific-qemu-for-a-vm"><span class="nav-number">6.23.</span> <span class="nav-text">use specific qemu for a vm</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#node-device-info"><span class="nav-number">6.24.</span> <span class="nav-text">node device info</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Ref"><span class="nav-number">7.</span> <span class="nav-text">Ref</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Jason"
      src="/uploads/avatar.gif">
  <p class="site-author-name" itemprop="name">Jason</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">150</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">141</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">149</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/jason-cyun" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;jason-cyun" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:jason_lkm@163.com" title="E-Mail → mailto:jason_lkm@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://cyun.tech/2021/07/08/libvirt-debug/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.gif">
      <meta itemprop="name" content="Jason">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CYun">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="libvirt-debug | CYun">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          libvirt-debug
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-07-08 11:18:08" itemprop="dateCreated datePublished" datetime="2021-07-08T11:18:08+08:00">2021-07-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-11-16 23:21:43" itemprop="dateModified" datetime="2023-11-16T23:21:43+08:00">2023-11-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/libvirt/" itemprop="url" rel="index"><span itemprop="name">libvirt</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h1><p>libvirt provides lots of tools to manage VM or virtual disk, let’s take a quick look about them.</p>
<p><strong>VM management</strong></p>
<ul>
<li><code>virt-install</code>: install VM etc</li>
<li><code>virsh</code>: start, stop, destroy VM, monitor and collect stats of VM etc</li>
<li><code>virt-manager</code>: GUI for manage VM</li>
</ul>
<p><strong>Virtual disk management(provided by libguestfs)</strong></p>
<ul>
<li><code>guestfish</code>: interactive shell to manage disk(–verbose for debug)</li>
<li><code>guestmount/guestumount</code>: mount&#x2F;umount disk to host path(–verbose for debug)</li>
<li><code>virt-cat/virt-copy-in/virt-copy-out/virt-format/virt-xxx</code>: commands to manage virtual disk(–berbose for debug)</li>
</ul>
<p><strong>ALL libvirt tools(included libguestfs tools) communicate with <code>libvirt daemon</code> to manage vm or disk by default, but you can direct with qemu if libvirt is not thre</strong></p>
<p><code>export LIBGUESTFS_BACKEND=direct virt-sysprep</code></p>
<span id="more"></span>

<h1 id="Tools-and-frequent-used-command"><a href="#Tools-and-frequent-used-command" class="headerlink" title="Tools and frequent used command"></a>Tools and frequent used command</h1><p><strong>requently used virsh command</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">$ virsh <span class="built_in">help</span> dominfo</span><br><span class="line"></span><br><span class="line"><span class="comment"># virsh with remote server</span></span><br><span class="line">$ virsh -c qemu+tcp://172.17.0.3/system xxx</span><br><span class="line"><span class="comment"># vda target name in conf</span></span><br><span class="line">$ virsh domblkinfo vm100 vda</span><br><span class="line">Capacity:       8589934592</span><br><span class="line">Allocation:     200015872</span><br><span class="line">Physical:       200015872</span><br><span class="line"></span><br><span class="line">$ virsh domblkstat vm100 vda</span><br><span class="line">vda rd_req 5761</span><br><span class="line">vda rd_bytes 133831680</span><br><span class="line">vda wr_req 86</span><br><span class="line">vda wr_bytes 3244544</span><br><span class="line">vda flush_operations 9</span><br><span class="line">vda rd_total_times 5365449922</span><br><span class="line">vda wr_total_times 599328712</span><br><span class="line">vda flush_total_times 15684892</span><br><span class="line"></span><br><span class="line"><span class="comment"># target name in conf</span></span><br><span class="line">$ virsh domifstat vm100 mynet0</span><br><span class="line">mynet0 rx_bytes 1748</span><br><span class="line">mynet0 rx_packets 29</span><br><span class="line">mynet0 rx_errs 0</span><br><span class="line">mynet0 rx_drop 0</span><br><span class="line">mynet0 tx_bytes 0</span><br><span class="line">mynet0 tx_packets 0</span><br><span class="line">mynet0 tx_errs 0</span><br><span class="line">mynet0 tx_drop 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># get from memballoon driver inside guest</span></span><br><span class="line">$ virsh dommemstat vm100</span><br><span class="line">actual 1310720</span><br><span class="line">swap_in 0</span><br><span class="line">swap_out 0</span><br><span class="line">major_fault 175</span><br><span class="line">minor_fault 142267</span><br><span class="line">unused 1082444</span><br><span class="line">available 1210140</span><br><span class="line">usable 1099536</span><br><span class="line">last_update 1661222057</span><br><span class="line">rss 1526228</span><br><span class="line"></span><br><span class="line">$ virsh domblkerror vm100</span><br><span class="line">No errors found</span><br><span class="line"></span><br><span class="line">$ virsh dominfo vm100</span><br><span class="line">Id:             1</span><br><span class="line">Name:           vm100</span><br><span class="line">UUID:           4a0a3bb3-57cf-4efd-84c7-be9b74b02ccd</span><br><span class="line">OS Type:        hvm</span><br><span class="line">State:          running</span><br><span class="line">CPU(s):         4</span><br><span class="line">CPU time:       94.0s</span><br><span class="line">Max memory:     1572864 KiB</span><br><span class="line">Used memory:    1310720 KiB</span><br><span class="line">Persistent:     <span class="built_in">yes</span></span><br><span class="line">Autostart:      <span class="built_in">disable</span></span><br><span class="line">Managed save:   no</span><br><span class="line">Security model: none</span><br><span class="line">Security DOI:   0</span><br><span class="line"></span><br><span class="line">$ virsh domjobinfo vm100</span><br><span class="line">Job <span class="built_in">type</span>:         None      </span><br><span class="line"></span><br><span class="line">$ virsh domstate vm100 --reason</span><br><span class="line">running (booted)</span><br><span class="line"></span><br><span class="line">$ virsh console vm100(<span class="built_in">exit</span> console `Ctrl+]`)</span><br><span class="line">$ virsh dumpxml vm100</span><br></pre></td></tr></table></figure>

<p><strong>virsh examples</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># this will install libvirt-client(virsh) and libvirt-daemon(libvirtd)</span></span><br><span class="line">$ yum install -y libvirt</span><br><span class="line"></span><br><span class="line"><span class="comment"># install kvm and bios to start vm</span></span><br><span class="line">$ yum install -y kvm</span><br><span class="line">$ yum install -y seabios</span><br><span class="line"></span><br><span class="line">$ libvirtd --version</span><br><span class="line"></span><br><span class="line">$ virsh -v</span><br><span class="line"></span><br><span class="line"><span class="comment"># By default virsh will connect with local libvirt by unix socket</span></span><br><span class="line"><span class="comment"># but can connect with remote libvirtd</span></span><br><span class="line"><span class="comment"># ssh</span></span><br><span class="line">$ virsh --connect qemu+ssh://remote/system</span><br><span class="line"><span class="comment"># plain tcp</span></span><br><span class="line">$ virsh --connect qemu+tcp://remote:port/system</span><br><span class="line"></span><br><span class="line"><span class="comment"># show the connection</span></span><br><span class="line">$ virsh uri</span><br><span class="line"></span><br><span class="line"><span class="comment"># create a vm, for QEMU and LXC, libvirtd stores vm XML to disk and in memory</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># DO NOT edit the XML directly from disk at in that way, there is no validation!!!</span></span><br><span class="line"><span class="comment"># if you edit the on-disk XML is a VM that simply vanishes the next time libvirtd is restarted after the edit.</span></span><br><span class="line"><span class="comment"># The VM disappears from libvirt because the XML has become invalid, after which libvirt can&#x27;t do anything with it</span></span><br><span class="line"></span><br><span class="line">$ virsh dumpxml <span class="variable">$domain</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># change domain config from xml, restart it to make it work</span></span><br><span class="line">$ virsh shutdown <span class="variable">$domain</span></span><br><span class="line">$ virsh edit <span class="variable">$domain</span></span><br><span class="line">$ virsh start <span class="variable">$domain</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># delete a vm and related files</span></span><br><span class="line">$ virsh destroy  <span class="variable">$domain</span></span><br><span class="line">$ virsh undefine <span class="variable">$domain</span> -remove-all-storage</span><br><span class="line"></span><br><span class="line"><span class="comment"># attach/detach disk to a vm</span></span><br><span class="line"><span class="comment"># --target is the device hit, it&#x27;s a must option</span></span><br><span class="line"><span class="comment"># <span class="doctag">NOTE:</span> vdc may be not used by guest if it&#x27;s not the first available device, say, if vdb is free, even you proivdes vdc, vdb is used</span></span><br><span class="line"><span class="comment"># that means if you check the config, it shows vdc, but actually, vdb is used inside vm, hence --target should be the first available device if expected as set</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># check existing device from xml, dev name may be not the name used inside guest</span></span><br><span class="line">$ virsh domblklist centos </span><br><span class="line">Target     Source</span><br><span class="line">------------------------------------------------</span><br><span class="line">vda        /home/data/tmp/vm100.qcow2</span><br><span class="line">vdc        /dev/loop0</span><br><span class="line"></span><br><span class="line"><span class="comment"># check the real dev name used inside guest, vda is used by /dev/loop0 while vdb is used for /home/data/tmp/vm100.qcow2</span></span><br><span class="line">$ virsh qemu-agent-command vm100 <span class="string">&#x27;&#123;&quot;execute&quot;:&quot;guest-exec&quot;,&quot;arguments&quot;:&#123;&quot;path&quot;:&quot;lsblk&quot;,&quot;capture-output&quot;:true&#125;&#125;&#x27;</span></span><br><span class="line">&#123;<span class="string">&quot;return&quot;</span>:&#123;<span class="string">&quot;pid&quot;</span>:980&#125;&#125;</span><br><span class="line"></span><br><span class="line">$ virsh qemu-agent-command vm100 <span class="string">&#x27;&#123;&quot;execute&quot;:&quot;guest-exec-status&quot;,&quot;arguments&quot;:&#123;&quot;pid&quot;:980&#125;&#125;&#x27;</span> </span><br><span class="line">&#123;<span class="string">&quot;return&quot;</span>:&#123;<span class="string">&quot;exitcode&quot;</span>:0,<span class="string">&quot;out-data&quot;</span>:<span class="string">&quot;TkFNRSAgIE1BSjpNSU4gUk0gIFNJWkUgUk8gVFlQRSBNT1VOVFBPSU5UCnZkYSAgICAyNTM6MCAgICAwICAzNTBLICAwIGRpc2sgCnZkYiAgICAyNTM6MTYgICAwICAgIDhHICAwIGRpc2sgCuKUlOKUgHZkYjEgMjUzOjE3ICAgMCAgICA4RyAgMCBwYXJ0IC8KcG1lbTAgIDI1OTowICAgIDAgIDI1Nk0gIDAgZGlzayAK&quot;</span>,<span class="string">&quot;exited&quot;</span>:<span class="literal">true</span>&#125;&#125;</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;TkFNRSAgIE1BSjpNSU4gUk0gIFNJWkUgUk8gVFlQRSBNT1VOVFBPSU5UCnZkYSAgICAyNTM6MCAgICAwICAzNTBLICAwIGRpc2sgCnZkYiAgICAyNTM6MTYgICAwICAgIDhHICAwIGRpc2sgCuKUlOKUgHZkYjEgMjUzOjE3ICAgMCAgICA4RyAgMCBwYXJ0IC8KcG1lbTAgIDI1OTowICAgIDAgIDI1Nk0gIDAgZGlzayAK&quot;</span> | <span class="built_in">base64</span> -d</span><br><span class="line">NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class="line">vda    253:0    0  350K  0 disk </span><br><span class="line">vdb    253:16   0    8G  0 disk </span><br><span class="line">└─vdb1 253:17   0    8G  0 part /</span><br><span class="line">pmem0  259:0    0  256M  0 disk </span><br><span class="line"></span><br><span class="line"><span class="comment"># attach-disk &lt;domain&gt; &lt;source&gt; &lt;target&gt; [--targetbus &lt;string&gt;] [--driver &lt;string&gt;] [--subdriver &lt;string&gt;] [--iothread &lt;string&gt;] [--cache &lt;string&gt;] [--io &lt;string&gt;] [--type &lt;string&gt;] [--mode &lt;string&gt;] [--sourcetype &lt;string&gt;] [--serial &lt;string&gt;] [--wwn &lt;string&gt;] [--rawio] [--address &lt;string&gt;] [--multifunction] [--print-xml] [--persistent] [--config] [--live] [--current]</span></span><br><span class="line">$ virsh attach-disk --domain centos --<span class="built_in">source</span> /home/data/tmp/disk.raw --persistent --target vdc</span><br><span class="line"><span class="comment"># dd if=/dev/zero of=/tmp/disk.raw bs=2M count=5120 status=progress</span></span><br><span class="line">$ virsh attach-disk centos /tmp/disk.raw vdc --persistent</span><br><span class="line">$ virsh detach-disk --domain centos --config --target vdb</span><br><span class="line">$ virsh detach-disk centos vdb --config</span><br><span class="line"></span><br><span class="line"><span class="comment"># attach/detach interface</span></span><br><span class="line"><span class="comment">#  attach-interface &lt;domain&gt; &lt;type&gt; &lt;source&gt; [--target &lt;string&gt;] [--mac &lt;string&gt;] [--script &lt;string&gt;] [--model &lt;string&gt;] [--inbound &lt;string&gt;] [--outbound &lt;string&gt;] [--persistent] [--config] [--live] [--current] [--print-xml] [--managed]</span></span><br><span class="line"><span class="comment"># virsh domiflist centos</span></span><br><span class="line"><span class="comment"># ovsnet is a network: virsh net-list</span></span><br><span class="line">Interface  Type       Source     Model       MAC</span><br><span class="line">-------------------------------------------------------</span><br><span class="line">vnet1      bridge     ovsnet     virtio      52:54:00:43:85:03</span><br><span class="line"></span><br><span class="line"><span class="comment"># add a new interface to domain</span></span><br><span class="line">$ virsh attach-interface --domain centos --<span class="built_in">type</span> network --<span class="built_in">source</span> ovsnet  --model virtio</span><br><span class="line">$ virsh attach-interface --domain centos --<span class="built_in">type</span> network --<span class="built_in">source</span> ovsnet  --model virtio --persistent</span><br><span class="line"><span class="comment"># virsh domiflist centos</span></span><br><span class="line">Interface  Type       Source     Model       MAC</span><br><span class="line">-------------------------------------------------------</span><br><span class="line">vnet1      bridge     ovsnet     virtio      52:54:00:43:85:03</span><br><span class="line">vnet2      bridge     ovsnet     virtio      52:54:00:a6:45:d6</span><br><span class="line"></span><br><span class="line">$ virsh detach-interface centos bridge --mac 52:54:00:a6:45:d6</span><br><span class="line">$ virsh detach-interface centos bridge --mac 52:54:00:a6:45:d6 --persistent</span><br></pre></td></tr></table></figure>

<h2 id="QMP-from-virsh"><a href="#QMP-from-virsh" class="headerlink" title="QMP from virsh"></a>QMP from virsh</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 6095 is domain id, vm100 is domain name</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># HMP protocol</span></span><br><span class="line">$ virsh qemu-monitor-command –hmp 6095 info block</span><br><span class="line">drive-virtio-disk0: removable=0 file=/export/jvirt/jcs-agent/instances/i-sm6pxr4068/vda backing_file=/export/jvirt/jcs-agent/instances/_base/img-8sdjnj4qbq backing_file_depth=1 ro=0 drv=qcow2 encrypted=0 bps=0 bps_rd=0 bps_wr=0 iops=0 iops_rd=0 iops_wr=0</span><br><span class="line"></span><br><span class="line"><span class="comment"># all supported QMP commands</span></span><br><span class="line">$ virsh qemu-monitor-command  vm100 --pretty <span class="string">&#x27;&#123;&quot;execute&quot;: &quot;query-commands&quot;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># QMP protocol --pretty means format json output</span></span><br><span class="line"><span class="comment"># virsh qemu-monitor-command  vm100 --pretty &#x27;&#123; &quot;execute&quot;: &quot;query-block&quot;&#125;&#x27;</span></span><br><span class="line">$ virsh qemu-monitor-command  6095 --pretty <span class="string">&#x27;&#123; &quot;execute&quot;: &quot;query-block&quot;&#125;&#x27;</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;return&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;device&quot;</span>: <span class="string">&quot;drive-virtio-disk0&quot;</span>,</span><br><span class="line">      <span class="string">&quot;locked&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="string">&quot;removable&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="string">&quot;inserted&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;iops_rd&quot;</span>: 0,</span><br><span class="line">        <span class="string">&quot;image&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;backing-image&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;virtual-size&quot;</span>: 42949672960,</span><br><span class="line">            <span class="string">&quot;filename&quot;</span>: <span class="string">&quot;/export/jvirt/jcs-agent/instances/_base/img-8sdjnj4qbq&quot;</span>,</span><br><span class="line">            <span class="string">&quot;cluster-size&quot;</span>: 65536,</span><br><span class="line">            <span class="string">&quot;format&quot;</span>: <span class="string">&quot;qcow2&quot;</span>,</span><br><span class="line">            <span class="string">&quot;actual-size&quot;</span>: 24866193408,</span><br><span class="line">            <span class="string">&quot;format-specific&quot;</span>: &#123;</span><br><span class="line">              <span class="string">&quot;type&quot;</span>: <span class="string">&quot;qcow2&quot;</span>,</span><br><span class="line">              <span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;compat&quot;</span>: <span class="string">&quot;1.1&quot;</span>,</span><br><span class="line">                <span class="string">&quot;lazy-refcounts&quot;</span>: <span class="literal">false</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">&quot;dirty-flag&quot;</span>: <span class="literal">false</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">&quot;virtual-size&quot;</span>: 42949672960,</span><br><span class="line">          <span class="string">&quot;filename&quot;</span>: <span class="string">&quot;/export/jvirt/jcs-agent/instances/i-sm6pxr4068/vda&quot;</span>,</span><br><span class="line">          <span class="string">&quot;cluster-size&quot;</span>: 65536,</span><br><span class="line">          <span class="string">&quot;format&quot;</span>: <span class="string">&quot;qcow2&quot;</span>,</span><br><span class="line">          <span class="string">&quot;actual-size&quot;</span>: 21068431360,</span><br><span class="line">          <span class="string">&quot;format-specific&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;type&quot;</span>: <span class="string">&quot;qcow2&quot;</span>,</span><br><span class="line">            <span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">              <span class="string">&quot;compat&quot;</span>: <span class="string">&quot;1.1&quot;</span>,</span><br><span class="line">              <span class="string">&quot;lazy-refcounts&quot;</span>: <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="string">&quot;backing-filename&quot;</span>: <span class="string">&quot;/export/jvirt/jcs-agent/instances/_base/img-8sdjnj4qbq&quot;</span>,</span><br><span class="line">          <span class="string">&quot;dirty-flag&quot;</span>: <span class="literal">false</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;iops_wr&quot;</span>: 0,</span><br><span class="line">        <span class="string">&quot;ro&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;backing_file_depth&quot;</span>: 1,</span><br><span class="line">        <span class="string">&quot;drv&quot;</span>: <span class="string">&quot;qcow2&quot;</span>,</span><br><span class="line">        <span class="string">&quot;iops&quot;</span>: 0,</span><br><span class="line">        <span class="string">&quot;bps_wr&quot;</span>: 0,</span><br><span class="line">        <span class="string">&quot;backing_file&quot;</span>: <span class="string">&quot;/export/jvirt/jcs-agent/instances/_base/img-8sdjnj4qbq&quot;</span>,</span><br><span class="line">        <span class="string">&quot;encrypted&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;bps&quot;</span>: 0,</span><br><span class="line">        <span class="string">&quot;bps_rd&quot;</span>: 0,</span><br><span class="line">        <span class="string">&quot;file&quot;</span>: <span class="string">&quot;/export/jvirt/jcs-agent/instances/i-sm6pxr4068/vda&quot;</span>,</span><br><span class="line">        <span class="string">&quot;encryption_key_missing&quot;</span>: <span class="literal">false</span></span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;type&quot;</span>: <span class="string">&quot;unknown&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;id&quot;</span>: <span class="string">&quot;libvirt-8302918&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="QGA"><a href="#QGA" class="headerlink" title="QGA"></a>QGA</h2><p>In order to run command inside guest os, we must have two things prepared.</p>
<ul>
<li>A channel</li>
<li>guest agent runs in guest os to execute the command</li>
</ul>
<p><strong>Enable the channel, by edit xml of libvirtd with $virsh edit $domain</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">devices</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">channel</span> <span class="attr">type</span>=<span class="string">&#x27;unix&#x27;</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">source</span> <span class="attr">mode</span>=<span class="string">&#x27;bind&#x27;</span>/&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">target</span> <span class="attr">type</span>=<span class="string">&#x27;virtio&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;org.qemu.guest_agent.0&#x27;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">channel</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">devices</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>Then after save, libvirt will set extra info, the full meta is like this</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">channel</span> <span class="attr">type</span>=<span class="string">&#x27;unix&#x27;</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">source</span> <span class="attr">mode</span>=<span class="string">&#x27;bind&#x27;</span> <span class="attr">path</span>=<span class="string">&#x27;/var/lib/libvirt/qemu/channel/target/domain-3-centos/org.qemu.guest_agent.0&#x27;</span>/&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">target</span> <span class="attr">type</span>=<span class="string">&#x27;virtio&#x27;</span> <span class="attr">name</span>=<span class="string">&#x27;org.qemu.guest_agent.0&#x27;</span> <span class="attr">state</span>=<span class="string">&#x27;connected&#x27;</span>/&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;channel0&#x27;</span>/&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">&#x27;virtio-serial&#x27;</span> <span class="attr">controller</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;0&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;1&#x27;</span>/&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">channel</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>After enable this channel, on host a unix socket is created for the VM at <code>/var/lib/libvirt/qemu/channel/target/domain-3-centos/org.qemu.guest_agent.0</code>, you can also set the path of socket with <code>path attribute in source tag</code> like  <code>&lt;source mode=&#39;bind&#39; path=&#39;/var/lib/libvirt/test.agent.0&#39;/&gt;</code><br>Inside the domain, <code>a char device(/dev/virtio-ports/org.qemu.guest_agent.0) is exported to user by virtio</code>, <strong>write&#x2F;read to char dev inside guest OS, data is available at unix socket on host.</strong></p>
<p><strong>Install agent inside guest vm</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ yum install qemu-guest-agent</span><br><span class="line">$ systemctl start qemu-guest-agent</span><br><span class="line">$ systemctl <span class="built_in">enable</span> qemu-guest-agent</span><br></pre></td></tr></table></figure>

<p><strong>QGA commands</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># show all supported commands that can run inside domain</span></span><br><span class="line">$ virsh qemu-agent-command <span class="variable">$&#123;DOMAIN&#125;</span> --pretty <span class="string">&#x27;&#123;&quot;execute&quot;:&quot;guest-info&quot;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># guest-exec</span></span><br><span class="line"><span class="comment"># guest-exec-status</span></span><br><span class="line"><span class="comment"># guest-get-host-name</span></span><br><span class="line"><span class="comment"># guest-get-time</span></span><br><span class="line"><span class="comment"># guest-set-user-password</span></span><br><span class="line"><span class="comment"># guest-shutdown</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># guest-get-cpu-usage</span></span><br><span class="line"><span class="comment"># guest-get-mem-usage</span></span><br><span class="line"><span class="comment"># guest-get-time</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># File content is encrypted base64!!!</span></span><br><span class="line"><span class="comment"># guest-file-seek</span></span><br><span class="line"><span class="comment"># guest-file-read</span></span><br><span class="line"><span class="comment"># guest-file-write</span></span><br><span class="line"><span class="comment"># guest-file-flush</span></span><br><span class="line"><span class="comment"># guest-file-close</span></span><br><span class="line"><span class="comment"># guest-file-open</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># open with read only</span></span><br><span class="line">$ virsh qemu-agent-command <span class="variable">$&#123;DOMAIN&#125;</span> <span class="string">&#x27;&#123;&quot;execute&quot;:&quot;guest-file-open&quot;, &quot;arguments&quot;:&#123;&quot;path&quot;:&quot;/tmp/test.txt&quot;,&quot;mode&quot;:&quot;r&quot;&#125;&#125;&#x27;</span></span><br><span class="line">&#123;<span class="string">&quot;return&quot;</span>:1000&#125;</span><br><span class="line"><span class="comment"># guest-file-read, you can call these several times to get the whole file data, then close it</span></span><br><span class="line"><span class="comment"># this is probably used for large file</span></span><br><span class="line">$ virsh qemu-agent-command <span class="variable">$&#123;DOMAIN&#125;</span> <span class="string">&#x27;&#123;&quot;execute&quot;:&quot;guest-file-read&quot;, &quot;arguments&quot;:&#123;&quot;handle&quot;:1000&#125;&#125;&#x27;</span></span><br><span class="line"><span class="comment"># read with large buffer</span></span><br><span class="line">$ virsh qemu-agent-command <span class="variable">$&#123;DOMAIN&#125;</span> <span class="string">&#x27;&#123;&quot;execute&quot;:&quot;guest-file-read&quot;, &quot;arguments&quot;:&#123;&quot;handle&quot;:1000, &quot;count&quot;:1000000&#125;&#125;&#x27;</span></span><br><span class="line"><span class="comment"># guest-file-close</span></span><br><span class="line">$ virsh qemu-agent-command <span class="variable">$&#123;DOMAIN&#125;</span> <span class="string">&#x27;&#123;&quot;execute&quot;:&quot;guest-file-close&quot;, &quot;arguments&quot;:&#123;&quot;handle&quot;:1000&#125;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># run arbitrary command, run `any` command inside guest</span></span><br><span class="line">$ virsh qemu-agent-command <span class="variable">$&#123;DOMAIN&#125;</span> <span class="string">&#x27;&#123;&quot;execute&quot;:&quot;guest-exec&quot;,&quot;arguments&quot;:&#123;&quot;path&quot;:&quot;mkdir&quot;,&quot;arg&quot;:[&quot;-p&quot;,&quot;/root/.ssh&quot;],&quot;capture-output&quot;:true&#125;&#125;&#x27;</span></span><br><span class="line">&#123;<span class="string">&quot;return&quot;</span>:&#123;<span class="string">&quot;pid&quot;</span>:911&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># get the content of a file, it opens the file then close it every time</span></span><br><span class="line"><span class="comment"># if file is large, output is truncated!!!, so that you can only the first part of a larger file!!!! use guest-file-read instead for large file</span></span><br><span class="line">$ virsh qemu-agent-command <span class="variable">$&#123;DOMAIN&#125;</span> <span class="string">&#x27;&#123;&quot;execute&quot;:&quot;guest-exec&quot;,&quot;arguments&quot;:&#123;&quot;path&quot;:&quot;cat&quot;,&quot;arg&quot;:[&quot;/var/log/plugin.log&quot;],&quot;capture-output&quot;:true&#125;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># response is encrypted base64</span></span><br><span class="line">$ virsh qemu-agent-command <span class="variable">$&#123;DOMAIN&#125;</span> <span class="string">&#x27;&#123;&quot;execute&quot;:&quot;guest-exec-status&quot;,&quot;arguments&quot;:&#123;&quot;pid&quot;:911&#125;&#125;&#x27;</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># base64 decode/encode</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;hello&quot;</span> | <span class="built_in">base64</span></span><br><span class="line">aGVsbG8K</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;aGVsbG8K&quot;</span> | <span class="built_in">base64</span> -d</span><br><span class="line">hello</span><br><span class="line"></span><br><span class="line"><span class="comment"># encode/decode from file</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;hello&quot;</span> &gt;test.txt</span><br><span class="line">$ <span class="built_in">base64</span> ./test &gt;encoded.txt</span><br><span class="line">$ <span class="built_in">base64</span> -d ./encoded.txt</span><br><span class="line">hello</span><br></pre></td></tr></table></figure>

<h1 id="Manage-virtual-disk-with-tools"><a href="#Manage-virtual-disk-with-tools" class="headerlink" title="Manage virtual disk with tools"></a>Manage virtual disk with tools</h1><p>libguestfs is a C library tool for <code>creating, accessing and modifying virtual machine disk images</code>. You can look inside the disk images, modify the files they contain, create them from scratch, resize them, and much more.<br><code>yum install libguestfs libguestfs-tool</code><br>libguestfs works with any disk image, including ones created in <code>VMware, KVM, qemu, VirtualBox, Xen, and many other hypervisors</code></p>
<p><img src="https://cyun.tech/images/libvirt/libguestfs.jpg" alt="libguestfs arch"></p>
<p>guestfish is an interactive shell that you can use from the command line or from shell scripts to access guest virtual machine file systems. <strong>All of the functionality of the libguestfs API is available from the shell</strong>, guestfish shell provides lots of built-in commands(600+) you can use to access guest file systems, <code>it&#39;s a super-set of virt-xxx command below(--verbose for debug)</code>.</p>
<ul>
<li>virt-copy-in</li>
<li>virt-copy-out</li>
<li>virt-edit</li>
<li>virt-df</li>
<li>virt-tar-in</li>
<li>virt-tar-out</li>
<li>virt-cat</li>
<li>virt-ls</li>
<li>virt-make-fs</li>
<li>virt-filesystems</li>
<li>virt-sysprep</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#===========================start a new vm permenantly, destroy it when quit the fish shell====</span></span><br><span class="line"><span class="comment"># two ways to run guestfish either by providing a disk image or domain name of libvirt</span></span><br><span class="line"><span class="comment"># -i means inspect the image and mount the file systems(mount requires a vm started by guestfish)</span></span><br><span class="line"><span class="comment"># 1. guestfish will start a new vm by libvirt and mount domain disk </span></span><br><span class="line"><span class="comment"># --verbose to debug issue</span></span><br><span class="line">$ guestfish --ro -d <span class="variable">$domain</span> -i</span><br><span class="line">&gt;&lt;fs&gt; df-h</span><br><span class="line">Filesystem      Size  Used Avail Use% Mounted on</span><br><span class="line">tmpfs            96M  112K   96M   1% /run</span><br><span class="line">/dev            237M     0  237M   0% /dev</span><br><span class="line">/dev/sda1       8.0G  1.2G  6.9G  14% /sysroot</span><br><span class="line"></span><br><span class="line"><span class="comment"># NOTE use TAB for command completion!!!</span></span><br><span class="line"></span><br><span class="line">$ virsh list</span><br><span class="line"> Id    Name                           State</span><br><span class="line">----------------------------------------------------</span><br><span class="line"> 4     guestfs-cmurc2zne6ot9rt8       running</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. from a disk image to start a new vm(this will call libvirt to start a new vm as well)</span></span><br><span class="line">$ guestfish -a /path/to/disk/image -i</span><br><span class="line">&gt;&lt;fs&gt; df-h</span><br><span class="line"></span><br><span class="line"><span class="comment">#===========================start a new vm temporarily, destroy it when get the command result===</span></span><br><span class="line">$ virt-filesystems -a CentOS-7-x86_64-GenericCloud-1503.qcow2</span><br><span class="line">/dev/sda1</span><br><span class="line">$ virt-filesystems -d <span class="variable">$domain</span></span><br><span class="line">/dev/sda1</span><br><span class="line"></span><br><span class="line">$ virt-ls -d <span class="variable">$domain</span> /home/centos</span><br><span class="line">$ virt-tar-out -d <span class="variable">$domain</span> /home/centos out.tar.gz</span><br><span class="line">$ virt-copy-in -d <span class="variable">$domain</span> test.txt /home/centos</span><br><span class="line">$ virt-copy-out -d <span class="variable">$domain</span> /home/centos/text.txt .</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">########################the new vm start by guest fish#######################################</span></span><br><span class="line"><span class="comment"># vm100 has its disk /root/jason/vm/test/vm100.qcow2</span></span><br><span class="line">$ guestfish --ro -d vm100 -i</span><br><span class="line">Welcome to guestfish, the guest filesystem shell <span class="keyword">for</span></span><br><span class="line">editing virtual machine filesystems and disk images.</span><br><span class="line"></span><br><span class="line">Type: <span class="string">&#x27;help&#x27;</span> <span class="keyword">for</span> <span class="built_in">help</span> on commands</span><br><span class="line">      <span class="string">&#x27;man&#x27;</span> to <span class="built_in">read</span> the manual</span><br><span class="line">      <span class="string">&#x27;quit&#x27;</span> to quit the shell</span><br><span class="line"></span><br><span class="line">Operating system: CentOS Linux release 7.8.2003 (Core)</span><br><span class="line">/dev/sda1 mounted on /</span><br><span class="line"></span><br><span class="line">&gt;&lt;fs&gt; <span class="built_in">df</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ ps -ef | grep kvm</span><br><span class="line">/usr/libexec/qemu-kvm -global virtio-blk-pci.scsi=off -nodefconfig -enable-fips -nodefaults -display none -cpu host -machine accel=kvm:tcg -m 500 -no-reboot -rtc driftfix=slew -no-hpet -global kvm-pit.lost_tick_policy=discard -kernel /var/tmp/.guestfs-0/appliance.d/kernel -initrd /var/tmp/.guestfs-0/appliance.d/initrd -device virtio-scsi-pci,<span class="built_in">id</span>=scsi -drive file=/tmp/libguestfsKuVs4B/overlay1,cache=unsafe,format=qcow2,<span class="built_in">id</span>=hd0,<span class="keyword">if</span>=none -device scsi-hd,drive=hd0 -drive file=/var/tmp/.guestfs-0/appliance.d/root,snapshot=on,<span class="built_in">id</span>=appliance,cache=unsafe,<span class="keyword">if</span>=none -device scsi-hd,drive=appliance -device virtio-serial-pci -serial stdio -device sga -chardev socket,path=/tmp/libguestfsKuVs4B/guestfsd.sock,<span class="built_in">id</span>=channel0 -device virtserialport,chardev=channel0,name=org.libguestfs.channel.0 -append panic=1 console=ttyS0 udevtimeout=6000 udev.event-timeout=6000 no_timer_check acpi=off printk.time=1 cgroup_disable=memory root=/dev/sdb selinux=0 TERM=xterm-256color</span><br><span class="line"></span><br><span class="line"><span class="comment"># kernel: /var/tmp/.guestfs-0/appliance.d/kernel</span></span><br><span class="line"><span class="comment"># initrd: /var/tmp/.guestfs-0/appliance.d/initrd</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># disk /tmp/libguestfsKuVs4B/overlay1 whoes backing file is /root/jason/vm/test/vm100.qcow2!!!</span></span><br><span class="line">$ file /tmp/libguestfsKuVs4B/overlay1</span><br><span class="line">/tmp/libguestfsKuVs4B/overlay1: QEMU QCOW Image (v3), has backing file (path /root/jason/vm/test/vm100.qcow2), 8589934592 bytes</span><br></pre></td></tr></table></figure>

<p><strong>NOTE</strong></p>
<ul>
<li>The guest fish vm started by libvirt by default, you can <code>LIBGUESTFS_BACKEND=direct</code> to start it directly</li>
<li>libvirtd is not a must for guestfish, but if you use <code>-d $domain</code> option, you must start libvirtd as guest fish need to get the info(disk info) from libvirtd</li>
</ul>
<h1 id="virsh-command-groups"><a href="#virsh-command-groups" class="headerlink" title="virsh command groups"></a>virsh command groups</h1><h2 id="vm-xml"><a href="#vm-xml" class="headerlink" title="vm xml"></a>vm xml</h2><p>Use virsh to edit VM XML </p>
<ul>
<li>Virtual Networks: net-edit, net-dumpxml</li>
<li>Storage Pools: pool-edit, pool-dumpxml</li>
<li>Storage Volumes: vol-edit, vol-dumpxml</li>
<li>Interfaces: iface-edit, iface-dumpxml</li>
</ul>
<p><strong>Redefining the XML of a running machine will not change anything, the changes will take effect after the next VM start up</strong></p>
<h2 id="Command-groups"><a href="#Command-groups" class="headerlink" title="Command groups"></a>Command groups</h2><h3 id="Domain-management"><a href="#Domain-management" class="headerlink" title="Domain management"></a>Domain management</h3><ul>
<li>virsh console</li>
<li>virsh define (define a guest domain from xml file)</li>
<li>virsh destroy(immediately terminates a running vm)</li>
<li>virsh undefine(remove cfg for an inactive vm)</li>
<li>virsh domjobinfo(return info about jobs running on a domain)</li>
<li>virsh dumpxml(output current vm info <code>/var/run/libvirt/qemu/$domain.xml</code> to stdout)</li>
<li>virsh edit(edit the XML cfg for a vm located at <code>/etc/libvirtd/qemu/$domain.xml</code>, take affect at next <code>virsh start</code>)</li>
<li>virsh migrate(migrate vm to another host)</li>
<li>virsh suspend&#x2F;resume&#x2F;start&#x2F;shutdown&#x2F;reboot&#x2F;reset&#x2F;save&#x2F;restore<ul>
<li>shutdown&#x2F;reboot   <code>gracefully from guest like type command from guest</code></li>
<li>destroy&#x2F;reset     <code>forcely from outside like press power button</code></li>
</ul>
</li>
<li>virsh setmem&#x2F;setvcpus</li>
<li>virsh vcpuinfo&#x2F;vcpucount&#x2F;vcpupin</li>
<li>virsh domiflist</li>
<li>virsh attach-device (attach device from an XML file, device can be interface, disk etc)</li>
</ul>
<h3 id="Domain-monitor"><a href="#Domain-monitor" class="headerlink" title="Domain monitor"></a>Domain monitor</h3><ul>
<li>virsh domblkinfo &#x2F; dominfo</li>
<li>virsh domblkstat &#x2F;domifstat &#x2F;dommemstat</li>
<li>virsh domstate</li>
<li>virsh list –all</li>
</ul>
<h3 id="Domain-Snapshot"><a href="#Domain-Snapshot" class="headerlink" title="Domain Snapshot"></a>Domain Snapshot</h3><ul>
<li>virsh snapshot-create </li>
<li>virsh snapshot-delete </li>
<li>virsh snapshot-list</li>
<li>virsh snapshot-revert</li>
</ul>
<h3 id="Host-and-Hypervisor"><a href="#Host-and-Hypervisor" class="headerlink" title="Host and Hypervisor"></a>Host and Hypervisor</h3><ul>
<li>virsh capabilities</li>
<li>virsh nodeinfo</li>
<li>virsh uri</li>
</ul>
<h3 id="Network-Interface"><a href="#Network-Interface" class="headerlink" title="Network Interface"></a>Network Interface</h3><ul>
<li>virsh iface-dumpxml</li>
<li>virsh iface-list &#x2F; iface-name &#x2F; iface-mac</li>
<li>virsh iface-define &#x2F; iface-undefine</li>
<li>virsh iface-start &#x2F; iface-destroy</li>
<li>virsh iface-edit</li>
</ul>
<h3 id="Network"><a href="#Network" class="headerlink" title="Network"></a>Network</h3><ul>
<li>virsh net-create &#x2F; net-destroy</li>
<li>virsh net-edit &#x2F; net-dumpxml</li>
<li>virsh net-define &#x2F; net-undefine</li>
<li>virsh net-start</li>
<li>virsh net-info &#x2F; net-list &#x2F; net-name</li>
</ul>
<h3 id="Node-device"><a href="#Node-device" class="headerlink" title="Node device"></a>Node device</h3><ul>
<li>virsh nodedev-create</li>
<li>virsh nodedev-reattach &#x2F; nodedev-dettach</li>
<li>virsh nodedev-destroy</li>
<li>virsh nodedev-dumpxml</li>
<li>virsh nodedev-list</li>
</ul>
<h3 id="Storage-pool"><a href="#Storage-pool" class="headerlink" title="Storage pool"></a>Storage pool</h3><ul>
<li>virsh pool-create &#x2F; pool-destroy &#x2F; pool-delete</li>
<li>virsh pool-define &#x2F; pool-undefine</li>
<li>virsh pool-start</li>
<li>virsh pool-list &#x2F; pool-dumpxml</li>
<li>virsh pool-edit &#x2F; pool-info</li>
</ul>
<h3 id="Storage-Volume"><a href="#Storage-Volume" class="headerlink" title="Storage Volume"></a>Storage Volume</h3><ul>
<li>virsh vol-create &#x2F; vol-delete</li>
<li>virsh vol-info &#x2F;vol-list</li>
</ul>
<h3 id="event"><a href="#event" class="headerlink" title="event"></a>event</h3><p>libvirt supports several type events can be monitored by client, they are <code>domain event, qemu monitor event, network event, storage pool event, nodedev event</code></p>
<ul>
<li>virsh event(domain event)</li>
<li>virsh qemu-monitor-event</li>
<li>virsh net-event</li>
<li>virsh nodedev-event</li>
<li>virsh pool-event</li>
<li>virsh secret-event</li>
</ul>
<h3 id="blk"><a href="#blk" class="headerlink" title="blk"></a>blk</h3><ul>
<li>virsh domblklist centos10</li>
<li>virsh attach-disk &#x2F;detach-disk</li>
</ul>
<blockquote>
<p>libvirtd supports three modes of attaching a disk to vm, <code>--config, --live, --persistent</code> by default it’s <code>--live</code></p>
<ul>
<li><code>--config</code>, new disk setting only write to <code>/etc/libvirt/qemu/$doman.xml</code>, only take affect after <code>virsh destroy</code> then <code>virsh start</code>. <code>virsh reset</code>, <code>virsh reboot</code> is not sufficient.</li>
<li><code>--live</code>, new disk setting only in memory of running vm, you can see it by <code>virsh dumpxml $domain</code> or <code>/var/run/libvirt/qemu/$domain.xml</code>, take affect immediately, no written to <code>/etc/libvirt/qemu/$doman.xml</code>, <code>virsh reset</code> and <code>virsh reboot</code> you still can see it, but if you <code>virsh destroy</code> and <code>virsh start</code>, the new disk is gone as it’s not written to that file, <code>/var/run/libvirt/qemu/$domain.xml</code> is deleted after <code>virsh destroy</code>, &#96;&#96;&#x2F;etc&#x2F;libvirt&#x2F;qemu&#x2F;$doman.xml<code>is used for</code>virsh start&#96;.</li>
<li><code>--persistent</code> &#x3D;&#x3D; <code>--config</code> + <code>--live</code>, that means new disk setting is in memory(<code>/var/run/libvirt/qemu/$domain.xml</code>) and disk(<code>/etc/libvirt/qemu/$doman.xml</code>)</li>
<li><code>--current</code>, If the VM is offline, use –config. If the VM is running, use –live.</li>
</ul>
</blockquote>
<h1 id="trobleshooting"><a href="#trobleshooting" class="headerlink" title="trobleshooting"></a>trobleshooting</h1><h2 id="conf-runtime-files"><a href="#conf-runtime-files" class="headerlink" title="conf runtime files"></a>conf runtime files</h2><p><strong>Related Paths:</strong></p>
<ul>
<li>&#x2F;etc&#x2F;libvirt&#x2F;</li>
<li>&#x2F;etc&#x2F;sysconfig&#x2F;libvirtd(<code>it&#39;s a file</code>)</li>
<li>&#x2F;var&#x2F;run&#x2F;libvirt&#x2F;</li>
<li>&#x2F;var&#x2F;log&#x2F;libvirt&#x2F;</li>
<li>&#x2F;var&#x2F;lib&#x2F;libvirt&#x2F;</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /etc/libvirt/libvirtd.conf: global conf of libvirtd</span></span><br><span class="line"><span class="comment"># /etc/sysconfig/libvirtd: override libvirtd.conf</span></span><br><span class="line"><span class="comment"># /usr/lib/systemd/system/libvirtd.service： systemd service</span></span><br><span class="line"><span class="comment"># /etc/libvirt/qemu/networks/default.xml: default network</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># /var/run/libvirt: runtime of daemon, like daemon socket/pid of each vm</span></span><br><span class="line">$ <span class="built_in">ls</span> /var/run/libvirt/</span><br><span class="line">hostdevmgr  libvirt-admin-sock  libvirt-sock  libvirt-sock-ro  lxc  network  qemu  storage  virtlockd-sock  virtlogd-sock</span><br><span class="line"></span><br><span class="line"><span class="comment"># hostdevmgr network storage: setting for device, networking(rules), volume(pool, local disk)</span></span><br><span class="line"><span class="comment"># libvirt-admin-sock libvirt-sock libvirt-sock-ro: sock for admin, readonly etc</span></span><br><span class="line"><span class="comment"># lxc qemu: xml/pid of each instance, will go when boots</span></span><br><span class="line"><span class="comment"># virtlockd-sock  virtlogd-sock: sock of locked and virtlogd</span></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">ls</span> /var/run/libvirt/qemu/</span><br><span class="line">centos.pid centos.xml </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># /var/log/libvirt: logs of VM from vm console and part logs from libvirtd</span></span><br><span class="line">$ <span class="built_in">ls</span> /var/log/libvirt/qemu/</span><br><span class="line">centos.log</span><br><span class="line"></span><br><span class="line"><span class="comment"># by default libvirtd writes logs to /var/log/message(centos) /var/log/syslog(ubuntu)</span></span><br><span class="line"><span class="comment"># default: log_outputs=&quot;3:syslog:libvirtd&quot;</span></span><br><span class="line"><span class="comment"># change it to any file by editing /etc/libvirt/libvirtd.conf</span></span><br><span class="line"><span class="comment">#    1: DEBUG                                                                   </span></span><br><span class="line"><span class="comment">#    2: INFO                                                                    </span></span><br><span class="line"><span class="comment">#    3: WARNING                                                                 </span></span><br><span class="line"><span class="comment">#    4: ERROR</span></span><br><span class="line"><span class="comment"># only log of level large or equal to 2 are sent to file</span></span><br><span class="line">log_level = 1</span><br><span class="line">log_outputs=<span class="string">&quot;2:file:/var/log/libvirt/libvirtd.log&quot;</span>  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># /etc/libvirt: daemon conf and persistent XML of VMS located at qemu/</span></span><br><span class="line">$ <span class="built_in">ls</span> /etc/libvirt/</span><br><span class="line">libvirt-admin.conf  libvirtd.conf      nwfilter/  qemu.conf   virtlogd.conf</span><br><span class="line">libvirt.conf        qemu/   virtlockd.conf </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ <span class="built_in">ls</span> /var/lib/libvirt</span><br><span class="line">dnsmasq  filesystems/  images/  network/  qemu/</span><br><span class="line"></span><br><span class="line"><span class="comment"># snapshot saves the xml of snapshot, data of snapshot is saved into image by default(internal snapshot)!!</span></span><br><span class="line"><span class="comment"># save/ holds the managed save(cpu/memory)</span></span><br><span class="line">$ <span class="built_in">ls</span> /var/lib/libvirt/qemu/</span><br><span class="line">channel/  domain-1-centos  save/  snapshot/</span><br><span class="line"></span><br><span class="line"><span class="comment"># socket of this Vm like qmp socket etc</span></span><br><span class="line">$ <span class="built_in">ls</span> /var/lib/libvirt/qemu/domain-1-centos</span><br><span class="line">master-key.aes  monitor.sock</span><br><span class="line"></span><br><span class="line"><span class="comment"># socket of this vm for QGA channel</span></span><br><span class="line">$ <span class="built_in">ls</span> /var/lib/libvirt/qemu/channel/target/domain-1-centos/</span><br><span class="line">org.qemu.guest_agent.0</span><br></pre></td></tr></table></figure>

<h2 id="libvirt-log"><a href="#libvirt-log" class="headerlink" title="libvirt log"></a>libvirt log</h2><p><img src="https://cyun.tech/images/libvirt/libvirtd_domain_log.svg"></p>
<p><strong>libvirtd.conf</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">log_level = 1</span><br><span class="line">log_outputs=&quot;1:file:/var/log/libvirt/libvirtd.log&quot;</span><br><span class="line">keepalive_interval=60</span><br><span class="line">admin_keepalive_interval=60</span><br></pre></td></tr></table></figure>

<p><strong>qemu.conf</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># use virtlogd as backend</span><br><span class="line">stdio_handler = &quot;logd&quot;</span><br></pre></td></tr></table></figure>

<p><strong>virtlogd.conf</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">log_level = 1 </span><br><span class="line">log_outputs=&quot;1:file:/var/log/libvirt/virtlogd.log&quot; </span><br></pre></td></tr></table></figure>

<h1 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h1><h2 id="Difference-between-qemu-x2F-x2F-x2F-system-and-qemu-x2F-x2F-x2F-session-Which-one-should-I-use"><a href="#Difference-between-qemu-x2F-x2F-x2F-system-and-qemu-x2F-x2F-x2F-session-Which-one-should-I-use" class="headerlink" title="Difference between qemu:&#x2F;&#x2F;&#x2F;system and qemu:&#x2F;&#x2F;&#x2F;session, Which one should I use?"></a>Difference between qemu:&#x2F;&#x2F;&#x2F;system and qemu:&#x2F;&#x2F;&#x2F;session, Which one should I use?</h2><p>All ‘system’ URIs (be it qemu, lxc, uml, …) connect to the libvirtd daemon running as root which is launched at system startup. <code>Virtual machines created and run using &#39;system&#39; are usually launched as root</code></p>
<p>All ‘session’ URIs launch a libvirtd instance as your local user, and all VMs are run with local user permissions.<br>You will definitely want to use qemu:&#x2F;&#x2F;&#x2F;system if your VMs are acting as servers. <code>VM autostart on host boot only works for &#39;system&#39;, and the root libvirtd instance has necessary permissions to use proper networking via bridges or virtual networks</code></p>
<h2 id="Migration"><a href="#Migration" class="headerlink" title="Migration"></a>Migration</h2><p>There are two primary types of migration with QEMU&#x2F;KVM and libvirt:</p>
<ul>
<li><p>Plain migration: <code>The source host VM opens a direct unencrypted TCP connection to the destination host for sending the migration data</code>. Unless a port is manually specified, libvirt will choose a migration port in the range 49152-49215, which will need to be open in the firewall on the remote host.</p>
</li>
<li><p>Tunneled migration: The source host libvirtd opens a direct connection to the destination host libvirtd for sending migration data. This allows the option of <code>encrypting the data stream</code>. This mode doesn’t require any extra firewall configuration, but is only supported with qemu 0.12.0 or later, and libvirt 0.7.2.</p>
</li>
</ul>
<p>For all QEMU&#x2F;KVM migrations, <code>libvirtd must be running on the source and destination host</code>.</p>
<ul>
<li><p>For tunneled migration, no extra configuration should be required, you simply need to pass the –tunnelled flag to virsh migrate.</p>
</li>
<li><p>For plain unencrypted migration, the TCP port range 49152-49215 must be opened in the firewall on the destination host.</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">virsh migrate <span class="variable">$domain</span> <span class="variable">$REMOTE_HOST_URI</span> --migrateuri tcp://<span class="variable">$REMOTE_HOST</span></span><br></pre></td></tr></table></figure>

<h2 id="How-to-import-a-vm-from-a-terminal-no-X-display"><a href="#How-to-import-a-vm-from-a-terminal-no-X-display" class="headerlink" title="How to import a vm from a terminal(no X display)"></a>How to import a vm from a terminal(no X display)</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ virsh net-list</span><br><span class="line"></span><br><span class="line">$ virt-install --name guest1-rhel7 --memory 2048 --vcpus 2 --disk /home/data/tmp/CentOS-7-x86_64-GenericCloud-1503.qcow2 --import --os-type linux --<span class="built_in">wait</span> 0 --network default</span><br><span class="line"><span class="comment"># OR</span></span><br><span class="line">$ virt-install --name guest1-rhel7 --memory 2048 --vcpus 2 --disk /home/data/tmp/CentOS-7-x86_64-GenericCloud-1503.qcow2 --import --os-type linux --<span class="built_in">wait</span> 0 --network none</span><br><span class="line"><span class="comment"># must set wait 0, otherwise, it will show &#x27;Domain installation still in progress. Waiting for installation to complete&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="How-to-install-a-VM-from-a-terminal"><a href="#How-to-install-a-VM-from-a-terminal" class="headerlink" title="How to install a VM from a terminal"></a>How to install a VM from a terminal</h2><p>Here we use image from remote by –location parameters</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">-l LOCATION , --location=LOCATION</span><br><span class="line">Distribution tree installtion source. virt-install can recognize certain distribution trees and fetches a bootable kernel/initrd pair to launch the install. </span><br><span class="line"></span><br><span class="line">The &quot;LOCATION&quot; can take one of the following forms:</span><br><span class="line">DIRECTORY</span><br><span class="line">    Path to a local directory containing an installable distribution image </span><br><span class="line">nfs:host:/path or nfs://host/path</span><br><span class="line">    An NFS server location containing an installable distribution image </span><br><span class="line">http://host/path</span><br><span class="line">    An HTTP server location containing an installable distribution image </span><br><span class="line">ftp://host/path</span><br><span class="line">    An FTP server location containing an installable distribution image </span><br><span class="line"></span><br><span class="line">centos 7</span><br><span class="line">--location &#x27;http://mirror.i3d.net/pub/centos/7/os/x86_64/&#x27;</span><br><span class="line"></span><br><span class="line">ubuntu(different versions has different url)</span><br><span class="line">--location &#x27;http://archive.ubuntu.com/ubuntu/dists/trusty/main/installer-amd64/&#x27;</span><br><span class="line">--location &#x27;http://archive.ubuntu.com/ubuntu/dists/bionic/main/installer-amd64/&#x27;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ virt-install --name ubuntu --memory 2048 --vcpus 2 --disk size=8 --location <span class="string">&#x27;http://archive.ubuntu.com/ubuntu/dists/bionic/main/installer-amd64/&#x27;</span> --os-type linux --graphics none --extra-args <span class="string">&quot;console=tty0 console=ttyS0,115200n8&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="how-to-change-something-of-disk-without-boot-it"><a href="#how-to-change-something-of-disk-without-boot-it" class="headerlink" title="how to change something of disk without boot it"></a>how to change something of disk without boot it</h2><p>virt-sysprep(only support linux!!!) can reset or unconfigure a virtual machine so that clones can be made from it.  Steps in this process include <code>removing SSH host keys, removing persistent network MAC configuration, and removing user accounts</code>.  virt-sysprep can also customize a virtual machine, for instance by adding SSH keys, users or logos.  Each step can be enabled or disabled as required..</p>
<p><strong>Usage</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">virt-sysprep [--options] -d domname</span><br><span class="line">virt-sysprep [--options] -a disk.img [-a disk.img ...]</span><br></pre></td></tr></table></figure>

<p><strong>NOTE</strong><br>virt-sysprep <strong>modifies the guest or disk image in place</strong></p>
<ul>
<li>The virtual machine must be shut down before.</li>
<li>disk images must not be edited concurrently.</li>
<li>virt-sysprep depends on libvirt running by default</li>
<li>export LIBGUESTFS_BACKEND&#x3D;direct virt-sysprep ..(start qemu without libvirtd)</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># NO wildcards supported for below three </span></span><br><span class="line"><span class="comment"># --copy SOURCE:DEST  inside vm</span></span><br><span class="line"><span class="comment"># --copy-in LOCALPATH:REMOTEDIR   from host to guest</span></span><br><span class="line"><span class="comment"># --move SOURCE:DEST  inside vm</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --mkdir DIR </span></span><br><span class="line"><span class="comment"># --delete PATH support wildcards</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --install PKG,PKG.   use guest pkg manager and host network</span></span><br><span class="line"><span class="comment"># --uninstall PKG,PKG  use guest pkg manager</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># This will start a temporary vm</span></span><br><span class="line">$ virt-sysprep --root-password password:<span class="variable">$new</span> --uninstall cloud-init --selinux-relabel -a  CentOS-7-x86_64-GenericCloud.qcow2 </span><br></pre></td></tr></table></figure>
<h2 id="How-to-reset-a-user-password-of-domain"><a href="#How-to-reset-a-user-password-of-domain" class="headerlink" title="How to reset a user password of domain"></a>How to reset a user password of domain</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># There are two ways to do this</span></span><br><span class="line"><span class="comment">##################Way 1################################################</span></span><br><span class="line"><span class="comment"># if qemu-ga is running, we can change it runtime, no need to restart vm</span></span><br><span class="line"><span class="comment"># QGA: guest-set-user-password</span></span><br><span class="line"><span class="variable">$virsh</span> set-user-password vm100 root root</span><br><span class="line"></span><br><span class="line"><span class="comment">##################Way 2################################################</span></span><br><span class="line"><span class="comment"># if no qemu-ga or qemu-ga is not working use this way</span></span><br><span class="line"><span class="comment"># shutdown it first</span></span><br><span class="line">$ virsh shutdown <span class="variable">$domain</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># generate your password</span></span><br><span class="line">$ openssl passwd -1 <span class="variable">$yourpassword</span></span><br><span class="line">$6<span class="variable">$FU5Nl9oxxxx</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># mount the disk with read/write mode(--verbose for debugging)</span></span><br><span class="line">$ guestfish --rw -a /var/lib/libvirt/images/debian9-vm1.qcow2 -i</span><br><span class="line"></span><br><span class="line"><span class="comment"># oneshot mount</span></span><br><span class="line">$ guestmount -a disk.img -i /tmp/disk --verbose</span><br><span class="line"></span><br><span class="line">&gt;&lt;fs&gt; vi /etc/shadow</span><br><span class="line"><span class="comment"># modify password</span></span><br><span class="line">root:$6<span class="variable">$FU5Nl9oxxxx</span>:17572:0:99999:7:::</span><br><span class="line"></span><br><span class="line">&gt;&lt;fs&gt; flush</span><br><span class="line">&gt;&lt;fs&gt; quit</span><br><span class="line"></span><br><span class="line"><span class="comment"># OR you can do it with just one command who does simliar operation for you</span></span><br><span class="line">$ virt-sysprep --root-password password:<span class="variable">$new</span> -a CentOS-7-x86_64-GenericCloud.qcow2</span><br></pre></td></tr></table></figure>

<h2 id="how-to-change-log-level-without-libvirt-restart"><a href="#how-to-change-log-level-without-libvirt-restart" class="headerlink" title="how to change log level without libvirt restart"></a>how to change log level without libvirt restart</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1: DEBUG  </span></span><br><span class="line"><span class="comment"># 2: INFO   </span></span><br><span class="line"><span class="comment"># 3: WARNING     </span></span><br><span class="line"><span class="comment"># 4: ERROR</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># each source file register log with a tag</span></span><br><span class="line"><span class="comment"># filter supports wildcard match</span></span><br><span class="line"><span class="comment"># that means libvirt.xxx also matches here!!!</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># log_filters=&quot;1:libvirt 1:daemon 1:rpc&quot;</span></span><br><span class="line"><span class="comment"># log_outputs=&quot;1:file:/var/log/libvirt/libvirtd.log 2:syslog:libvirtd&quot;</span></span><br><span class="line"></span><br><span class="line">$ virt-admin daemon-log-filters</span><br><span class="line"></span><br><span class="line">$ virt-admin daemon-log-filters <span class="string">&quot;1:libvirt 1:daemon 1:rpc&quot;</span></span><br><span class="line">$ virt-admin daemon-log-filters</span><br><span class="line">Logging filters: 1:*libvirt* 1:*daemon* 1:*rpc* </span><br><span class="line"></span><br><span class="line">$ virt-admin daemon-log-outputs</span><br><span class="line">Logging outputs: 1:file:/var/log/libvirt/libvirtd.log</span><br><span class="line"></span><br><span class="line">$ virt-admin daemon-log-outputs <span class="string">&quot;2:file:/var/log/libvirt/libvirtd.log&quot;</span></span><br></pre></td></tr></table></figure>
<h2 id="how-to-enable-client-library-log"><a href="#how-to-enable-client-library-log" class="headerlink" title="how to enable client library log"></a>how to enable client library log</h2><p>By default the client library doesn’t produce any logs and usually usually it’s not very interesting on its own anyway.<br>The library configuration of logging is through 3 environment variables allowing to control the logging behaviour:</p>
<ul>
<li><code>LIBVIRT_DEBUG</code>: it can take the four following values:<ul>
<li>1 or “debug”: asking the library to log every message emitted, though the filters can be used to avoid filling up the output</li>
<li>2 or “info”: log all non-debugging information</li>
<li>3 or “warn”: log warnings and errors, that’s the default value</li>
<li>4 or “error”: log only error messages</li>
</ul>
</li>
<li><code>LIBVIRT_LOG_FILTERS</code>: defines logging filters</li>
<li><code>LIBVIRT_LOG_OUTPUTS</code>: defines logging outputs</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">export</span> LIBVIRT_DEBUG=debug</span><br><span class="line">$ <span class="built_in">export</span> LIBVIRT_LOG_OUTPUTS=<span class="string">&quot;1:file:/tmp/libvirt_client.log&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="how-to-enable-libvirtd-on-tcp-without-tls"><a href="#how-to-enable-libvirtd-on-tcp-without-tls" class="headerlink" title="how to enable libvirtd on tcp without tls"></a>how to enable libvirtd on tcp without tls</h2><p><strong>libvirtd.conf</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">listen_tls = 0</span><br><span class="line">listen_tcp = 1</span><br><span class="line">auth_tcp = &quot;none&quot;</span><br></pre></td></tr></table></figure>

<p><strong>&#x2F;etc&#x2F;sysconfig&#x2F;libvirtd</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LIBVIRTD_ARGS=&quot;--listen&quot;</span><br></pre></td></tr></table></figure>

<p><strong>&#x2F;etc&#x2F;libvirt&#x2F;libvirt.conf</strong></p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># tell virsh use this uri by default</span><br><span class="line">uri_default = &quot;qemu+tcp://127.0.0.1:16509/system&quot;</span><br></pre></td></tr></table></figure>
<h2 id="Why-doesn’t-‘shutdown’-seem-to-work"><a href="#Why-doesn’t-‘shutdown’-seem-to-work" class="headerlink" title="Why doesn’t ‘shutdown’ seem to work?"></a>Why doesn’t ‘shutdown’ seem to work?</h2><p>If you are using Xen HVM or QEMU&#x2F;KVM, <strong>ACPI must be enabled in the guest for a graceful shutdown to work</strong>. To check if ACPI is enabled, run:</p>
<p><code>virsh dumpxml $your-vm-name | grep acpi</code></p>
<p>If nothing is printed, ACPI is not enabled for your machine. Use ‘virsh edit’ to add the following XML under <domain>:</p>
<p><features><acpi/></features></p>
<p><strong>If your VM is running Linux, the VM additionally needs to be running acpid to receive the ACPI events</strong><br><code>yum install acpid</code></p>
<h2 id="When-lt-input-gt-device-is-used"><a href="#When-lt-input-gt-device-is-used" class="headerlink" title="When &lt;input&gt; device is used"></a>When <code>&lt;input&gt;</code> device is used</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">devices</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&#x27;mouse&#x27;</span> <span class="attr">bus</span>=<span class="string">&#x27;usb&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">devices</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>Input devices <strong>allow interaction with the graphical framebuffer in the guest virtual machine virtual machine</strong>. that means.</p>
<ul>
<li>For Desktop, you should configure mouse input, otherwise, you can only use keyboard</li>
<li>For Server without GUI, mouse input can be disable, as it no effect at all.</li>
</ul>
<h2 id="reduce-disk-image-file-not-disk-size"><a href="#reduce-disk-image-file-not-disk-size" class="headerlink" title="reduce disk image file not disk size"></a>reduce disk image file not disk size</h2><p>As most of time, disk is thin-provisioned, disk file grows when needed, <code>but after disk file grew, it can not be resize automatcially even you delete vm inside VM, lots of free space of this disk.</code></p>
<p><strong>NOTE</strong></p>
<ul>
<li><strong>The virtual machine must be shut down</strong></li>
<li><strong>disk images must not be edited concurrently.</strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># the new image is smaller(No snapshot is lost)</span></span><br><span class="line">$ qemu-img convert -O qcow2 centos7.img out.qcow2</span><br></pre></td></tr></table></figure>

<h2 id="run-kvm-machine-from-another-vm"><a href="#run-kvm-machine-from-another-vm" class="headerlink" title="run kvm machine from another vm"></a>run kvm machine from another vm</h2><p>if you plan to run vm from vm by libvirt, make sure <a target="_blank" rel="noopener" href="https://docs.fedoraproject.org/en-US/quick-docs/using-nested-virtualization-in-kvm/index.html">nested virtualization</a> is enabled on host, otherwise, you will meet error from libvirtd.log like this <code>invalid argument: could not find capabilities for arch=x86_64 domaintype=kvm</code>, the pass nested virtualization to vm who will plan to start new vm.</p>
<ul>
<li>enable nested virtualization on host</li>
<li>pass it to vm</li>
<li>from that vm start another kvm machine.</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># if you can run vm from another vm, check it by that vm</span></span><br><span class="line"><span class="comment"># run this in virtual vm which plans to start another vm.</span></span><br><span class="line">$ virt-host-validate</span><br><span class="line">  QEMU: Checking <span class="keyword">for</span> hardware virtualization                                 : PASS---&gt;nested virtulization is enabled</span><br><span class="line">  QEMU: Checking <span class="keyword">if</span> device /dev/kvm exists                                   : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">if</span> device /dev/kvm is accessible                            : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">if</span> device /dev/vhost-net exists                             : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">if</span> device /dev/net/tun exists                               : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;memory&#x27;</span> controller support                      : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;memory&#x27;</span> controller mount-point                  : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;cpu&#x27;</span> controller support                         : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;cpu&#x27;</span> controller mount-point                     : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;cpuacct&#x27;</span> controller support                     : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;cpuacct&#x27;</span> controller mount-point                 : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;cpuset&#x27;</span> controller support                      : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;cpuset&#x27;</span> controller mount-point                  : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;devices&#x27;</span> controller support                     : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;devices&#x27;</span> controller mount-point                 : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;blkio&#x27;</span> controller support                       : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;blkio&#x27;</span> controller mount-point                   : PASS</span><br><span class="line">  QEMU: Checking <span class="keyword">for</span> device assignment IOMMU support                         : WARN (No ACPI DMAR table found, IOMMU either disabled <span class="keyword">in</span> BIOS or not supported by this hardware platform)</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> Linux &gt;= 2.6.26                                         : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> namespace ipc                                           : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> namespace mnt                                           : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> namespace pid                                           : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> namespace uts                                           : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> namespace net                                           : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> namespace user                                          : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;memory&#x27;</span> controller support                      : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;memory&#x27;</span> controller mount-point                  : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;cpu&#x27;</span> controller support                         : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;cpu&#x27;</span> controller mount-point                     : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;cpuacct&#x27;</span> controller support                     : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;cpuacct&#x27;</span> controller mount-point                 : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;cpuset&#x27;</span> controller support                      : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;cpuset&#x27;</span> controller mount-point                  : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;devices&#x27;</span> controller support                     : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;devices&#x27;</span> controller mount-point                 : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;blkio&#x27;</span> controller support                       : PASS</span><br><span class="line">   LXC: Checking <span class="keyword">for</span> cgroup <span class="string">&#x27;blkio&#x27;</span> controller mount-point                   : PASS</span><br></pre></td></tr></table></figure>

<h2 id="monitor-event-from-command-line"><a href="#monitor-event-from-command-line" class="headerlink" title="monitor event from command line"></a>monitor event from command line</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># for event, check help first</span></span><br><span class="line">$ virsh event --<span class="built_in">help</span></span><br><span class="line">  NAME</span><br><span class="line">    event - Domain Events</span><br><span class="line"></span><br><span class="line">  SYNOPSIS</span><br><span class="line">    event [--domain &lt;string&gt;] [--event &lt;string&gt;] [--all] [--loop] [--<span class="built_in">timeout</span> &lt;number&gt;] [--list] [--timestamp]</span><br><span class="line"></span><br><span class="line">  DESCRIPTION</span><br><span class="line">    List event types, or <span class="built_in">wait</span> <span class="keyword">for</span> domain events to occur</span><br><span class="line"></span><br><span class="line">  OPTIONS</span><br><span class="line">    --domain &lt;string&gt;  filter by domain name, <span class="built_in">id</span> or uuid</span><br><span class="line">    --event &lt;string&gt;  <span class="built_in">which</span> event <span class="built_in">type</span> to <span class="built_in">wait</span> <span class="keyword">for</span></span><br><span class="line">    --all            <span class="built_in">wait</span> <span class="keyword">for</span> all events instead of just one <span class="built_in">type</span></span><br><span class="line">    --loop           loop until <span class="built_in">timeout</span> or interrupt, rather than one-shot</span><br><span class="line">    --<span class="built_in">timeout</span> &lt;number&gt;  <span class="built_in">timeout</span> seconds</span><br><span class="line">    --list           list valid event types</span><br><span class="line">    --timestamp      show timestamp <span class="keyword">for</span> each printed event</span><br><span class="line"></span><br><span class="line"><span class="comment"># all events of all domains</span></span><br><span class="line">$ virsh event --all --loop --timestamp</span><br><span class="line"></span><br><span class="line"><span class="comment"># default remote port is 16509</span></span><br><span class="line">$ virsh -c qemu+tcp://172.17.0.3/system  event --event lifecycle --loop</span><br><span class="line"></span><br><span class="line">$ virsh qemu-monitor-event --<span class="built_in">help</span></span><br><span class="line"> NAME</span><br><span class="line">    qemu-monitor-event - QEMU Monitor Events</span><br><span class="line"></span><br><span class="line">  SYNOPSIS</span><br><span class="line">    qemu-monitor-event [--domain &lt;string&gt;] [--event &lt;string&gt;] [--pretty] [--loop] [--<span class="built_in">timeout</span> &lt;number&gt;] [--regex] [--no-case] [--timestamp]</span><br><span class="line"></span><br><span class="line">  DESCRIPTION</span><br><span class="line">    Listen <span class="keyword">for</span> QEMU Monitor Events</span><br><span class="line"></span><br><span class="line">  OPTIONS</span><br><span class="line">    --domain &lt;string&gt;  filter by domain name, <span class="built_in">id</span> or uuid</span><br><span class="line">    --event &lt;string&gt;  filter by event name</span><br><span class="line">    --pretty         pretty-print any JSON output</span><br><span class="line">    --loop           loop until <span class="built_in">timeout</span> or interrupt, rather than one-shot</span><br><span class="line">    --<span class="built_in">timeout</span> &lt;number&gt;  <span class="built_in">timeout</span> seconds</span><br><span class="line">    --regex          treat event as a regex rather than literal filter</span><br><span class="line">    --no-case        treat event case-insensitively</span><br><span class="line">    --timestamp      show timestamp <span class="keyword">for</span> each printed event</span><br><span class="line"></span><br><span class="line"><span class="comment"># all qemu monitor event of all domains</span></span><br><span class="line">$ virsh qemu-monitor-event --loop --timestamp</span><br></pre></td></tr></table></figure>

<h2 id="monitor-performance-of-vm"><a href="#monitor-performance-of-vm" class="headerlink" title="monitor performance of vm"></a>monitor performance of vm</h2><p>Some platforms allow monitoring of performance of the virtual machine and the code executed inside. To enable the performance monitoring events you can either specify them in the perf element or enable them via virDomainSetPerfEvents API. The performance values are then retrieved using the virConnectGetAllDomainStats</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># check perf event status of given vm</span></span><br><span class="line">$ virsh perf vm100 </span><br><span class="line">cmt            : disabled</span><br><span class="line">mbmt           : disabled</span><br><span class="line">mbml           : disabled</span><br><span class="line">cpu_cycles     : enabled</span><br><span class="line">instructions   : disabled</span><br><span class="line">cache_references: disabled</span><br><span class="line">cache_misses   : disabled</span><br><span class="line">branch_instructions: disabled</span><br><span class="line">branch_misses  : disabled</span><br><span class="line">bus_cycles     : disabled</span><br><span class="line">stalled_cycles_frontend: disabled</span><br><span class="line">stalled_cycles_backend: disabled</span><br><span class="line">ref_cpu_cycles : disabled</span><br><span class="line">cpu_clock      : disabled</span><br><span class="line">task_clock     : disabled</span><br><span class="line">page_faults    : disabled</span><br><span class="line">context_switches: disabled</span><br><span class="line">cpu_migrations : disabled</span><br><span class="line">page_faults_min: disabled</span><br><span class="line">page_faults_maj: disabled</span><br><span class="line">alignment_faults: disabled</span><br><span class="line">emulation_faults: disabled</span><br><span class="line"></span><br><span class="line"><span class="comment"># enable perf event of given vm</span></span><br><span class="line">$ virsh perf vm100 --<span class="built_in">enable</span> page_faults --live</span><br><span class="line">$ virsh perf vm100 --<span class="built_in">enable</span> cache_misses --live</span><br><span class="line"></span><br><span class="line"><span class="comment"># get event stats</span></span><br><span class="line">$  virsh domstats vm100</span><br><span class="line">Domain: <span class="string">&#x27;vm100&#x27;</span></span><br><span class="line">  state.state=1</span><br><span class="line">  state.reason=1</span><br><span class="line">  cpu.time=544449957934</span><br><span class="line">  cpu.user=11320000000</span><br><span class="line">  cpu.system=95640000000</span><br><span class="line">  balloon.current=2048000</span><br><span class="line">  balloon.maximum=2048000</span><br><span class="line">  balloon.swap_in=0</span><br><span class="line">  balloon.swap_out=0</span><br><span class="line">  balloon.major_fault=179</span><br><span class="line">  balloon.minor_fault=131463</span><br><span class="line">  balloon.unused=1732652</span><br><span class="line">  balloon.available=1832708</span><br><span class="line">  balloon.usable=1673880</span><br><span class="line">  balloon.last-update=1659001628</span><br><span class="line">  balloon.rss=488752</span><br><span class="line">  vcpu.current=2</span><br><span class="line">  vcpu.maximum=2</span><br><span class="line">  vcpu.0.state=1</span><br><span class="line">  vcpu.0.time=159640000000</span><br><span class="line">  vcpu.0.wait=0</span><br><span class="line">  vcpu.1.state=1</span><br><span class="line">  vcpu.1.time=367810000000</span><br><span class="line">  vcpu.1.wait=0</span><br><span class="line">  net.count=0</span><br><span class="line">  block.count=1</span><br><span class="line">  block.0.name=vda</span><br><span class="line">  block.0.path=/tmp/vm100.qcow2</span><br><span class="line">  block.0.rd.reqs=5746</span><br><span class="line">  block.0.rd.bytes=145617408</span><br><span class="line">  block.0.rd.times=10162755968</span><br><span class="line">  block.0.wr.reqs=324</span><br><span class="line">  block.0.wr.bytes=4339200</span><br><span class="line">  block.0.wr.times=1200496823</span><br><span class="line">  block.0.fl.reqs=158</span><br><span class="line">  block.0.fl.times=4497529526</span><br><span class="line">  block.0.allocation=3385786368</span><br><span class="line">  block.0.capacity=8589934592</span><br><span class="line">  block.0.physical=3385360384</span><br><span class="line">  perf.cache_misses=11298</span><br><span class="line">  perf.page_faults=0</span><br></pre></td></tr></table></figure>

<h2 id="add-hotplug-cpu-to-guest-add-cpu-to-guest-without-rebooting-it"><a href="#add-hotplug-cpu-to-guest-add-cpu-to-guest-without-rebooting-it" class="headerlink" title="add hotplug cpu to guest(add cpu to guest without rebooting it)"></a>add hotplug cpu to guest(add cpu to guest without rebooting it)</h2><p><strong>you must set <code>maxcpus</code> for qemu to use hotpluggable cpu</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># check hotpluggable cpu</span></span><br><span class="line"><span class="comment"># no qom-path means it&#x27;s plugged out!!!</span></span><br><span class="line">$ virsh qemu-monitor-command  vm100 --pretty <span class="string">&#x27;&#123; &quot;execute&quot;: &quot;query-hotpluggable-cpus&quot;&#125;&#x27;</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;return&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;props&quot;</span>: &#123; </span><br><span class="line">        <span class="string">&quot;core-id&quot;</span>: 1,</span><br><span class="line">        <span class="string">&quot;thread-id&quot;</span>: 0,</span><br><span class="line">        <span class="string">&quot;node-id&quot;</span>: 0,</span><br><span class="line">        <span class="string">&quot;socket-id&quot;</span>: 0</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;vcpus-count&quot;</span>: 1,</span><br><span class="line">      <span class="string">&quot;type&quot;</span>: <span class="string">&quot;qemu64-x86_64-cpu&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;props&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;core-id&quot;</span>: 0,</span><br><span class="line">        <span class="string">&quot;thread-id&quot;</span>: 0,</span><br><span class="line">        <span class="string">&quot;node-id&quot;</span>: 0,</span><br><span class="line">        <span class="string">&quot;socket-id&quot;</span>: 0</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;vcpus-count&quot;</span>: 1,</span><br><span class="line">      <span class="string">&quot;qom-path&quot;</span>: <span class="string">&quot;/machine/unattached/device[0]&quot;</span>,</span><br><span class="line">      <span class="string">&quot;type&quot;</span>: <span class="string">&quot;qemu64-x86_64-cpu&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;id&quot;</span>: <span class="string">&quot;libvirt-21&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># add a hotpluggable cpu</span></span><br><span class="line">$ virsh qemu-monitor-command  vm100 --pretty <span class="string">&#x27;&#123; &quot;execute&quot;: &quot;device_add&quot;, &quot;arguments&quot;:&#123;&quot;id&quot;:&quot;cpu-2&quot;, &quot;driver&quot;:&quot;qemu64-x86_64-cpu&quot;, &quot;socket-id&quot;:&quot;0&quot;, &quot;core-id&quot;:&quot;1&quot;, &quot;thread-id&quot;:&quot;0&quot;&#125;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># query vcpu details</span></span><br><span class="line"><span class="variable">$virsh</span> qemu-monitor-command  vm100 --pretty <span class="string">&#x27;&#123; &quot;execute&quot;: &quot;query-cpus-fast&quot;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pluggable cpu and unpluggable cpu has different qom-paths!!!</span></span><br><span class="line"><span class="comment"># pluggable cpu sits at /machine/peripheral</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;return&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;arch&quot;</span>: <span class="string">&quot;x86&quot;</span>,</span><br><span class="line">      <span class="string">&quot;thread-id&quot;</span>: 17865,</span><br><span class="line">      <span class="string">&quot;props&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;core-id&quot;</span>: 0,</span><br><span class="line">        <span class="string">&quot;thread-id&quot;</span>: 0,</span><br><span class="line">        <span class="string">&quot;node-id&quot;</span>: 0,</span><br><span class="line">        <span class="string">&quot;socket-id&quot;</span>: 0</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;qom-path&quot;</span>: <span class="string">&quot;/machine/unattached/device[0]&quot;</span>,</span><br><span class="line">      <span class="string">&quot;cpu-index&quot;</span>: 0,</span><br><span class="line">      <span class="string">&quot;target&quot;</span>: <span class="string">&quot;x86_64&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;arch&quot;</span>: <span class="string">&quot;x86&quot;</span>,</span><br><span class="line">      <span class="string">&quot;thread-id&quot;</span>: 18887,</span><br><span class="line">      <span class="string">&quot;props&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;core-id&quot;</span>: 1,</span><br><span class="line">        <span class="string">&quot;thread-id&quot;</span>: 0,</span><br><span class="line">        <span class="string">&quot;node-id&quot;</span>: 0,</span><br><span class="line">        <span class="string">&quot;socket-id&quot;</span>: 0</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">&quot;qom-path&quot;</span>: <span class="string">&quot;/machine/peripheral/cpu-2&quot;</span>,</span><br><span class="line">      <span class="string">&quot;cpu-index&quot;</span>: 1,</span><br><span class="line">      <span class="string">&quot;target&quot;</span>: <span class="string">&quot;x86_64&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;id&quot;</span>: <span class="string">&quot;libvirt-28&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># inside the guest, there are two cpu now!!!</span></span><br></pre></td></tr></table></figure>

<h2 id="memory-deivce-and-share-memory"><a href="#memory-deivce-and-share-memory" class="headerlink" title="memory deivce and share memory"></a>memory deivce and share memory</h2><h3 id="without-hotplugable-memory-device"><a href="#without-hotplugable-memory-device" class="headerlink" title="without hotplugable memory device"></a>without hotplugable memory device</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">domain</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">maxMemory</span> <span class="attr">slots</span>=<span class="string">&quot;4&quot;</span> <span class="attr">unit</span>=<span class="string">&quot;GiB&quot;</span>&gt;</span>2<span class="tag">&lt;/<span class="name">maxMemory</span>&gt;</span>                                 </span><br><span class="line">  <span class="tag">&lt;<span class="name">cpu</span>&gt;</span>                                                                         </span><br><span class="line">    <span class="tag">&lt;<span class="name">topology</span> <span class="attr">sockets</span>=<span class="string">&quot;1&quot;</span> <span class="attr">cores</span>=<span class="string">&quot;2&quot;</span> <span class="attr">threads</span>=<span class="string">&quot;1&quot;</span>/&gt;</span>                               </span><br><span class="line">    <span class="tag">&lt;<span class="name">numa</span>&gt;</span>                                                                      </span><br><span class="line">      <span class="tag">&lt;<span class="name">cell</span> <span class="attr">id</span>=<span class="string">&quot;0&quot;</span> <span class="attr">cpus</span>=<span class="string">&quot;0-1&quot;</span> <span class="attr">memory</span>=<span class="string">&quot;1024&quot;</span> <span class="attr">unit</span>=<span class="string">&quot;MiB&quot;</span>/&gt;</span>         -----&gt; no need to set <span class="tag">&lt;<span class="name">memory</span>&gt;</span><span class="tag">&lt;/<span class="name">memory</span>&gt;</span>, it&#x27;s auto calcualted from <span class="tag">&lt;<span class="name">numa</span>&gt;</span><span class="tag">&lt;/<span class="name">numa</span>&gt;</span> if no <span class="tag">&lt;<span class="name">numa</span>&gt;</span> must set it!!!</span><br><span class="line">    <span class="tag">&lt;/<span class="name">numa</span>&gt;</span>                                                                     </span><br><span class="line">  <span class="tag">&lt;/<span class="name">cpu</span>&gt;</span></span><br><span class="line"></span><br><span class="line">libvirt auto generate xml /var/run/libvirt/qemu/$domain.xml</span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">maxMemory</span> <span class="attr">slots</span>=<span class="string">&#x27;4&#x27;</span> <span class="attr">unit</span>=<span class="string">&#x27;KiB&#x27;</span>&gt;</span>4194304<span class="tag">&lt;/<span class="name">maxMemory</span>&gt;</span>                         </span><br><span class="line">  <span class="tag">&lt;<span class="name">memory</span> <span class="attr">unit</span>=<span class="string">&#x27;KiB&#x27;</span>&gt;</span>1048576<span class="tag">&lt;/<span class="name">memory</span>&gt;</span>                                         </span><br><span class="line">  <span class="tag">&lt;<span class="name">currentMemory</span> <span class="attr">unit</span>=<span class="string">&#x27;KiB&#x27;</span>&gt;</span>1048576<span class="tag">&lt;/<span class="name">currentMemory</span>&gt;</span>  </span><br></pre></td></tr></table></figure>

<p><strong>check memory device</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># total memory info</span></span><br><span class="line">$ virsh qemu-monitor-command  vm100 --pretty <span class="string">&#x27;&#123; &quot;execute&quot;: &quot;query-memory-size-summary&quot;&#125;&#x27;</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;return&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;base-memory&quot;</span>: 1073741824,</span><br><span class="line">    <span class="string">&quot;plugged-memory&quot;</span>: 0</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;id&quot;</span>: <span class="string">&quot;libvirt-20&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># details about pluggable memory device</span></span><br><span class="line">$ virsh qemu-monitor-command  vm100 --pretty <span class="string">&#x27;&#123; &quot;execute&quot;: &quot;query-memory-devices&quot;&#125;&#x27;</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;return&quot;</span>: [</span><br><span class="line"></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;id&quot;</span>: <span class="string">&quot;libvirt-21&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Inside guest check memory</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kernel code used is not counted here</span></span><br><span class="line">$ free</span><br><span class="line">              total        used        free      shared  buff/cache   available</span><br><span class="line">Mem:         948532       77504      785368       12436       85660      750776</span><br><span class="line">Swap:             0           0           0</span><br><span class="line"></span><br><span class="line"><span class="comment"># show result in bytes</span></span><br><span class="line">$ lsmem -a -b</span><br><span class="line">$ lsmem -a</span><br><span class="line">RANGE                                  SIZE  STATE REMOVABLE BLOCK</span><br><span class="line">0x0000000000000000-0x0000000007ffffff  128M online        no     0</span><br><span class="line">0x0000000008000000-0x000000000fffffff  128M online       <span class="built_in">yes</span>     1</span><br><span class="line">0x0000000010000000-0x0000000017ffffff  128M online       <span class="built_in">yes</span>     2</span><br><span class="line">0x0000000018000000-0x000000001fffffff  128M online       <span class="built_in">yes</span>     3</span><br><span class="line">0x0000000020000000-0x0000000027ffffff  128M online       <span class="built_in">yes</span>     4</span><br><span class="line">0x0000000028000000-0x000000002fffffff  128M online        no     5</span><br><span class="line">0x0000000030000000-0x0000000037ffffff  128M online        no     6</span><br><span class="line">0x0000000038000000-0x000000003fffffff  128M online        no     7</span><br><span class="line"></span><br><span class="line">Memory block size:       128M</span><br><span class="line">Total online memory:       1G</span><br><span class="line">Total offline memory:      0B</span><br></pre></td></tr></table></figure>

<h3 id="with-hotplugable-memory-dimm-from-command-line"><a href="#with-hotplugable-memory-dimm-from-command-line" class="headerlink" title="with hotplugable memory(dimm) from command line"></a>with hotplugable memory(dimm) from command line</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">domain</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">maxMemory</span> <span class="attr">slots</span>=<span class="string">&quot;4&quot;</span> <span class="attr">unit</span>=<span class="string">&quot;GiB&quot;</span>&gt;</span>2<span class="tag">&lt;/<span class="name">maxMemory</span>&gt;</span>                                 </span><br><span class="line">  <span class="tag">&lt;<span class="name">cpu</span>&gt;</span>                                                                         </span><br><span class="line">    <span class="tag">&lt;<span class="name">topology</span> <span class="attr">sockets</span>=<span class="string">&quot;1&quot;</span> <span class="attr">cores</span>=<span class="string">&quot;2&quot;</span> <span class="attr">threads</span>=<span class="string">&quot;1&quot;</span>/&gt;</span>                               </span><br><span class="line">    <span class="tag">&lt;<span class="name">numa</span>&gt;</span>                                                                      </span><br><span class="line">      <span class="tag">&lt;<span class="name">cell</span> <span class="attr">id</span>=<span class="string">&quot;0&quot;</span> <span class="attr">cpus</span>=<span class="string">&quot;0-1&quot;</span> <span class="attr">memory</span>=<span class="string">&quot;1024&quot;</span> <span class="attr">unit</span>=<span class="string">&quot;MiB&quot;</span>/&gt;</span>         -----&gt; no need to set <span class="tag">&lt;<span class="name">memory</span>&gt;</span><span class="tag">&lt;/<span class="name">memory</span>&gt;</span>, it&#x27;s auto calcualted from <span class="tag">&lt;<span class="name">numa</span>&gt;</span><span class="tag">&lt;/<span class="name">numa</span>&gt;</span> if no <span class="tag">&lt;<span class="name">numa</span>&gt;</span> must set it!!!</span><br><span class="line">    <span class="tag">&lt;/<span class="name">numa</span>&gt;</span>                                                                     </span><br><span class="line">  <span class="tag">&lt;/<span class="name">cpu</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">devices</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">memory</span> <span class="attr">model</span>=<span class="string">&quot;dimm&quot;</span>&gt;</span>                                                       </span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span>&gt;</span>                                                                  </span><br><span class="line">        <span class="tag">&lt;<span class="name">size</span> <span class="attr">unit</span>=<span class="string">&quot;MiB&quot;</span>&gt;</span>256<span class="tag">&lt;/<span class="name">size</span>&gt;</span>                                             </span><br><span class="line">        <span class="tag">&lt;<span class="name">node</span>&gt;</span>0<span class="tag">&lt;/<span class="name">node</span>&gt;</span>                                                          </span><br><span class="line">      <span class="tag">&lt;/<span class="name">target</span>&gt;</span>                                                                 </span><br><span class="line">    <span class="tag">&lt;/<span class="name">memory</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">devices</span>&gt;</span></span><br><span class="line"></span><br><span class="line">libvirt auto generate xml /var/run/libvirt/qemu/$domain.xml</span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">maxMemory</span> <span class="attr">slots</span>=<span class="string">&#x27;4&#x27;</span> <span class="attr">unit</span>=<span class="string">&#x27;KiB&#x27;</span>&gt;</span>4194304<span class="tag">&lt;/<span class="name">maxMemory</span>&gt;</span>                         </span><br><span class="line">  <span class="tag">&lt;<span class="name">memory</span> <span class="attr">unit</span>=<span class="string">&#x27;KiB&#x27;</span>&gt;</span>1310720<span class="tag">&lt;/<span class="name">memory</span>&gt;</span>              ---&gt; ram(numa) + dimm</span><br><span class="line">  <span class="tag">&lt;<span class="name">currentMemory</span> <span class="attr">unit</span>=<span class="string">&#x27;KiB&#x27;</span>&gt;</span>1310720<span class="tag">&lt;/<span class="name">currentMemory</span>&gt;</span>---&gt; the memory you can see in guest with free = ram(numa + dimm)</span><br></pre></td></tr></table></figure>

<p><strong>check memory device</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># total memory info</span></span><br><span class="line">$ virsh qemu-monitor-command  vm100 --pretty <span class="string">&#x27;&#123; &quot;execute&quot;: &quot;query-memory-size-summary&quot;&#125;&#x27;</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;return&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;base-memory&quot;</span>: 1073741824,</span><br><span class="line">    <span class="string">&quot;plugged-memory&quot;</span>: 268435456</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;id&quot;</span>: <span class="string">&quot;libvirt-19&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># details about pluggable memory device</span></span><br><span class="line">$ virsh qemu-monitor-command  vm100 --pretty <span class="string">&#x27;&#123; &quot;execute&quot;: &quot;query-memory-devices&quot;&#125;&#x27;</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;return&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;type&quot;</span>: <span class="string">&quot;dimm&quot;</span>,</span><br><span class="line">      <span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;memdev&quot;</span>: <span class="string">&quot;/objects/memdimm0&quot;</span>,</span><br><span class="line">        <span class="string">&quot;hotplugged&quot;</span>: <span class="literal">false</span>, -------&gt;as hotpluggable memory device is from <span class="built_in">command</span> line(xml) not QMP <span class="built_in">command</span>, so it is not hotplugged!!</span><br><span class="line">        <span class="string">&quot;addr&quot;</span>: 4294967296,</span><br><span class="line">        <span class="string">&quot;hotpluggable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">&quot;size&quot;</span>: 268435456,</span><br><span class="line">        <span class="string">&quot;slot&quot;</span>: 0,</span><br><span class="line">        <span class="string">&quot;node&quot;</span>: 0,</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: <span class="string">&quot;dimm0&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;id&quot;</span>: <span class="string">&quot;libvirt-20&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Inside guest check memory</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kernel code used is not counted here</span></span><br><span class="line">$ free</span><br><span class="line">              total        used        free      shared  buff/cache   available</span><br><span class="line">Mem:        1210676       82836     1042392       12432       85448     1092196</span><br><span class="line">Swap:             0           0           0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># lsmem -a -b</span></span><br><span class="line">$ lsmem</span><br><span class="line">RANGE                                  SIZE  STATE REMOVABLE BLOCK</span><br><span class="line">0x0000000000000000-0x0000000007ffffff  128M online        no     0</span><br><span class="line">0x0000000008000000-0x000000000fffffff  128M online       <span class="built_in">yes</span>     1</span><br><span class="line">0x0000000010000000-0x0000000017ffffff  128M online       <span class="built_in">yes</span>     2</span><br><span class="line">0x0000000018000000-0x000000001fffffff  128M online        no     3</span><br><span class="line">0x0000000020000000-0x0000000027ffffff  128M online        no     4</span><br><span class="line">0x0000000028000000-0x000000002fffffff  128M online        no     5</span><br><span class="line">0x0000000030000000-0x0000000037ffffff  128M online        no     6</span><br><span class="line">0x0000000038000000-0x000000003fffffff  128M online        no     7</span><br><span class="line">0x0000000100000000-0x0000000107ffffff  128M online        no    32</span><br><span class="line">0x0000000108000000-0x000000010fffffff  128M online        no    33</span><br><span class="line"></span><br><span class="line">Memory block size:       128M</span><br><span class="line">Total online memory:     1.3G</span><br><span class="line">Total offline memory:      0B</span><br></pre></td></tr></table></figure>

<h3 id="with-hotplugable-memory-nvdimm-from-command-line"><a href="#with-hotplugable-memory-nvdimm-from-command-line" class="headerlink" title="with hotplugable memory(nvdimm) from command line"></a>with hotplugable memory(nvdimm) from command line</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">domain</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">maxMemory</span> <span class="attr">slots</span>=<span class="string">&quot;4&quot;</span> <span class="attr">unit</span>=<span class="string">&quot;GiB&quot;</span>&gt;</span>2<span class="tag">&lt;/<span class="name">maxMemory</span>&gt;</span>                                 </span><br><span class="line">  <span class="tag">&lt;<span class="name">cpu</span>&gt;</span>                                                                         </span><br><span class="line">    <span class="tag">&lt;<span class="name">topology</span> <span class="attr">sockets</span>=<span class="string">&quot;1&quot;</span> <span class="attr">cores</span>=<span class="string">&quot;2&quot;</span> <span class="attr">threads</span>=<span class="string">&quot;1&quot;</span>/&gt;</span>                               </span><br><span class="line">    <span class="tag">&lt;<span class="name">numa</span>&gt;</span>                                                                      </span><br><span class="line">      <span class="tag">&lt;<span class="name">cell</span> <span class="attr">id</span>=<span class="string">&quot;0&quot;</span> <span class="attr">cpus</span>=<span class="string">&quot;0-1&quot;</span> <span class="attr">memory</span>=<span class="string">&quot;1024&quot;</span> <span class="attr">unit</span>=<span class="string">&quot;MiB&quot;</span>/&gt;</span>         -----&gt; no need to set <span class="tag">&lt;<span class="name">memory</span>&gt;</span><span class="tag">&lt;/<span class="name">memory</span>&gt;</span>, it&#x27;s auto calcualted from <span class="tag">&lt;<span class="name">numa</span>&gt;</span><span class="tag">&lt;/<span class="name">numa</span>&gt;</span> if no <span class="tag">&lt;<span class="name">numa</span>&gt;</span> must set it!!!</span><br><span class="line">    <span class="tag">&lt;/<span class="name">numa</span>&gt;</span>                                                                     </span><br><span class="line">  <span class="tag">&lt;/<span class="name">cpu</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">devices</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">memory</span> <span class="attr">model</span>=<span class="string">&quot;dimm&quot;</span>&gt;</span>                                                       </span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span>&gt;</span>                                                                  </span><br><span class="line">        <span class="tag">&lt;<span class="name">size</span> <span class="attr">unit</span>=<span class="string">&quot;MiB&quot;</span>&gt;</span>256<span class="tag">&lt;/<span class="name">size</span>&gt;</span>                                             </span><br><span class="line">        <span class="tag">&lt;<span class="name">node</span>&gt;</span>0<span class="tag">&lt;/<span class="name">node</span>&gt;</span>                                                          </span><br><span class="line">      <span class="tag">&lt;/<span class="name">target</span>&gt;</span>                                                                 </span><br><span class="line">    <span class="tag">&lt;/<span class="name">memory</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">memory</span> <span class="attr">model</span>=<span class="string">&quot;nvdimm&quot;</span>&gt;</span>                                                     </span><br><span class="line">      <span class="tag">&lt;<span class="name">source</span>&gt;</span>                                                                  </span><br><span class="line">        <span class="tag">&lt;<span class="name">path</span>&gt;</span>/tmp/nvdimm<span class="tag">&lt;/<span class="name">path</span>&gt;</span>                                                </span><br><span class="line">      <span class="tag">&lt;/<span class="name">source</span>&gt;</span>                                                                 </span><br><span class="line">      <span class="tag">&lt;<span class="name">target</span>&gt;</span>                                                                  </span><br><span class="line">        <span class="tag">&lt;<span class="name">size</span> <span class="attr">unit</span>=<span class="string">&quot;MiB&quot;</span>&gt;</span>256<span class="tag">&lt;/<span class="name">size</span>&gt;</span>                                             </span><br><span class="line">        <span class="tag">&lt;<span class="name">node</span>&gt;</span>0<span class="tag">&lt;/<span class="name">node</span>&gt;</span>                                                          </span><br><span class="line">      <span class="tag">&lt;/<span class="name">target</span>&gt;</span>                                                                 </span><br><span class="line">    <span class="tag">&lt;/<span class="name">memory</span>&gt;</span>            </span><br><span class="line">  <span class="tag">&lt;/<span class="name">devices</span>&gt;</span></span><br><span class="line"></span><br><span class="line">libvirt auto generate xml /var/run/libvirt/qemu/$domain.xml</span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">maxMemory</span> <span class="attr">slots</span>=<span class="string">&#x27;4&#x27;</span> <span class="attr">unit</span>=<span class="string">&#x27;KiB&#x27;</span>&gt;</span>4194304<span class="tag">&lt;/<span class="name">maxMemory</span>&gt;</span>                         </span><br><span class="line">  <span class="tag">&lt;<span class="name">memory</span> <span class="attr">unit</span>=<span class="string">&#x27;KiB&#x27;</span>&gt;</span>1572864<span class="tag">&lt;/<span class="name">memory</span>&gt;</span>               ----&gt;memory include ram(numa)+dimm+nvdimm</span><br><span class="line">  <span class="tag">&lt;<span class="name">currentMemory</span> <span class="attr">unit</span>=<span class="string">&#x27;KiB&#x27;</span>&gt;</span>1310720<span class="tag">&lt;/<span class="name">currentMemory</span>&gt;</span> ----&gt;currentMemory not include nvdimm, but include dimm, this is the value you can see with `lsmem -ab`</span><br></pre></td></tr></table></figure>

<p><strong>check memory device</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># total memory info</span></span><br><span class="line">$ virsh qemu-monitor-command  vm100 --pretty <span class="string">&#x27;&#123; &quot;execute&quot;: &quot;query-memory-size-summary&quot;&#125;&#x27;</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;return&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;base-memory&quot;</span>: 1073741824,</span><br><span class="line">    <span class="string">&quot;plugged-memory&quot;</span>: 536870912 ----&gt;count both dimm and nvdimm</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;id&quot;</span>: <span class="string">&quot;libvirt-19&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># details about pluggable memory device(dimm and nvdim)</span></span><br><span class="line">$ virsh qemu-monitor-command  vm100 --pretty <span class="string">&#x27;&#123; &quot;execute&quot;: &quot;query-memory-devices&quot;&#125;&#x27;</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;return&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;type&quot;</span>: <span class="string">&quot;dimm&quot;</span>,</span><br><span class="line">      <span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;memdev&quot;</span>: <span class="string">&quot;/objects/memdimm0&quot;</span>,</span><br><span class="line">        <span class="string">&quot;hotplugged&quot;</span>: <span class="literal">false</span>, ----&gt;from <span class="built_in">command</span> line</span><br><span class="line">        <span class="string">&quot;addr&quot;</span>: 4294967296,</span><br><span class="line">        <span class="string">&quot;hotpluggable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">&quot;size&quot;</span>: 268435456,</span><br><span class="line">        <span class="string">&quot;slot&quot;</span>: 0,</span><br><span class="line">        <span class="string">&quot;node&quot;</span>: 0,</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: <span class="string">&quot;dimm0&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;type&quot;</span>: <span class="string">&quot;nvdimm&quot;</span>,</span><br><span class="line">      <span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;memdev&quot;</span>: <span class="string">&quot;/objects/memnvdimm1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;hotplugged&quot;</span>: <span class="literal">false</span>,----&gt;from <span class="built_in">command</span> line</span><br><span class="line">        <span class="string">&quot;addr&quot;</span>: 4563402752,</span><br><span class="line">        <span class="string">&quot;hotpluggable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">&quot;size&quot;</span>: 268435456,</span><br><span class="line">        <span class="string">&quot;slot&quot;</span>: 1,</span><br><span class="line">        <span class="string">&quot;node&quot;</span>: 0,</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: <span class="string">&quot;nvdimm1&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;id&quot;</span>: <span class="string">&quot;libvirt-20&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Inside guest check memory</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kernel code used is not counted here</span></span><br><span class="line">$ free</span><br><span class="line">              total        used        free      shared  buff/cache   available</span><br><span class="line">Mem:        1210676       82836     1042392       12432       85448     1092196</span><br><span class="line">Swap:             0           0           0</span><br><span class="line"><span class="comment"># total memory is 1.3G as well, nvdimm is not counted</span></span><br><span class="line">$ lsmem -a</span><br><span class="line">RANGE                                  SIZE  STATE REMOVABLE BLOCK</span><br><span class="line">0x0000000000000000-0x0000000007ffffff  128M online        no     0</span><br><span class="line">0x0000000008000000-0x000000000fffffff  128M online       <span class="built_in">yes</span>     1</span><br><span class="line">0x0000000010000000-0x0000000017ffffff  128M online       <span class="built_in">yes</span>     2</span><br><span class="line">0x0000000018000000-0x000000001fffffff  128M online       <span class="built_in">yes</span>     3</span><br><span class="line">0x0000000020000000-0x0000000027ffffff  128M online       <span class="built_in">yes</span>     4</span><br><span class="line">0x0000000028000000-0x000000002fffffff  128M online        no     5</span><br><span class="line">0x0000000030000000-0x0000000037ffffff  128M online        no     6</span><br><span class="line">0x0000000038000000-0x000000003fffffff  128M online        no     7</span><br><span class="line">0x0000000100000000-0x0000000107ffffff  128M online        no    32</span><br><span class="line">0x0000000108000000-0x000000010fffffff  128M online        no    33</span><br><span class="line"></span><br><span class="line">Memory block size:       128M</span><br><span class="line">Total online memory:     1.3G</span><br><span class="line">Total offline memory:      0B</span><br><span class="line"></span><br><span class="line"><span class="comment"># nvdimm is seen as block by guest /dev/pmem0!!!</span></span><br><span class="line"><span class="variable">$fdisk</span> -l</span><br><span class="line"></span><br><span class="line">Disk /dev/pmem0: 268 MB, 268435456 bytes, 524288 sectors</span><br><span class="line">Units = sectors of 1 * 512 = 512 bytes</span><br><span class="line">Sector size (logical/physical): 512 bytes / 4096 bytes</span><br><span class="line">I/O size (minimum/optimal): 4096 bytes / 4096 bytes</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="with-hotpluggable-memory-device-from-QMP"><a href="#with-hotpluggable-memory-device-from-QMP" class="headerlink" title="with hotpluggable memory device from QMP"></a>with hotpluggable memory device from QMP</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$virsh</span> qemu-monitor-command  vm100 --pretty <span class="string">&#x27;&#123; &quot;execute&quot;: &quot;object-add&quot;, &quot;arguments&quot;:&#123;&quot;qom-type&quot;:&quot;memory-backend-ram&quot;,&quot;id&quot;:&quot;mem-dimm2&quot;,&quot;props&quot;:&#123;&quot;size&quot;:268435456&#125;&#125;&#125;&#x27;</span></span><br><span class="line"><span class="variable">$virsh</span> qemu-monitor-command  vm100 --pretty <span class="string">&#x27;&#123; &quot;execute&quot;: &quot;device_add&quot;, &quot;arguments&quot;:&#123;&quot;driver&quot;:&quot;pc-dimm&quot;,&quot;id&quot;:&quot;dm2&quot;,&quot;memdev&quot;:&quot;mem-dimm2&quot;&#125;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$virsh</span> qemu-monitor-command  vm100 --pretty <span class="string">&#x27;&#123; &quot;execute&quot;: &quot;query-memory-devices&quot;&#125;&#x27;</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;return&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;type&quot;</span>: <span class="string">&quot;dimm&quot;</span>,</span><br><span class="line">      <span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;memdev&quot;</span>: <span class="string">&quot;/objects/memdimm0&quot;</span>,</span><br><span class="line">        <span class="string">&quot;hotplugged&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;addr&quot;</span>: 4294967296,</span><br><span class="line">        <span class="string">&quot;hotpluggable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">&quot;size&quot;</span>: 268435456,</span><br><span class="line">        <span class="string">&quot;slot&quot;</span>: 0,</span><br><span class="line">        <span class="string">&quot;node&quot;</span>: 0,</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: <span class="string">&quot;dimm0&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;type&quot;</span>: <span class="string">&quot;nvdimm&quot;</span>,</span><br><span class="line">      <span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;memdev&quot;</span>: <span class="string">&quot;/objects/memnvdimm1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;hotplugged&quot;</span>: <span class="literal">false</span>,--------&gt;can NOT be removed from QMP as it is added from <span class="built_in">command</span> line</span><br><span class="line">        <span class="string">&quot;addr&quot;</span>: 4563402752,</span><br><span class="line">        <span class="string">&quot;hotpluggable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">&quot;size&quot;</span>: 268435456,</span><br><span class="line">        <span class="string">&quot;slot&quot;</span>: 1,</span><br><span class="line">        <span class="string">&quot;node&quot;</span>: 0,</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: <span class="string">&quot;nvdimm1&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;type&quot;</span>: <span class="string">&quot;dimm&quot;</span>,</span><br><span class="line">      <span class="string">&quot;data&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;memdev&quot;</span>: <span class="string">&quot;/objects/mem-dimm2&quot;</span>,</span><br><span class="line">        <span class="string">&quot;hotplugged&quot;</span>: <span class="literal">true</span>, -----&gt;this can be removed from QMP <span class="built_in">command</span>!!!</span><br><span class="line">        <span class="string">&quot;addr&quot;</span>: 4831838208,</span><br><span class="line">        <span class="string">&quot;hotpluggable&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">&quot;size&quot;</span>: 268435456,</span><br><span class="line">        <span class="string">&quot;slot&quot;</span>: 2,</span><br><span class="line">        <span class="string">&quot;node&quot;</span>: 0,</span><br><span class="line">        <span class="string">&quot;id&quot;</span>: <span class="string">&quot;dm2&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;id&quot;</span>: <span class="string">&quot;libvirt-23&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># insde guest</span></span><br><span class="line">$ free</span><br><span class="line">              total        used        free      shared  buff/cache   available</span><br><span class="line">Mem:        1472816       94176     1292552       12440       86088     1339132</span><br><span class="line">Swap:             0           0           0</span><br><span class="line"></span><br><span class="line"><span class="comment"># total memory is increased after add a memory device</span></span><br><span class="line">$ lsmem -a</span><br><span class="line">RANGE                                  SIZE  STATE REMOVABLE BLOCK</span><br><span class="line">0x0000000000000000-0x0000000007ffffff  128M online        no     0</span><br><span class="line">0x0000000008000000-0x000000000fffffff  128M online       <span class="built_in">yes</span>     1</span><br><span class="line">0x0000000010000000-0x0000000017ffffff  128M online       <span class="built_in">yes</span>     2</span><br><span class="line">0x0000000018000000-0x000000001fffffff  128M online       <span class="built_in">yes</span>     3</span><br><span class="line">0x0000000020000000-0x0000000027ffffff  128M online       <span class="built_in">yes</span>     4</span><br><span class="line">0x0000000028000000-0x000000002fffffff  128M online        no     5</span><br><span class="line">0x0000000030000000-0x0000000037ffffff  128M online        no     6</span><br><span class="line">0x0000000038000000-0x000000003fffffff  128M online        no     7</span><br><span class="line">0x0000000100000000-0x0000000107ffffff  128M online        no    32</span><br><span class="line">0x0000000108000000-0x000000010fffffff  128M online        no    33</span><br><span class="line">0x0000000120000000-0x0000000127ffffff  128M online       <span class="built_in">yes</span>    36</span><br><span class="line">0x0000000128000000-0x000000012fffffff  128M online       <span class="built_in">yes</span>    37</span><br><span class="line"></span><br><span class="line">Memory block size:       128M</span><br><span class="line">Total online memory:     1.5G</span><br><span class="line">Total offline memory:      0B</span><br></pre></td></tr></table></figure>

<h2 id="move-qemu-process-launched-outside-to-libvirtd-control"><a href="#move-qemu-process-launched-outside-to-libvirtd-control" class="headerlink" title="move qemu-process launched outside to libvirtd control"></a>move qemu-process launched outside to libvirtd control</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Attach an externally launched QEMU process to the libvirt QEMU driver. </span></span><br><span class="line"><span class="comment"># The QEMU process must have been created with a monitor connection using the UNIX driver. </span></span><br><span class="line"><span class="comment"># Ideally the process will also have had the &#x27;-name&#x27; argument specified. </span></span><br><span class="line"></span><br><span class="line">$ qemu-kvm -cdrom ~/demo.iso \</span><br><span class="line">    -monitor unix:/tmp/demo,server,nowait \</span><br><span class="line">    -name foo \</span><br><span class="line">    -uuid cece4f9f-dff0-575d-0e8e-01fe380f12ea  &amp;</span><br><span class="line">$ QEMUPID=$!</span><br><span class="line">$ virsh qemu-attach <span class="variable">$QEMUPID</span></span><br></pre></td></tr></table></figure>
<h2 id="limit-IO"><a href="#limit-IO" class="headerlink" title="limit IO"></a>limit IO</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># blkdeviotune - Set or query a block device I/O tuning parameters</span></span><br><span class="line"><span class="comment">#  OPTIONS</span></span><br><span class="line"><span class="comment">#    [--domain] &lt;string&gt;  domain name, id or uuid</span></span><br><span class="line"><span class="comment">#    [--device] &lt;string&gt;  block device</span></span><br><span class="line"><span class="comment">#    --total-bytes-sec &lt;number&gt;  total throughput limit, as scaled integer (default bytes)</span></span><br><span class="line"><span class="comment">#    --read-bytes-sec &lt;number&gt;  read throughput limit, as scaled integer (default bytes)</span></span><br><span class="line"><span class="comment">#    --write-bytes-sec &lt;number&gt;  write throughput limit, as scaled integer (default bytes)</span></span><br><span class="line"><span class="comment">#    --total-iops-sec &lt;number&gt;  total I/O operations limit per second</span></span><br><span class="line"><span class="comment">#    --read-iops-sec &lt;number&gt;  read I/O operations limit per second</span></span><br><span class="line"><span class="comment">#    --write-iops-sec &lt;number&gt;  write I/O operations limit per second</span></span><br><span class="line"><span class="comment">#    --total-bytes-sec-max &lt;number&gt;  total max, as scaled integer (default bytes)</span></span><br><span class="line"><span class="comment">#    --read-bytes-sec-max &lt;number&gt;  read max, as scaled integer (default bytes)</span></span><br><span class="line"><span class="comment">#    --write-bytes-sec-max &lt;number&gt;  write max, as scaled integer (default bytes)</span></span><br><span class="line"><span class="comment">#    --total-iops-sec-max &lt;number&gt;  total I/O operations max</span></span><br><span class="line"><span class="comment">#    --read-iops-sec-max &lt;number&gt;  read I/O operations max</span></span><br><span class="line"><span class="comment">#    --write-iops-sec-max &lt;number&gt;  write I/O operations max</span></span><br><span class="line"><span class="comment">#    --size-iops-sec &lt;number&gt;  I/O size in bytes</span></span><br><span class="line"><span class="comment">#    --group-name &lt;string&gt;  group name to share I/O quota between multiple drives</span></span><br><span class="line"><span class="comment">#    --total-bytes-sec-max-length &lt;number&gt;  duration in seconds to allow total max bytes</span></span><br><span class="line"><span class="comment">#    --read-bytes-sec-max-length &lt;number&gt;  duration in seconds to allow read max bytes</span></span><br><span class="line"><span class="comment">#    --write-bytes-sec-max-length &lt;number&gt;  duration in seconds to allow write max bytes</span></span><br><span class="line"><span class="comment">#    --total-iops-sec-max-length &lt;number&gt;  duration in seconds to allow total I/O operations max</span></span><br><span class="line"><span class="comment">#    --read-iops-sec-max-length &lt;number&gt;  duration in seconds to allow read I/O operations max</span></span><br><span class="line"><span class="comment">#    --write-iops-sec-max-length &lt;number&gt;  duration in seconds to allow write I/O operations max</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#    --config         affect next boot</span></span><br><span class="line"><span class="comment">#    --live           affect running domain</span></span><br><span class="line"><span class="comment">#    --current        affect current domain</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># get io parameters of given disk</span></span><br><span class="line"><span class="variable">$virsh</span> blkdeviotune vm100 vda</span><br><span class="line">total_bytes_sec: 0</span><br><span class="line">read_bytes_sec : 83886080</span><br><span class="line">write_bytes_sec: 83886080</span><br><span class="line">total_iops_sec : 0</span><br><span class="line">read_iops_sec  : 2000</span><br><span class="line">write_iops_sec : 2000</span><br><span class="line">total_bytes_sec_max: 0</span><br><span class="line">read_bytes_sec_max: 0</span><br><span class="line">write_bytes_sec_max: 0</span><br><span class="line">total_iops_sec_max: 0</span><br><span class="line">read_iops_sec_max: 0</span><br><span class="line">write_iops_sec_max: 0</span><br><span class="line">size_iops_sec  : 0</span><br><span class="line">group_name     : drive-virtio-disk0</span><br><span class="line">total_bytes_sec_max_length: 0</span><br><span class="line">read_bytes_sec_max_length: 0</span><br><span class="line">write_bytes_sec_max_length: 0</span><br><span class="line">total_iops_sec_max_length: 0</span><br><span class="line">read_iops_sec_max_length: 0</span><br><span class="line">write_iops_sec_max_length: 0</span><br><span class="line"></span><br><span class="line"><span class="variable">$virsh</span> blkdeviotune vm100 vda --total-iops-sec 5000</span><br><span class="line"></span><br><span class="line"><span class="comment"># check result</span></span><br><span class="line"><span class="variable">$virsh</span> blkdeviotune vm100 vda</span><br><span class="line">total_bytes_sec: 0</span><br><span class="line">read_bytes_sec : 83886080</span><br><span class="line">write_bytes_sec: 83886080</span><br><span class="line">total_iops_sec : 5000----&gt;changed</span><br><span class="line">read_iops_sec  : 0</span><br><span class="line">write_iops_sec : 0</span><br><span class="line">total_bytes_sec_max: 0</span><br><span class="line">read_bytes_sec_max: 0</span><br><span class="line">write_bytes_sec_max: 0</span><br><span class="line">total_iops_sec_max: 0</span><br><span class="line">read_iops_sec_max: 0</span><br><span class="line">write_iops_sec_max: 0</span><br><span class="line">size_iops_sec  : 0</span><br><span class="line">group_name     : drive-virtio-disk0</span><br><span class="line">total_bytes_sec_max_length: 0</span><br><span class="line">read_bytes_sec_max_length: 0</span><br><span class="line">write_bytes_sec_max_length: 0</span><br><span class="line">total_iops_sec_max_length: 0</span><br><span class="line">read_iops_sec_max_length: 0</span><br><span class="line">write_iops_sec_max_length: 0</span><br></pre></td></tr></table></figure>
<h2 id="get-device-property-value"><a href="#get-device-property-value" class="headerlink" title="get device property value"></a>get device property value</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># get property of given device</span></span><br><span class="line"><span class="variable">$virsh</span> qemu-monitor-command --hmp  vm100 info qom-tree</span><br><span class="line"><span class="variable">$virsh</span> qemu-monitor-command vm100 --pretty <span class="string">&#x27;&#123;&quot;execute&quot;: &quot;qom-get&quot;, &quot;arguments&quot;: &#123;&quot;path&quot;: &quot;/machine/peripheral/net1&quot;, &quot;property&quot;: &quot;mq&quot;&#125;&#125;&#x27;</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;return&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">&quot;id&quot;</span>: <span class="string">&quot;libvirt-39&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="how-to-login-vm-by-serial-console-for"><a href="#how-to-login-vm-by-serial-console-for" class="headerlink" title="how to login vm by serial console for"></a>how to login vm by serial console for</h2><p>To make <code>virsh console vm100</code> work, you have to do these steps by order</p>
<ul>
<li><p>enable console from boot parameter inside vm <code>vm#grubby --update-kernel=ALL --args=&quot;console=ttyS0&quot; vm#reboot</code></p>
<ul>
<li><strong>NOTE: without this you can still use console but lost early boot message</strong></li>
</ul>
</li>
<li><p>enable getty on ttyS0 inside vm</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># touch /etc/systemd/system/serial-getty@ttyS0.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Serial Getty on %I</span><br><span class="line">Documentation=man:agetty(8) man:systemd-getty-generator(8)</span><br><span class="line">Documentation=http://0pointer.de/blog/projects/serial-console.html</span><br><span class="line">BindsTo=dev-%i.device</span><br><span class="line">After=dev-%i.device systemd-user-sessions.service plymouth-quit-wait.service</span><br><span class="line">After=rc-local.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># If additional gettys are spawned during boot then we should make</span></span><br><span class="line"><span class="comment"># sure that this is synchronized before getty.target, even though</span></span><br><span class="line"><span class="comment"># getty.target didn&#x27;t actually pull it in.</span></span><br><span class="line">Before=getty.target</span><br><span class="line">IgnoreOnIsolate=<span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=-/sbin/agetty --keep-baud 115200,38400,9600 %I <span class="variable">$TERM</span></span><br><span class="line">Type=idle</span><br><span class="line">Restart=always</span><br><span class="line">UtmpIdentifier=%I</span><br><span class="line">TTYPath=/dev/%I</span><br><span class="line">TTYReset=<span class="built_in">yes</span></span><br><span class="line">TTYVHangup=<span class="built_in">yes</span></span><br><span class="line">KillMode=process</span><br><span class="line">IgnoreSIGPIPE=no</span><br><span class="line">SendSIGHUP=<span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=getty.target</span><br><span class="line"></span><br><span class="line"><span class="comment"># ln -s /etc/systemd/system/serial-getty@ttyS0.service /etc/systemd/system/getty.target.wants/</span></span><br><span class="line"><span class="comment"># systemctl daemon-reload</span></span><br><span class="line"><span class="comment"># systemctl start serial-getty@ttyS0.service</span></span><br><span class="line"><span class="comment"># systemctl enable serial-getty@ttyS0.service</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong>NOTE: without this you can still use console, but no login promt</strong></li>
</ul>
</li>
<li><p>virsh stop vm100</p>
</li>
<li><p>edit <code>/etc/libvirt/qemu/vm100.xml</code> to add console(serial type) device</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">console</span> <span class="attr">type</span>=<span class="string">&#x27;pty&#x27;</span>&gt;</span> <span class="comment">&lt;!--on host auto select one--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">target</span> <span class="attr">type</span>=<span class="string">&#x27;serial&#x27;</span> <span class="attr">port</span>=<span class="string">&#x27;0&#x27;</span>/&gt;</span> <span class="comment">&lt;!--insde vm /dev/ttyS0--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">&#x27;console0&#x27;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">console</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>service libvirtd restart</p>
</li>
<li><p>virsh start vm100</p>
<ul>
<li>inside vm <code>$ echo hello &gt;/dev/ttyS0</code></li>
</ul>
</li>
<li><p>virsh console vm100</p>
<ul>
<li>without kernel parameter, you can NOT seeing <code>Starting ...when boots</code></li>
<li>without getty, you can NOT seeing login promt <code>centos76 login: </code></li>
<li>got <code>hello</code> here</li>
</ul>
</li>
</ul>
<h2 id="how-to-access-console-x2F-serial-without-virsh-command"><a href="#how-to-access-console-x2F-serial-without-virsh-command" class="headerlink" title="how to access console&#x2F;serial without virsh command"></a>how to access console&#x2F;serial without virsh command</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ grep redirect  /var/log/libvirt/qemu/vm100.<span class="built_in">log</span></span><br><span class="line">115:2023-03-24T06:28:28.402166Z qemu-kvm: -chardev pty,<span class="built_in">id</span>=charconsole1: char device redirected to /dev/pts/5 (label charconsole1)</span><br><span class="line"></span><br><span class="line">$ screen /dev/pts/5</span><br><span class="line"></span><br><span class="line"><span class="comment"># quit from console(terminate screen session)</span></span><br><span class="line">ctrl + a, <span class="keyword">then</span> press \</span><br></pre></td></tr></table></figure>
<h2 id="use-specific-qemu-for-a-vm"><a href="#use-specific-qemu-for-a-vm" class="headerlink" title="use specific qemu for a vm"></a>use specific qemu for a vm</h2><p>Use <code>emulator</code> in xml to do this like below.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">devices</span>&gt;</span>                                                                     </span><br><span class="line">  <span class="tag">&lt;<span class="name">emulator</span>&gt;</span>/src/qemu/build/x86_64-softmmu/qemu-system-x86_64<span class="tag">&lt;/<span class="name">emulator</span>&gt;</span></span><br><span class="line">  ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">devices</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="node-device-info"><a href="#node-device-info" class="headerlink" title="node device info"></a>node device info</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># list all pci devices of host(we can passthrough these devices if iommus is enabled on host)</span></span><br><span class="line">$ virsh nodedev-list --<span class="built_in">cap</span> pci</span><br><span class="line">pci_0000_00_00_0</span><br><span class="line">pci_0000_00_01_0</span><br><span class="line">pci_0000_00_02_0</span><br><span class="line">pci_0000_00_03_0</span><br><span class="line">pci_0000_00_04_0</span><br><span class="line">pci_0000_00_1f_0</span><br><span class="line">pci_0000_00_1f_2</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment"># get device infomration</span></span><br><span class="line">$ virsh nodedev-dumpxml pci_0000_00_00_0</span><br><span class="line">&lt;device&gt;</span><br><span class="line">  &lt;name&gt;pci_0000_00_00_0&lt;/name&gt;</span><br><span class="line">  &lt;path&gt;/sys/devices/pci0000:00/0000:00:00.0&lt;/path&gt;</span><br><span class="line">  &lt;parent&gt;computer&lt;/parent&gt;</span><br><span class="line">  &lt;capability <span class="built_in">type</span>=<span class="string">&#x27;pci&#x27;</span>&gt;</span><br><span class="line">    &lt;domain&gt;0&lt;/domain&gt;</span><br><span class="line">    &lt;bus&gt;0&lt;/bus&gt;</span><br><span class="line">    &lt;slot&gt;0&lt;/slot&gt;</span><br><span class="line">    &lt;<span class="keyword">function</span>&gt;0&lt;/function&gt;</span><br><span class="line">    &lt;product <span class="built_in">id</span>=<span class="string">&#x27;0x29c0&#x27;</span>&gt;82G33/G31/P35/P31 Express DRAM Controller&lt;/product&gt;</span><br><span class="line">    &lt;vendor <span class="built_in">id</span>=<span class="string">&#x27;0x8086&#x27;</span>&gt;Intel Corporation&lt;/vendor&gt;</span><br><span class="line">    &lt;iommuGroup number=<span class="string">&#x27;0&#x27;</span>&gt;</span><br><span class="line">      &lt;address domain=<span class="string">&#x27;0x0000&#x27;</span> bus=<span class="string">&#x27;0x00&#x27;</span> slot=<span class="string">&#x27;0x00&#x27;</span> <span class="keyword">function</span>=<span class="string">&#x27;0x0&#x27;</span>/&gt;</span><br><span class="line">    &lt;/iommuGroup&gt;</span><br><span class="line">  &lt;/capability&gt;</span><br><span class="line">&lt;/device&gt;</span><br></pre></td></tr></table></figure>

<h1 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h1><ul>
<li><a target="_blank" rel="noopener" href="https://libvirt.org/format.html">VM XML format</a></li>
<li><a target="_blank" rel="noopener" href="https://libvirt.org/sources/virshcmdref/html-single/">virsh reference</a></li>
<li><a target="_blank" rel="noopener" href="https://wiki.libvirt.org/page/Main_Page">libvirt Wiki</a></li>
<li><a target="_blank" rel="noopener" href="https://wiki.libvirt.org/page/FAQ">libvirt FAQ</a></li>
<li><a target="_blank" rel="noopener" href="https://libvirt.org/api.html">libvirt API concepts</a></li>
<li><a target="_blank" rel="noopener" href="https://libvirt.org/html/">libvirt API in C</a></li>
<li><a target="_blank" rel="noopener" href="https://libvirt.org/kbase/debuglogs.html">libvirt debug logs</a></li>
<li><a target="_blank" rel="noopener" href="https://kashyapc.fedorapeople.org/virt/lc-2012/snapshots-handout.html">libvirt snapshot</a></li>
<li><a target="_blank" rel="noopener" href="https://fedoraproject.org/wiki/How_to_debug_Virtualization_problems">virtulization troubleshooting</a></li>
</ul>

    </div>

    
    
    
      


    <footer class="post-footer">
          <div class="reward-container">
  <div></div>
  <button>
    Donate
  </button>
  <div class="post-reward">
      <div>
        <img src="/images/wechatpay.jpeg" alt="Jason WeChat Pay">
        <span>WeChat Pay</span>
      </div>

  </div>
</div>

          <div class="post-tags">
              <a href="/tags/libvirt/" rel="tag"># libvirt</a>
              <a href="/tags/cloud/" rel="tag"># cloud</a>
              <a href="/tags/vm/" rel="tag"># vm</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/07/06/storage-nbd/" rel="prev" title="storage_nbd">
                  <i class="fa fa-chevron-left"></i> storage_nbd
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2021/07/14/yum-rpm-pkg/" rel="next" title="yum-rpm-pkg">
                  yum-rpm-pkg <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments utterances-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2018 – 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Cyun All rights reserved</span>
</div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.0/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>



  <script src="/js/third-party/fancybox.js"></script>

  <script src="/js/third-party/pace.js"></script>

  




<script class="next-config" data-name="utterances" type="application/json">{"enable":true,"repo":"jason-bj/blog","issue_term":"pathname","theme":"github-light"}</script>
<script src="/js/third-party/comments/utterances.js"></script>

</body>
</html>
