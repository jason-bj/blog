<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon/favicon-16x16.png">
  <meta name="google-site-verification" content="xitt2fbphh1nTeWLiTWc0lCggHuxJ5heMcAzkHW2vno">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Microsoft+YaHei+UI:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"cyun.tech","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.11.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"utterances","storage":true,"lazyload":false,"nav":null,"activeClass":"utterances"},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":10,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="ServiceA Kubernetes Service is a resource you create to make a single, constant point of entry to a group of pods(selected by label selector) providing the same service.  service has an IP address and">
<meta property="og:type" content="article">
<meta property="og:title" content="k8s_service_deep">
<meta property="og:url" content="http://cyun.tech/2021/06/08/k8s-service-deep/index.html">
<meta property="og:site_name" content="CYun">
<meta property="og:description" content="ServiceA Kubernetes Service is a resource you create to make a single, constant point of entry to a group of pods(selected by label selector) providing the same service.  service has an IP address and">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://d33wubrfki0l68.cloudfront.net/27b2978647a8d7bdc2a96b213f0c0d3242ef9ce0/e8c9b/images/docs/services-iptables-overview.svg">
<meta property="og:image" content="https://d33wubrfki0l68.cloudfront.net/2d3d2b521cf7f9ff83238218dac1c019c270b1ed/9ac5c/images/docs/services-ipvs-overview.svg">
<meta property="article:published_time" content="2021-06-07T23:49:33.000Z">
<meta property="article:modified_time" content="2023-08-16T15:02:01.156Z">
<meta property="article:author" content="Jason">
<meta property="article:tag" content="k8s">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://d33wubrfki0l68.cloudfront.net/27b2978647a8d7bdc2a96b213f0c0d3242ef9ce0/e8c9b/images/docs/services-iptables-overview.svg">


<link rel="canonical" href="http://cyun.tech/2021/06/08/k8s-service-deep/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://cyun.tech/2021/06/08/k8s-service-deep/","path":"2021/06/08/k8s-service-deep/","title":"k8s_service_deep"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>k8s_service_deep | CYun</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-148730544-1"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"UA-148730544-1","only_pageview":false}</script>
  <script src="/js/third-party/analytics/google-analytics.js"></script>

  <script src="/js/third-party/analytics/baidu-analytics.js"></script>
  <script async src="https://hm.baidu.com/hm.js?a510d1f580c8231f8f867d14f42bb8ea"></script>




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">CYun</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Service"><span class="nav-number">1.</span> <span class="nav-text">Service</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#kube-proxy"><span class="nav-number">1.1.</span> <span class="nav-text">kube-proxy</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Iptables"><span class="nav-number">1.1.1.</span> <span class="nav-text">Iptables</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Ipvs"><span class="nav-number">1.1.2.</span> <span class="nav-text">Ipvs</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#config"><span class="nav-number">1.1.3.</span> <span class="nav-text">config</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#enable-iptables-mode"><span class="nav-number">1.1.3.1.</span> <span class="nav-text">enable iptables mode</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Ipvs-1"><span class="nav-number">1.1.4.</span> <span class="nav-text">Ipvs</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#enable-IPVS-mode"><span class="nav-number">1.1.4.1.</span> <span class="nav-text">enable IPVS mode</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#debug-kube-proxy"><span class="nav-number">1.1.5.</span> <span class="nav-text">debug kube-proxy</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#coredns"><span class="nav-number">1.2.</span> <span class="nav-text">coredns</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Ref"><span class="nav-number">2.</span> <span class="nav-text">Ref</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Jason"
      src="/uploads/avatar.gif">
  <p class="site-author-name" itemprop="name">Jason</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">149</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">141</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">148</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/jason-cyun" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;jason-cyun" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:jason_lkm@163.com" title="E-Mail → mailto:jason_lkm@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://cyun.tech/2021/06/08/k8s-service-deep/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.gif">
      <meta itemprop="name" content="Jason">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CYun">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="k8s_service_deep | CYun">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          k8s_service_deep
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-06-08 07:49:33" itemprop="dateCreated datePublished" datetime="2021-06-08T07:49:33+08:00">2021-06-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-08-16 23:02:01" itemprop="dateModified" datetime="2023-08-16T23:02:01+08:00">2023-08-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/k8s/service/" itemprop="url" rel="index"><span itemprop="name">service</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h1><p>A Kubernetes Service is a resource you create to <strong>make a single, constant point of entry to a group of pods(selected by label selector) providing the same service</strong>.  service has an IP address and port that <strong>never change while the service exists</strong>, but Pod address could change during upgrade, or pod is removed or deleted during scale, hence we SHOULD NOT access pod address directly for a service, we need a dedicated ip for the cased mentioned, that’s why service comes in.</p>
<p>More details about service, refer to <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/services-networking/_print/">k8s service</a></p>
<p><strong>enable source ip persistence for a service</strong><br>If you want to make sure that connections from a particular client are passed to the same Pod each time, you can select the session affinity based on the client’s IP addresses by setting <code>service.spec.sessionAffinity to &quot;ClientIP&quot; (the default is &quot;None&quot;)</code>. You can also set the maximum session sticky time by setting <code>service.spec.sessionAffinityConfig.clientIP.timeoutSeconds</code> appropriately. (the default value is 10800, which works out to be 3 hours).</p>
<span id="more"></span>
<h2 id="kube-proxy"><a href="#kube-proxy" class="headerlink" title="kube-proxy"></a>kube-proxy</h2><p>kube-proxy is a key component of any Kubernetes deployment.  Its role is to <code>load-balance traffic that is destined for services (via cluster IPs and node ports) to the correct backend pods</code>.  Kube-proxy can run in one of three modes, each implemented with different data plane technologies: userspace, iptables, or IPVS.  </p>
<p>The userspace mode is very old, slow, and definitely not recommended!  we DO NOT discuss it here.</p>
<p><strong>iptables vs IPVS</strong></p>
<ul>
<li>IPVS has better performance with larger service and pods</li>
<li>IPVS has more algorithms then iptables</li>
<li>IPVS supports server health checking and connection retries, etc.</li>
</ul>
<p><strong>Note</strong>  </p>
<ul>
<li>cluser ip of service, pod ip and endpoint are assigned by controller manager</li>
<li>kube-proxy watches apiserver for service and endpoint object, then update iptables or IPVS rules.</li>
<li>kube-proxy runs in each node(kube-system namespace)</li>
</ul>
<p>Why not use round-robin DNS to replace kube-proxy?<br>A question that pops up every now and then is why Kubernetes relies on proxying to forward inbound traffic to backends. What about other approaches? For example, would it be possible to configure DNS records that have multiple A values (or AAAA for IPv6), and rely on round-robin name resolution?</p>
<p>There are a few reasons for using proxying for Services:</p>
<ul>
<li>There is a long history of DNS implementations not respecting record TTLs, and <code>caching the results of name lookups after they should have expired.</code></li>
<li>Some apps do DNS lookups only once and <code>cache the results indefinitely.</code></li>
<li>Even if apps and libraries did proper re-resolution, the low or zero TTLs on the DNS records could impose a high load on DNS that then becomes difficult to manage</li>
</ul>
<h3 id="Iptables"><a href="#Iptables" class="headerlink" title="Iptables"></a>Iptables</h3><p>In this mode, kube-proxy watches the Kubernetes control plane for the addition and removal of Service and Endpoint objects. For each Service, it installs iptables rules, which capture traffic to the Service’s clusterIP and port, and redirect that traffic to one of the Service’s backend sets. For each Endpoint object, it installs iptables rules which select a backend Pod.</p>
<p><img src="https://d33wubrfki0l68.cloudfront.net/27b2978647a8d7bdc2a96b213f0c0d3242ef9ce0/e8c9b/images/docs/services-iptables-overview.svg" alt="iptables mode"></p>
<p>By default, kube-proxy in iptables mode chooses a backend at random.<br>If kube-proxy is running in iptables mode and the first Pod that’s selected does not respond, the connection fails, there is no try next pod!!!</p>
<p>When access service by cluster ip(inside cluster), OUTPUT chain is checked., while when access service by NodePort address, PREROUTING chain is checked, but both will jump to KUBE-SERVICE chain created by kube-proxy, more detail see section below enable iptables for kube-proxy.</p>
<h3 id="Ipvs"><a href="#Ipvs" class="headerlink" title="Ipvs"></a>Ipvs</h3><p>n IPVS mode, kube-proxy watches Kubernetes Services and Endpoints, <strong>calls netlink interface to create IPVS rules accordingly and synchronizes IPVS rules with Kubernetes Services and Endpoints periodically</strong>. This control loop ensures that IPVS status matches the desired state. When accessing a Service, IPVS directs traffic to one of the backend Pods.</p>
<p>The IPVS proxy mode is based on netfilter hook function that is similar to iptables mode, but uses a hash table as the underlying data structure and works in the kernel space. That means kube-proxy in IPVS mode redirects traffic with lower latency than kube-proxy in iptables mode, with much better performance when synchronising proxy rules. Compared to the other proxy modes, IPVS mode also supports a higher throughput of network traffic.</p>
<p>IPVS provides more options for balancing traffic to backend Pods; these are:</p>
<ul>
<li>rr: round-robin</li>
<li>lc: least connection (smallest number of open connections)</li>
<li>dh: destination hashing</li>
<li>sh: source hashing</li>
<li>sed: shortest expected delay</li>
<li>nq: never queue</li>
</ul>
<p><img src="https://d33wubrfki0l68.cloudfront.net/2d3d2b521cf7f9ff83238218dac1c019c270b1ed/9ac5c/images/docs/services-ipvs-overview.svg" alt="IPVS mode"></p>
<p>When creating a ClusterIP type Service, IPVS proxier will do the following three things:</p>
<ul>
<li>Make sure a dummy interface exists in the node, defaults to kube-IPVS0</li>
<li>Bind Service IP addresses to the dummy interface</li>
<li>Create IPVS virtual servers for each Service IP address respectively</li>
</ul>
<h3 id="config"><a href="#config" class="headerlink" title="config"></a>config</h3><h4 id="enable-iptables-mode"><a href="#enable-iptables-mode" class="headerlink" title="enable iptables mode"></a>enable iptables mode</h4><p>When access service by cluster ip(inside cluster), OUTPUT chain is checked., while when access service by NodePort address, PREROUTING chain is checked, but both will jump to KUBE-SERVICE chain created by kube-proxy.</p>
<h3 id="Ipvs-1"><a href="#Ipvs-1" class="headerlink" title="Ipvs"></a>Ipvs</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># set from beginning when create cluster Cluster Created by Kubeadm</span></span><br><span class="line"><span class="comment"># conf file for kubeadm init</span></span><br><span class="line">...</span><br><span class="line">kubeProxy:</span><br><span class="line">  config:</span><br><span class="line">    mode: <span class="string">&quot;&quot;</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># change after kube-proxy runs</span></span><br><span class="line">$ kubectl edit configmaps kube-proxy -n kube-system</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ kubectl get  svc</span><br><span class="line">NAME               TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">nginx-1623168286   NodePort    10.1.172.5   &lt;none&gt;        80:31067/TCP   9m11s</span><br><span class="line"><span class="comment"># service cluster ip(10.1.172.5:80) and  (nodeaddress:31067) for the service</span></span><br><span class="line"></span><br><span class="line">$ kubectl get ep</span><br><span class="line">NAME               ENDPOINTS            AGE</span><br><span class="line">nginx-1623168286   10.2.2.18:8080       9m2s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># check KUBE-SERVICE chain</span></span><br><span class="line">$ iptables -nv -L PREROUTING -t nat</span><br><span class="line">Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </span><br><span class="line">25960 2231K KUBE-SERVICES  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* kubernetes service portals */</span><br><span class="line"></span><br><span class="line">$ iptables -nv -L OUTPUT  -t nat</span><br><span class="line">Chain OUTPUT (policy ACCEPT 39 packets, 2451 bytes)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </span><br><span class="line"> 986K   60M KUBE-SERVICES  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* kubernetes service portals */</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="comment"># nat table of kube-service chain, rule for cluster-ip named with KUBE-SVC-XXX and nodePort(stay at last rule)</span></span><br><span class="line"> $ iptables -nv -L KUBE-SERVICES -t nat</span><br><span class="line">Chain KUBE-SERVICES (2 references)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </span><br><span class="line">    0     0 KUBE-SVC-YTBFCGJW6SOUTSSA  tcp  --  *      *       0.0.0.0/0            10.1.172.5           /* default/nginx-1623168286:http cluster IP */ tcp dpt:80</span><br><span class="line">  303 18611 KUBE-NODEPORTS  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* kubernetes service nodeports; NOTE: this must be the last rule <span class="keyword">in</span> this chain */ ADDRTYPE match dst-type LOCAL</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ iptables -nv -L KUBE-NODEPORTS  -t nat</span><br><span class="line"></span><br><span class="line">Chain KUBE-NODEPORTS (1 references)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </span><br><span class="line">    0     0 KUBE-SVC-YTBFCGJW6SOUTSSA  tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/nginx-1623168286:http */ tcp dpt:31067</span><br><span class="line"></span><br><span class="line"><span class="comment"># SVC backend rule named with KUBE-SEP-XXX</span></span><br><span class="line">$ iptables -nv -L KUBE-SVC-YTBFCGJW6SOUTSSA -t nat</span><br><span class="line">Chain KUBE-SVC-YTBFCGJW6SOUTSSA (2 references)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </span><br><span class="line">    0     0 KUBE-SEP-NUA5P77FXIMWW66U  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/nginx-1623168286:http */</span><br><span class="line"></span><br><span class="line">$ iptables -nv -L KUBE-SEP-NUA5P77FXIMWW66U  -t nat</span><br><span class="line">Chain KUBE-SEP-NUA5P77FXIMWW66U (1 references)</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination         </span><br><span class="line">    0     0 DNAT       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            /* default/nginx-1623168286:http */ tcp to:10.2.2.20:8080</span><br><span class="line"><span class="comment"># real backend</span></span><br></pre></td></tr></table></figure>

<h4 id="enable-IPVS-mode"><a href="#enable-IPVS-mode" class="headerlink" title="enable IPVS mode"></a>enable IPVS mode</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># load module &lt;module_name&gt;</span></span><br><span class="line">$ modprobe -- ip_vs</span><br><span class="line">$ modprobe -- ip_vs_rr</span><br><span class="line">$ modprobe -- ip_vs_wrr</span><br><span class="line">$ modprobe -- ip_vs_sh</span><br><span class="line"></span><br><span class="line">$ modprobe -- nf_conntrack_ipv4</span><br><span class="line"><span class="comment"># OR (use nf_conntrack instead of nf_conntrack_ipv4 for Linux kernel 4.19 and later)</span></span><br><span class="line">$ modprobe -- nf_conntrack </span><br><span class="line"></span><br><span class="line">$ lsmod | grep -e ip_vs -e nf_conntrack_ipv4</span><br><span class="line"></span><br><span class="line"><span class="comment">#---------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># set from beginning when create cluster Cluster Created by Kubeadm</span></span><br><span class="line"><span class="comment"># conf file for kubeadm init</span></span><br><span class="line">...</span><br><span class="line">kubeProxy:</span><br><span class="line">  config:</span><br><span class="line">    mode: ipvs</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment"># change after kube-proxy runs</span></span><br><span class="line">$ kubectl edit configmaps kube-proxy -n kube-system</span><br><span class="line"></span><br><span class="line"><span class="comment"># install ipvs tool to check ipvs rule</span></span><br><span class="line"><span class="comment"># Ubuntu18</span></span><br><span class="line">$ apt-get install ipvsadm</span><br><span class="line"><span class="comment"># Centos7</span></span><br><span class="line">$ yum install -y ipvsadm</span><br><span class="line"></span><br><span class="line"><span class="comment"># after create a service check ipvs rule</span></span><br><span class="line">$ ipvsadm -<span class="built_in">ln</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ kubectl get  svc</span><br><span class="line">NAME               TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">nginx-1623168286   NodePort    10.1.172.5   &lt;none&gt;        80:31067/TCP   9m11s</span><br><span class="line"><span class="comment"># service cluster ip(10.1.172.5:80) and  (nodeaddress:31067) for the service</span></span><br><span class="line"></span><br><span class="line">$ kubectl get ep</span><br><span class="line">NAME               ENDPOINTS            AGE</span><br><span class="line">nginx-1623168286   10.2.2.18:8080       9m2s</span><br><span class="line"><span class="comment"># pods that provides nginx service</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># For cluster-IP, kube-proxy configure it at virtual device: kube-ipvs0 </span></span><br><span class="line"><span class="comment"># and create one rule for cluster-ip</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># for nodePort 31067, kube-proxy create several rules, each for one address of interfaces on the node</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">$ ip addr</span><br><span class="line">8: kube-ipvs0: &lt;BROADCAST,NOARP&gt; mtu 1500 qdisc noop state DOWN group default </span><br><span class="line">    <span class="built_in">link</span>/ether 9a:f2:1d:c0:84:ec brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.1.172.5/32 scope global kube-ipvs0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line">$ ipvsadm -<span class="built_in">ln</span></span><br><span class="line">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class="line">Prot LocalAddress:Port Scheduler Flags</span><br><span class="line">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class="line"></span><br><span class="line"><span class="comment"># each address of all device on that node</span></span><br><span class="line">TCP  192.168.56.11:31067 rr</span><br><span class="line">  -&gt; 10.2.2.18:8080               Masq    1      0          0              </span><br><span class="line"></span><br><span class="line"><span class="comment"># cluster ip     </span></span><br><span class="line">TCP  10.1.172.5:80 rr</span><br><span class="line">  -&gt; 10.2.2.18:8080               Masq    1      0          0       </span><br><span class="line"></span><br><span class="line"><span class="comment"># each address of all device on that node</span></span><br><span class="line">TCP  10.2.0.0:31067 rr</span><br><span class="line">  -&gt; 10.2.2.18:8080               Masq    1      0          0         </span><br><span class="line">TCP  10.2.0.1:31067 rr</span><br><span class="line">  -&gt; 10.2.2.18:8080               Masq    1      0          0         </span><br><span class="line">TCP  127.0.0.1:31067 rr</span><br><span class="line">  -&gt; 10.2.2.18:8080               Masq    1      0          0         </span><br><span class="line">TCP  172.17.0.1:31067 rr</span><br><span class="line">  -&gt; 10.2.2.18:8080               Masq    1      0          0         </span><br></pre></td></tr></table></figure>

<p><strong>NOTE</strong><br>When kube-proxy starts in IPVS proxy mode, it verifies whether IPVS kernel modules are available. <code>If the IPVS kernel modules are not detected, then kube-proxy falls back to running in iptables proxy mode</code>.</p>
<h3 id="debug-kube-proxy"><a href="#debug-kube-proxy" class="headerlink" title="debug kube-proxy"></a>debug kube-proxy</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># check process running</span></span><br><span class="line">$ ps -ef | grep kube-proxy</span><br><span class="line">$ kubectl get pod -n kube-system | grep kube-proxy</span><br><span class="line"></span><br><span class="line">$ kubectl get configmaps -n kube-system</span><br><span class="line"><span class="comment"># check conf for kube-proxy, mode used and parameter for each mode</span></span><br><span class="line">$ kubectl describe configmaps kube-proxy -n kube-system</span><br></pre></td></tr></table></figure>

<h2 id="coredns"><a href="#coredns" class="headerlink" title="coredns"></a>coredns</h2><p>Kubernetes DNS schedules a DNS Pod and Service on the cluster, and configures the kubelets to tell individual containers to use the DNS Service’s IP to resolve DNS names.</p>
<p><code>Every Service defined in the cluster (including the DNS server itself) is assigned a DNS name. By default, a client Pod&#39;s DNS search list includes the Pod&#39;s own namespace and the cluster&#39;s default domain</code>.</p>
<p>You can (and almost always should) set up a DNS service for your Kubernetes cluster using an add-on.</p>
<p>A cluster-aware DNS server, such as CoreDNS, watches the Kubernetes API for new Services and creates a set of DNS records for each one. If DNS has been enabled throughout your cluster then all Pods should automatically be able to resolve Services by their DNS name.</p>
<p>For example, if you have a Service called my-service in a Kubernetes namespace my-ns, the control plane and the DNS Service acting together create a DNS record for my-service.my-ns. Pods in the my-ns namespace should be able to find the service by doing a name lookup for my-service (my-service.my-ns would also work).</p>
<p>Pods in other namespaces must qualify the name as my-service.my-ns. These names will resolve to the cluster IP assigned for the Service.</p>
<p>Kubernetes also supports DNS SRV (Service) records for named ports. If the my-service.my-ns Service has a port named http with the protocol set to TCP, you can do a DNS SRV query for _http._tcp.my-service.my-ns to discover the port number for http, as well as the IP address.</p>
<h1 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h1><ul>
<li><p><a target="_blank" rel="noopener" href="https://xigang.github.io/2019/07/21/kubernetes-service/">service example</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.tigera.io/blog/comparing-kube-proxy-modes-iptables-or-IPVS/">IPVS VS iptables</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://kubernetes.io/blog/2018/07/09/IPVS-based-in-cluster-load-balancing-deep-dive/">IPVS in k8s</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://coredns.io/">coredns</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/command-line-tools-reference/kube-proxy/">kube-proxy</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/services-networking/_print/">service inside</a></p>
</li>
</ul>

    </div>

    
    
    
      


    <footer class="post-footer">
          <div class="reward-container">
  <div></div>
  <button>
    Donate
  </button>
  <div class="post-reward">
      <div>
        <img src="/images/wechatpay.jpeg" alt="Jason WeChat Pay">
        <span>WeChat Pay</span>
      </div>

  </div>
</div>

          <div class="post-tags">
              <a href="/tags/k8s/" rel="tag"># k8s</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/06/07/k8s-pkg-manager/" rel="prev" title="k8s_pkg_manager">
                  <i class="fa fa-chevron-left"></i> k8s_pkg_manager
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2021/06/08/k8s-network-cni/" rel="next" title="k8s_network_cni">
                  k8s_network_cni <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments utterances-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2018 – 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Cyun All rights reserved</span>
</div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.0/search.js" integrity="sha256-vXZMYLEqsROAXkEw93GGIvaB2ab+QW6w3+1ahD9nXXA=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>



  <script src="/js/third-party/fancybox.js"></script>

  <script src="/js/third-party/pace.js"></script>

  




<script class="next-config" data-name="utterances" type="application/json">{"enable":true,"repo":"jason-bj/blog","issue_term":"pathname","theme":"github-light"}</script>
<script src="/js/third-party/comments/utterances.js"></script>

</body>
</html>
